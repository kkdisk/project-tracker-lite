<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Tracker v7.6.0</title>
    <!-- GAS Hosted Config Injection -->
    <? if (typeof ScriptApp !== 'undefined') { ?>
    <script>
        window.GAS_API_URL = "<?= ScriptApp.getService().getUrl() ?>";
    </script>
    <? } ?>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            safelist: [
                'bg-rose-50', 'bg-rose-50/50', 'border-rose-500', 'bg-rose-100', 'text-rose-700',
                'bg-red-50', 'hover:bg-red-50/30', 'border-red-500', 'bg-red-100', 'text-red-700', 'border-red-200',
                'bg-orange-50', 'bg-orange-50/30', 'border-orange-500', 'bg-orange-100', 'text-orange-700', 'border-orange-200',
                'bg-yellow-100', 'text-yellow-700', 'border-yellow-200',
                'border-l-4'
            ]
        }
    </script>

    <!-- React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

    <!-- Prop Types -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>

    <!-- Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>

    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- js-yaml for YAML parsing (WBS Phase 3) -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

    <!-- marked for Markdown parsing (WBS Phase 3) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Data Converter - å¼·åˆ¶é‡æ–°è¼‰å…¥ä¿®å¾©å¾Œçš„ç‰ˆæœ¬ -->
    <script>
/**
 * UnifiedTaskManager Excel æ ¼å¼è½‰æ›å™¨
 * å°‡ Excel è³‡æ–™æ ¼å¼è½‰æ›ç‚º Project Tracker æ‰€éœ€æ ¼å¼
 * VERSION: 2025-12-11_1300 - æ”¯æ´ Excel åºåˆ—è™Ÿæ—¥æœŸæ ¼å¼
 */

// ç¢ºèªæ­¤ç‰ˆæœ¬å·²è¼‰å…¥
console.log('âœ… data_converter.js å·²è¼‰å…¥ - ç‰ˆæœ¬: 2025-12-11_1300 (æ”¯æ´ Excel æ—¥æœŸåºåˆ—è™Ÿ)');

/**
 * normalizeDate å‡½æ•¸å·²åœ¨ index.html ä¸­å®šç¾©ï¼ˆè¦†å¯«ç‰ˆæœ¬ï¼‰
 * æ­¤è™•ä¸å†å®šç¾©ï¼Œç›´æ¥ä½¿ç”¨å…¨åŸŸç‰ˆæœ¬
 * è©²å‡½æ•¸æ”¯æ´ Excel æ—¥æœŸåºåˆ—è™Ÿå’Œå­—ä¸²æ ¼å¼
 */

/**
 * è¨ˆç®—å…©å€‹æ—¥æœŸä¹‹é–“çš„å¤©æ•¸å·®
 */
function calculateDuration(startDateStr, endDateStr) {
    if (!startDateStr || !endDateStr) return 0;

    try {
        const start = new Date(startDateStr);
        const end = new Date(endDateStr);

        if (isNaN(start.getTime()) || isNaN(end.getTime())) return 0;

        const diffTime = end.getTime() - start.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        return Math.max(0, diffDays); // ç¢ºä¿ä¸ç‚ºè² æ•¸
    } catch (e) {
        console.error('Duration è¨ˆç®—éŒ¯èª¤:', startDateStr, endDateStr, e);
        return 0;
    }
}

/**
 * å°æ‡‰ç‹€æ…‹å€¼
 * UnifiedTaskManager: done, closed, report, in-progress, todo ç­‰
 * Project Tracker: Done, InProgress, Todo
 */
function mapStatus(utmStatus) {
    if (!utmStatus) return 'Todo';

    const status = String(utmStatus).toLowerCase().trim();

    // å®Œæˆç‹€æ…‹
    if (['done', 'closed', 'report', 'completed'].includes(status)) {
        return 'Done';
    }

    // é€²è¡Œä¸­
    if (['in-progress', 'in progress', 'ongoing', 'active'].includes(status)) {
        return 'InProgress';
    }

    // é è¨­ç‚ºå¾…è¾¦
    return 'Todo';
}

/**
 * å°æ‡‰å„ªå…ˆç´š
 * UnifiedTaskManager: p0, p1, p2, p3 ç­‰
 * Project Tracker: High, Medium, Low
 */
function mapPriority(utmPriority) {
    if (!utmPriority) return 'Medium';

    const priority = String(utmPriority).toLowerCase().trim();

    // é«˜å„ªå…ˆç´š
    if (['p0', 'p1', 'high', 'critical', 'urgent'].includes(priority)) {
        return 'High';
    }

    // ä½å„ªå…ˆç´š
    if (['p3', 'p4', 'low'].includes(priority)) {
        return 'Low';
    }

    // é è¨­ä¸­å„ªå…ˆç´š
    return 'Medium';
}

/**
 * æ¬„ä½åç¨±æ˜ å°„è¡¨ - è™•ç†ä¸åŒçš„æ¬„ä½å‘½åæ…£ä¾‹
 */
const FIELD_ALIASES = {
    'ID': ['ID', 'id'],
    'Project': ['Project', 'project'],
    'Team': ['Team', 'team'],
    'Purpose': ['Purpose', 'purpose'],
    'Task': ['Task', 'task'],
    'PIC': ['PIC', 'pic', 'Owner', 'owner'],
    'Issue Date': ['Issue Date', 'Issue date', 'issue date', 'IssueDate'],
    'Start Date': ['Start Date', 'Start date', 'start date', 'StartDate'],
    'End Date': ['End Date', 'end date', 'Due Date', 'Due date', 'due date', 'DueDate'],
    'Status': ['Status', 'status'],
    'Priority': ['Priority', 'priority'],
    'Dependencies': ['Dependencies', 'dependencies', 'Dependency', 'dependency'],
    'Note': ['Note', 'note', 'Notes', 'notes'],
    'Verification': ['Verification', 'verification']
};

/**
 * å–å¾—æ¬„ä½å€¼ - è‡ªå‹•è™•ç†æ¬„ä½åç¨±è®Šé«”
 */
function getFieldValue(row, standardFieldName) {
    const aliases = FIELD_ALIASES[standardFieldName] || [standardFieldName];
    for (const alias of aliases) {
        if (row.hasOwnProperty(alias) && row[alias] !== undefined && row[alias] !== '') {
            return row[alias];
        }
    }
    return undefined;
}

/**
 * åˆ¤æ–·æ˜¯å¦ç‚ºé‡Œç¨‹ç¢‘
 * è¦å‰‡ï¼šå„ªå…ˆç´šç‚º p0/p1 æˆ–ä»»å‹™åç¨±åŒ…å«ç‰¹å®šé—œéµå­—
 */
function isCheckpoint(row) {
    const priority = String(getFieldValue(row, 'Priority') || '').toLowerCase();
    const task = String(getFieldValue(row, 'Task') || '').toLowerCase();
    const purpose = String(getFieldValue(row, 'Purpose') || '').toLowerCase();

    // P0/P1 è¦–ç‚ºé‡Œç¨‹ç¢‘
    if (['p0', 'p1'].includes(priority)) return true;

    // åŒ…å«é‡Œç¨‹ç¢‘é—œéµå­—
    const checkpointKeywords = ['milestone', 'é‡Œç¨‹ç¢‘', 'checkpoint', 'release', 'ç™¼å¸ƒ', 'review', 'å¯©æŸ¥'];
    return checkpointKeywords.some(keyword =>
        task.includes(keyword) || purpose.includes(keyword)
    );
}

/**
 * é©—è­‰å–®ç­†è³‡æ–™çš„å¿…å¡«æ¬„ä½
 */
function validateRow(row, rowIndex) {
    const errors = [];

    const id = getFieldValue(row, 'ID');
    const task = getFieldValue(row, 'Task');

    if (!id) {
        errors.push(`ç¬¬ ${rowIndex + 1} åˆ—ï¼šç¼ºå°‘ ID`);
    }

    if (!task) {
        errors.push(`ç¬¬ ${rowIndex + 1} åˆ— (ID: ${id})ï¼šç¼ºå°‘ Task`);
    }

    // End Date æ”¹ç‚ºé¸å¡« - å…è¨± TBD æˆ–æœªå®šç¾©æˆªæ­¢æ—¥æœŸçš„ä»»å‹™

    return errors;
}

/**
 * ä¸»è¦è½‰æ›å‡½æ•¸
 * å°‡ UnifiedTaskManager Excel è³‡æ–™è½‰æ›ç‚º Project Tracker æ ¼å¼
 * 
 * @param {Array} utmData - Excel è§£æå¾Œçš„ JSON è³‡æ–™
 * @returns {Object} { success: boolean, data: Array, errors: Array }
 */
function convertUTMToTracker(utmData) {
    if (!Array.isArray(utmData)) {
        return {
            success: false,
            data: [],
            errors: ['è¼¸å…¥è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼šå¿…é ˆæ˜¯é™£åˆ—']
        };
    }

    const convertedData = [];
    const allErrors = [];

    utmData.forEach((row, index) => {
        // é©—è­‰å¿…å¡«æ¬„ä½
        const validationErrors = validateRow(row, index);
        if (validationErrors.length > 0) {
            allErrors.push(...validationErrors);
            return; // è·³éç„¡æ•ˆè³‡æ–™åˆ—
        }

        try {
            // ä½¿ç”¨ getFieldValue å–å¾—æ¬„ä½å€¼,æ”¯æ´å¤šç¨®åç¨±æ ¼å¼
            // å¼·åˆ¶ä½¿ç”¨å…¨åŸŸç‰ˆæœ¬çš„ normalizeDateï¼ˆæ”¯æ´ Excel åºåˆ—è™Ÿï¼‰
            const rawEndDate = getFieldValue(row, 'End Date');
            const rawStartDate = getFieldValue(row, 'Start Date');

            const endDate = window.normalizeDate(rawEndDate);
            const startDate = window.normalizeDate(rawStartDate);

            // å¦‚æœæ²’æœ‰ endDate å’Œ startDate,ä½¿ç”¨ç©ºå­—ä¸²(å…è¨± TBD ä»»å‹™)
            const finalEndDate = endDate || '';
            const finalStartDate = startDate || endDate || '';

            const duration = (finalStartDate && finalEndDate) ? calculateDuration(finalStartDate, finalEndDate) : 0;

            const convertedRow = {
                // åŸºæœ¬æ¬„ä½å°æ‡‰
                id: Number(getFieldValue(row, 'ID')) || getFieldValue(row, 'ID'),
                team: getFieldValue(row, 'Team') || 'å…¶ä»–', // Excel çš„ Team æ¬„ä½ç›´æ¥æ˜ å°„åˆ° team
                category: getFieldValue(row, 'Category') || 'Unassigned',
                task: getFieldValue(row, 'Task') || '',
                owner: getFieldValue(row, 'PIC') || 'Unassigned',
                date: finalEndDate,
                status: mapStatus(getFieldValue(row, 'Status')),
                priority: mapPriority(getFieldValue(row, 'Priority')),
                duration: duration,
                isCheckpoint: isCheckpoint(row),
                dependency: getFieldValue(row, 'Dependencies') || '',
                notes: getFieldValue(row, 'Note') || '',

                // æ“´å……æ¬„ä½ï¼ˆä¿ç•™ UnifiedTaskManager ç‰¹æœ‰è³‡æ–™ï¼‰
                verification: getFieldValue(row, 'Verification') || '',
                issueDate: window.normalizeDate(getFieldValue(row, 'Issue Date')) || '',
                purpose: getFieldValue(row, 'Purpose') || '',
                startDate: finalStartDate
            };

            convertedData.push(convertedRow);

        } catch (error) {
            allErrors.push(`ç¬¬ ${index + 1} åˆ— (ID: ${getFieldValue(row, 'ID')})ï¼šè½‰æ›å¤±æ•— - ${error.message}`);
        }
    });

    return {
        success: allErrors.length === 0,
        data: convertedData,
        errors: allErrors,
        stats: {
            total: utmData.length,
            converted: convertedData.length,
            failed: utmData.length - convertedData.length
        }
    };
}

/**
 * åå‘è½‰æ›ï¼šProject Tracker æ ¼å¼è½‰å› UnifiedTaskManager æ ¼å¼
 * ç”¨æ–¼åŒ¯å‡º Excel æ™‚ä½¿ç”¨
 */
function convertTrackerToUTM(trackerData) {
    return trackerData.map(row => ({
        'ID': row.id,
        'Project': row.project,
        'Team': row.category,
        'Purpose': row.purpose || '',
        'Task': row.task,
        'PIC': row.owner,
        'Issue Date': row.issueDate || '',
        'Start Date': row.startDate || '',
        'End Date': row.date,
        'Status': row.status,
        'Priority': row.priority,
        'Dependencies': row.dependency || '',
        'Note': row.notes || '',
        'Verification': row.verification || ''
    }));
}

// å¦‚æœåœ¨ Node.js ç’°å¢ƒä¸­ï¼ŒåŒ¯å‡ºæ¨¡çµ„
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        convertUTMToTracker,
        convertTrackerToUTM,
        normalizeDate,
        calculateDuration,
        mapStatus,
        mapPriority
    };
}

</script>

    <!-- normalizeDate å‡½æ•¸å·²çµ±ä¸€å®šç¾©åœ¨ helpers.js (ç¬¬ 77-120 è¡Œ) -->

    <!-- Report Generator for Weekly Reports -->
    <script>
/**
 * Report Generator - æ¯é€±å ±å‘Šç”¢ç”Ÿå™¨
 * åŠŸèƒ½ï¼šåŒ¯å‡º Excel å¿«ç…§ã€æ¯”å°å¿«ç…§ã€ç”¢ç”Ÿå ±å‘Š
 */

// ========================================
// ğŸ“¥ åŒ¯å‡º Excel å¿«ç…§
// ========================================

/**
 * åŒ¯å‡ºç•¶å‰ä»»å‹™æ¸…å–®ç‚º Excel å¿«ç…§
 * @param {Array} tasks - ç•¶å‰ä»»å‹™æ¸…å–®
 * @param {string} filename - æª”æ¡ˆåç¨± (å¯é¸)
 */
const exportSnapshot = (tasks) => {
    if (!tasks || tasks.length === 0) {
        alert('æ²’æœ‰ä»»å‹™å¯åŒ¯å‡º');
        return;
    }

    // æº–å‚™åŒ¯å‡ºè³‡æ–™
    const today = new Date().toISOString().split('T')[0];
    const filename = `TaskSnapshot_${today}.xlsx`;

    // è½‰æ›ç‚ºåŒ¯å‡ºæ ¼å¼
    const exportData = tasks.map(t => ({
        'ID': t.id,
        'Team': t.team || '',
        'Project': t.project || '',
        'Task': t.task || '',
        'Owner': t.owner || '',
        'StartDate': t.startDate || '',
        'DueDate': t.date || '',
        'Duration': t.duration || 0,
        'Status': t.status || 'Todo',
        'Priority': t.priority || 'Medium',
        'Dependency': t.dependency || '',
        'Notes': t.notes || '',
        'IsCheckpoint': t.isCheckpoint ? 'TRUE' : 'FALSE',
        'IssuePool': t.issuePool ? 'TRUE' : 'FALSE',
        '_SnapshotDate': today  // è­˜åˆ¥é€™æ˜¯å¿«ç…§æª”æ¡ˆ
    }));

    // ä½¿ç”¨ XLSX ç”Ÿæˆå·¥ä½œç°¿
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'TaskSnapshot');

    // ä¸‹è¼‰æª”æ¡ˆ
    XLSX.writeFile(wb, filename);

    console.log(`âœ… å¿«ç…§å·²åŒ¯å‡º: ${filename} (${tasks.length} ç­†)`);
};

// ========================================
// ğŸ” æ¯”å°å¿«ç…§
// ========================================

/**
 * æ¯”å°èˆŠå¿«ç…§èˆ‡æ–°è³‡æ–™
 * @param {Array} oldTasks - èˆŠå¿«ç…§ä»»å‹™æ¸…å–®
 * @param {Array} newTasks - ç•¶å‰ä»»å‹™æ¸…å–®
 * @returns {Object} æ¯”å°çµæœ
 */
const compareSnapshots = (oldTasks, newTasks) => {
    const oldMap = new Map(oldTasks.map(t => [String(t.id || t.ID), t]));
    const newMap = new Map(newTasks.map(t => [String(t.id || t.ID), t]));

    const today = new Date().toISOString().split('T')[0];

    const result = {
        snapshotDate: oldTasks[0]?._SnapshotDate || oldTasks[0]?.['_SnapshotDate'] || 'æœªçŸ¥',
        reportDate: today,
        added: [],       // ğŸ†• æ–°å¢
        removed: [],     // ğŸ—‘ï¸ åˆªé™¤
        completed: [],   // âœ… å®Œæˆ
        dateChanged: [], // ğŸ“… æ™‚ç¨‹è®Šæ›´
        statusChanged: [], // ğŸ”„ ç‹€æ…‹è®Šæ›´
        delayed: []      // âš ï¸ å»¶é²
    };

    // æ­£è¦åŒ–å–å€¼å‡½æ•¸
    const getVal = (task, key) => task[key] || task[key.toLowerCase()] || '';
    const getStatus = (task) => getVal(task, 'status') || getVal(task, 'Status') || 'Todo';
    const getDate = (task) => getVal(task, 'date') || getVal(task, 'DueDate') || '';
    const getId = (task) => String(getVal(task, 'id') || getVal(task, 'ID'));

    // æ‰¾æ–°å¢é …ç›® (æ–°è³‡æ–™æœ‰ï¼ŒèˆŠå¿«ç…§ç„¡)
    for (const [id, task] of newMap) {
        if (!oldMap.has(id)) {
            result.added.push(task);
        }
    }

    // æ‰¾åˆªé™¤é …ç›® (èˆŠå¿«ç…§æœ‰ï¼Œæ–°è³‡æ–™ç„¡)
    for (const [id, task] of oldMap) {
        if (!newMap.has(id)) {
            result.removed.push(task);
        }
    }

    // æ‰¾è®Šæ›´é …ç›®
    for (const [id, newTask] of newMap) {
        const oldTask = oldMap.get(id);
        if (!oldTask) continue;

        const oldStatus = getStatus(oldTask);
        const newStatus = getStatus(newTask);
        const oldDate = getDate(oldTask);
        const newDate = getDate(newTask);

        // å®Œæˆ (ä¹‹å‰éå®Œæˆï¼Œç¾åœ¨å®Œæˆ)
        if (!['Done', 'Closed'].includes(oldStatus) && ['Done', 'Closed'].includes(newStatus)) {
            result.completed.push(newTask);
        }
        // ç‹€æ…‹è®Šæ›´ (éå®Œæˆé¡åˆ¥çš„è®Šæ›´)
        else if (oldStatus !== newStatus) {
            result.statusChanged.push({
                task: newTask,
                oldStatus: oldStatus,
                newStatus: newStatus
            });
        }

        // æ™‚ç¨‹è®Šæ›´
        if (oldDate !== newDate) {
            result.dateChanged.push({
                task: newTask,
                oldDate: oldDate,
                newDate: newDate
            });
        }
    }

    // æ‰¾å»¶é²é …ç›® (Due Date å·²éä¸”æœªå®Œæˆ)
    for (const task of newTasks) {
        const dueDate = getDate(task);
        const status = getStatus(task);

        if (dueDate && dueDate < today && !['Done', 'Closed'].includes(status)) {
            result.delayed.push(task);
        }
    }

    console.log('ğŸ“Š æ¯”å°çµæœ:', result);
    return result;
};

// ========================================
// ğŸ“ ç”¢ç”Ÿå ±å‘Š
// ========================================

/**
 * å°‡æ¯”å°çµæœæ ¼å¼åŒ–ç‚ºå ±å‘Š
 * @param {Object} diff - æ¯”å°çµæœ
 * @returns {string} Markdown æ ¼å¼å ±å‘Š
 */
const generateReportMarkdown = (diff) => {
    const lines = [];

    lines.push(`# æ¯é€±ä»»å‹™å ±å‘Š`);
    lines.push(`> å¿«ç…§æ—¥æœŸ: ${diff.snapshotDate} | å ±å‘Šæ—¥æœŸ: ${diff.reportDate}`);
    lines.push('');

    // çµ±è¨ˆæ‘˜è¦
    lines.push('## ğŸ“Š æ‘˜è¦');
    lines.push(`| é¡åˆ¥ | æ•¸é‡ |`);
    lines.push(`|---|---|`);
    lines.push(`| ğŸ†• æ–°å¢ | ${diff.added.length} |`);
    lines.push(`| ğŸ—‘ï¸ åˆªé™¤ | ${diff.removed.length} |`);
    lines.push(`| âœ… å®Œæˆ | ${diff.completed.length} |`);
    lines.push(`| ğŸ“… æ™‚ç¨‹è®Šæ›´ | ${diff.dateChanged.length} |`);
    lines.push(`| ğŸ”„ ç‹€æ…‹è®Šæ›´ | ${diff.statusChanged.length} |`);
    lines.push(`| âš ï¸ å»¶é² | ${diff.delayed.length} |`);
    lines.push('');

    // è©³ç´°åˆ—è¡¨
    if (diff.added.length > 0) {
        lines.push('## ğŸ†• æœ¬é€±æ–°å¢');
        lines.push('| ID | ä»»å‹™ | è² è²¬äºº | Due Date |');
        lines.push('|---|---|---|---|');
        diff.added.forEach(t => {
            lines.push(`| ${t.id || t.ID} | ${t.task || t.Task} | ${t.owner || t.Owner} | ${t.date || t.DueDate} |`);
        });
        lines.push('');
    }

    if (diff.completed.length > 0) {
        lines.push('## âœ… æœ¬é€±å®Œæˆ');
        lines.push('| ID | ä»»å‹™ | è² è²¬äºº |');
        lines.push('|---|---|---|');
        diff.completed.forEach(t => {
            lines.push(`| ${t.id || t.ID} | ${t.task || t.Task} | ${t.owner || t.Owner} |`);
        });
        lines.push('');
    }

    if (diff.dateChanged.length > 0) {
        lines.push('## ğŸ“… æ™‚ç¨‹è®Šæ›´');
        lines.push('| ID | ä»»å‹™ | åŸå®š | æ–°æ—¥æœŸ |');
        lines.push('|---|---|---|---|');
        diff.dateChanged.forEach(d => {
            const t = d.task;
            lines.push(`| ${t.id || t.ID} | ${t.task || t.Task} | ${d.oldDate} | ${d.newDate} |`);
        });
        lines.push('');
    }

    if (diff.statusChanged.length > 0) {
        lines.push('## ğŸ”„ ç‹€æ…‹è®Šæ›´');
        lines.push('| ID | ä»»å‹™ | åŸç‹€æ…‹ | æ–°ç‹€æ…‹ |');
        lines.push('|---|---|---|---|');
        diff.statusChanged.forEach(d => {
            const t = d.task;
            lines.push(`| ${t.id || t.ID} | ${t.task || t.Task} | ${d.oldStatus} | ${d.newStatus} |`);
        });
        lines.push('');
    }

    if (diff.delayed.length > 0) {
        lines.push('## âš ï¸ å»¶é²é …ç›®');
        lines.push('| ID | ä»»å‹™ | è² è²¬äºº | åŸå®š Due | å»¶é²å¤©æ•¸ |');
        lines.push('|---|---|---|---|---|');
        const today = new Date();
        diff.delayed.forEach(t => {
            const dueDate = new Date(t.date || t.DueDate);
            const delayDays = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
            lines.push(`| ${t.id || t.ID} | ${t.task || t.Task} | ${t.owner || t.Owner} | ${t.date || t.DueDate} | ${delayDays} å¤© |`);
        });
        lines.push('');
    }

    if (diff.removed.length > 0) {
        lines.push('## ğŸ—‘ï¸ å·²åˆªé™¤');
        lines.push('| ID | ä»»å‹™ |');
        lines.push('|---|---|');
        diff.removed.forEach(t => {
            lines.push(`| ${t.id || t.ID} | ${t.task || t.Task} |`);
        });
        lines.push('');
    }

    return lines.join('\n');
};

/**
 * æª¢æŸ¥ä¸Šå‚³çš„ Excel æ˜¯å¦ç‚ºå¿«ç…§æª”æ¡ˆ
 * @param {Array} data - è§£æå¾Œçš„è³‡æ–™
 * @returns {boolean}
 */
const isSnapshotFile = (data) => {
    if (!data || data.length === 0) return false;
    const firstRow = data[0];
    return firstRow.hasOwnProperty('_SnapshotDate') || firstRow.hasOwnProperty('_SnapshotDate');
};

// ========================================
// ğŸŒ Global Export
// ========================================

window.exportSnapshot = exportSnapshot;
window.compareSnapshots = compareSnapshots;
window.generateReportMarkdown = generateReportMarkdown;
window.isSnapshotFile = isSnapshotFile;

</script>

    <style>
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        /* Tooltip Styles */
        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: help;
        }

        .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #334155;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 50;
            bottom: 135%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.75rem;
            line-height: 1.5;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            pointer-events: none;
            word-wrap: break-word;
            white-space: normal;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Tooltip arrow */
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #334155 transparent transparent transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Gantt Chart Styles */
        .gantt-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .gantt-header-row {
            flex: 0 0 auto;
            overflow: hidden;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            z-index: 50;
        }

        .gantt-header-wrapper {
            display: flex;
        }

        .gantt-header-task {
            flex: 0 0 200px;
            min-width: 200px;
            padding: 0 12px;
            font-weight: 600;
            font-size: 0.875rem;
            color: #475569;
            border-right: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            align-items: center;
            position: sticky;
            left: 0;
            z-index: 40;
            box-shadow: 1px 0 0 #e2e8f0;
        }

        .gantt-header-timeline {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .gantt-header-month-row {
            display: flex;
            height: 30px;
            border-bottom: 1px solid #e2e8f0;
        }

        .gantt-month-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: #475569;
            border-right: 1px solid #e2e8f0;
            background: #f1f5f9;
        }

        .gantt-header-day-row {
            display: flex;
            height: 30px;
        }

        .gantt-day-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #64748b;
            border-right: 1px solid #f1f5f9;
            background: #fff;
        }

        .gantt-day-cell.is-weekend {
            background-color: #f8fafc;
            color: #94a3b8;
        }

        .gantt-body {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .gantt-body-content {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .gantt-grid-lines {
            position: absolute;
            top: 0;
            left: 200px;
            right: 0;
            bottom: 0;
            display: flex;
            pointer-events: none;
            z-index: 0;
        }

        .gantt-grid-col {
            height: 100%;
            border-right: 1px solid #f1f5f9;
            box-sizing: border-box;
        }

        .gantt-row {
            display: flex;
            height: 40px;
            border-bottom: 1px solid #f1f5f9;
            position: relative;
            z-index: 5;
        }

        .gantt-row:hover {
            background-color: #f8fafc;
        }

        .gantt-task-col {
            flex: 0 0 200px;
            min-width: 200px;
            padding: 0 12px;
            font-size: 0.875rem;
            color: #334155;
            border-right: 1px solid #e2e8f0;
            background: #fff;
            display: flex;
            align-items: center;
            position: sticky;
            left: 0;
            z-index: 35;
            box-shadow: 1px 0 0 #e2e8f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .gantt-timeline-col {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .gantt-bar {
            position: absolute;
            top: 8px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 6px;
            color: white;
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .gantt-bar:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 25;
            filter: brightness(1.05);
        }

        .today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #ef4444;
            z-index: 25;
            pointer-events: none;
            box-shadow: 0 0 4px rgba(239, 68, 68, 0.4);
        }

        .today-line::after {
            content: 'Today';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444;
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 0 0 4px 4px;
            white-space: nowrap;
        }

        .dependency-svg {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 10;
        }

        /* Loading Spinner */
        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Animations */
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.2s ease-out forwards;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
/**
 * Google Apps Script API Wrapper
 * å°è£ google.script.run ç‚º Promise å½¢å¼ï¼Œæ–¹ä¾¿ React Hooks ä½¿ç”¨ (async/await)
 */

const callApi = (action, payload = {}) => {
    return new Promise((resolve, reject) => {
        // 1. æª¢æŸ¥æ˜¯å¦åœ¨ GAS ç’°å¢ƒ
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            console.log(`ğŸ“¡ [GAS] å‘¼å« API: ${action}`, payload);
            google.script.run
                .withSuccessHandler((response) => {
                    // ğŸ” Debug: è¨˜éŒ„åŸå§‹å›æ‡‰
                    console.log(`ğŸ“¡ [GAS] ${action} åŸå§‹å›æ‡‰é¡å‹:`, typeof response);
                    console.log(`ğŸ“¡ [GAS] ${action} åŸå§‹å›æ‡‰:`, response);

                    // è‹¥å¾Œç«¯å›å‚³çš„æ˜¯ JSON å­—ä¸² (ç‚ºäº†å…¼å®¹ doGet)ï¼Œå˜—è©¦è§£æ
                    if (typeof response === 'string') {
                        console.log(`ğŸ“¡ [GAS] ${action} æ˜¯å­—ä¸²ï¼Œå˜—è©¦è§£æ JSON...`);
                        try {
                            const json = JSON.parse(response);
                            console.log(`ğŸ“¡ [GAS] ${action} è§£æå¾Œ:`, json);
                            resolve(json);
                        } catch (e) {
                            // è‹¥ä¸æ˜¯ JSONï¼Œç›´æ¥å›å‚³
                            console.log(`ğŸ“¡ [GAS] ${action} ä¸æ˜¯ JSONï¼Œç›´æ¥å›å‚³å­—ä¸²`);
                            resolve(response);
                        }
                    } else {
                        console.log(`ğŸ“¡ [GAS] ${action} ç›´æ¥å›å‚³ç‰©ä»¶`);
                        resolve(response);
                    }
                })
                .withFailureHandler((error) => {
                    console.error(`âŒ [GAS] API éŒ¯èª¤:`, error);
                    reject(error);
                })
                .apiDispatcher(action, payload); // å‘¼å«å¾Œç«¯å–®ä¸€å…¥å£å‡½æ•¸
        } else {
            // 2. æœ¬åœ°é–‹ç™¼æ¨¡å¼ (Local Dev Fallback) -> ä½¿ç”¨ fetch
            // å¾ config.js ç²å– API_URL (æœ¬åœ°é–‹ç™¼æ™‚ config.js æœƒå®šç¾©é è¨­ URL)
            // æ³¨æ„: æœ¬åœ°é–‹ç™¼ç„¡æ³•æ¸¬è©¦ google.script.runï¼Œå¿…é ˆä¾è³´ Web App URL çš„ doGet/doPost
            console.warn(`âš ï¸ [Local] é GAS ç’°å¢ƒï¼Œå˜—è©¦ä½¿ç”¨ fetch: ${action}`);

            // æ§‹å»ºè«‹æ±‚
            // å¦‚æœåªæœ‰ action ä¸”ç„¡ payloadï¼Œè¦–ç‚º GET
            // ä½†ç‚ºäº†çµ±ä¸€ï¼Œå»ºè­°å¾Œç«¯ apiDispatcher æ¥æ”¶ç‰©ä»¶
            // é€™è£¡æ¨¡æ“¬ POST è¡Œç‚ºå› ç‚º Apps Script "run" é¡ä¼¼ RPC

            // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæœ¬åœ°æ¸¬è©¦æ™‚æˆ‘å€‘å‡è¨­ API_URL æŒ‡å‘æ¸¬è©¦éƒ¨ç½²
            if (typeof API_URL === 'undefined') {
                reject(new Error('Local Dev Error: API_URL not defined'));
                return;
            }

            // æœ¬åœ°ç„¡æ³•å®Œç¾æ¨¡æ“¬ Session Authï¼Œé™¤é target URL æ˜¯ "Anyone" access
            // é€™è£¡åƒ…ä½œç°¡å–®æ¨¡æ“¬
            const url = `${API_URL}?action=${action}`;

            // GET æ¨¡æ“¬ (å¦‚æœ payload ç©º)
            let fetchOptions = {
                method: 'POST',
                body: JSON.stringify({ action, data: payload }) // æ¨¡æ“¬ doPost çµæ§‹
            };

            // ä½¿ç”¨ POST å‚³é€ (fetch åˆ° Apps Script Web App url)
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action, data: payload }),
                headers: { "Content-Type": "text/plain;charset=utf-8" }, // GAS ä¸æ”¯æ´ application/json
            })
                .then(res => res.json())
                .then(data => resolve(data))
                .catch(err => reject(err));
        }
    });
};

// åŒ¯å‡ºåˆ°å…¨åŸŸ (å› ç‚ºæ²’æœ‰æ¨¡çµ„ç³»çµ±)
window.callApi = callApi;

</script>
    <script src="js/config.js"></script>
    <script type="text/babel">
/**
 * Icons å®šç¾©
 * icons.js
 */

const Icon = ({ path, size = 18, color = "currentColor", onClick, className = "" }) => (
    <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={{ cursor: onClick ? 'pointer' : 'default' }}>
        {path}
    </svg>
);

const paths = {
    flag: <React.Fragment><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" /><line x1="4" y1="22" x2="4" y2="15" /></React.Fragment>,
    clock: <React.Fragment><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></React.Fragment>,
    calendar: <React.Fragment><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></React.Fragment>,
    list: <React.Fragment><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></React.Fragment>,
    plus: <React.Fragment><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></React.Fragment>,
    trash: <React.Fragment><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></React.Fragment>,
    edit: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />,
    x: <React.Fragment><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></React.Fragment>,
    alert: <React.Fragment><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></React.Fragment>,
    check: <React.Fragment><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></React.Fragment>,
    timer: <React.Fragment><line x1="10" y1="2" x2="14" y2="2" /><line x1="12" y1="14" x2="15" y2="11" /><circle cx="12" cy="14" r="8" /></React.Fragment>,
    left: <polyline points="15 18 9 12 15 6" />,
    right: <polyline points="9 18 15 12 9 6" />,
    file: <React.Fragment><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></React.Fragment>,
    link: <React.Fragment><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></React.Fragment>,
    gantt: <React.Fragment><path d="M12 2v20" /><path d="M2 6h20" /><path d="M6 10h8" /><path d="M4 14h12" /><path d="M8 18h10" /></React.Fragment>,
    settings: <React.Fragment><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></React.Fragment>,
    search: <React.Fragment><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></React.Fragment>
};

window.Icon = Icon;
window.paths = paths;

</script>
    <script type="text/babel">
/**
 * Helper Functions
 * è¼”åŠ©å‡½æ•¸é›†åˆ
 */

// å–å¾— Team é¡è‰²
const getTeamColor = (team) => {
    const colors = {
        'æ™¶ç‰‡': '#3b82f6',      // blue
        'æ©Ÿæ§‹': '#8b5cf6',      // purple
        'è»Ÿé«”': '#10b981',      // emerald
        'é›»æ§': '#f59e0b',      // amber
        'æµé“': '#06b6d4',      // cyan
        'ç”Ÿé†«': '#ec4899',      // pink
        'QA': '#6366f1',        // indigo
        'ç®¡ç†': '#84cc16',      // lime
        'issue': '#ef4444'      // red
    };
    return colors[team] || '#64748b'; // slate as default
};

// å–å¾—å°ˆæ¡ˆé¡è‰²
const getProjectColor = (project) => {
    const colorMap = {
        'CKSX': 'bg-blue-100 text-blue-700 border-blue-200',
        'Jamstec': 'bg-purple-100 text-purple-700 border-purple-200',
        'Genentech': 'bg-emerald-100 text-emerald-700 border-emerald-200',
        '5880 Chip': 'bg-amber-100 text-amber-700 border-amber-200',
        'Internal': 'bg-cyan-100 text-cyan-700 border-cyan-200',
        'TBD': 'bg-slate-100 text-slate-600 border-slate-200',
        'Other': 'bg-pink-100 text-pink-700 border-pink-200'
    };
    return colorMap[project] || 'bg-slate-100 text-slate-600 border-slate-200';
};
const getTeamBadgeClass = (team) => {
    const classes = {
        'æ™¶ç‰‡': 'text-blue-600 border-blue-200 bg-blue-50',
        'æ©Ÿæ§‹': 'text-purple-600 border-purple-200 bg-purple-50',
        'è»Ÿé«”': 'text-emerald-600 border-emerald-200 bg-emerald-50',
        'é›»æ§': 'text-amber-600 border-amber-200 bg-amber-50',
        'æµé“': 'text-cyan-600 border-cyan-200 bg-cyan-50',
        'ç”Ÿé†«': 'text-pink-600 border-pink-200 bg-pink-50',
        'QA': 'text-indigo-600 border-indigo-200 bg-indigo-50',
        'ç®¡ç†': 'text-lime-600 border-lime-200 bg-lime-50',
        'issue': 'text-red-600 border-red-200 bg-red-50'
    };
    return classes[team] || 'text-slate-600 border-slate-200 bg-slate-50';
};

// å–å¾—å„ªå…ˆç´šå¾½ç« 
const getPriorityBadge = (priority) => {
    switch (priority) {
        case 'High':
            return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-700 border border-red-200">ğŸ”´ ç·Šæ€¥</span>;
        case 'Medium':
            return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700 border border-yellow-200">ğŸŸ¡ ä¸€èˆ¬</span>;
        case 'Low':
            return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200">ğŸŸ¢ ä½</span>;
        default:
            return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-slate-100 text-slate-600">{priority || 'æœªè¨­å®š'}</span>;
    }
};

// ========================================
// ğŸ“‹ Task ID é¡¯ç¤ºå‡½æ•¸
// ========================================

// å–å¾—ç¸®çŸ­ç‰ˆ Task ID
const getShortTaskId = (taskId) => {
    if (!taskId) return '';
    const id = String(taskId);

    // æ–°æ ¼å¼: SOFT-2025-12-0003 â†’ #SOFT-12-0003 (çœç•¥å¹´ä»½)
    const newFormatMatch = id.match(/^([A-Z]+)-\d{4}-(\d{2})-(\d+)$/);
    if (newFormatMatch) {
        return `#${newFormatMatch[1]}-${newFormatMatch[2]}-${newFormatMatch[3]}`;
    }

    // YAML æ ¼å¼: 016_vacuum_pump_control_M3 â†’ #016
    const yamlFormatMatch = id.match(/^(\d{3})_/);
    if (yamlFormatMatch) {
        return `#${yamlFormatMatch[1]}`;
    }

    // ç´”æ•¸å­—ï¼ˆèˆŠæ ¼å¼æ™‚é–“æˆ³ï¼‰â†’ é¡¯ç¤ºå¾Œ 6 ä½
    if (/^\d+$/.test(id) && id.length > 6) {
        return `#...${id.slice(-6)}`;
    }

    // å…¶ä»–: æˆªæ–·åˆ° 10 å­—å…ƒ
    if (id.length > 10) {
        return `#${id.substring(0, 10)}...`;
    }

    return `#${id}`;
};

// å–å¾— Task ID å¾½ç«  (ç¸®çŸ­é¡¯ç¤º + Tooltip)
const getTaskIdBadge = (taskId) => {
    const shortId = getShortTaskId(taskId);
    const fullId = `#${taskId}`;

    return (
        <span
            className="font-mono text-xs text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded cursor-default hover:bg-slate-200 transition-colors"
            title={fullId}
        >
            {shortId}
        </span>
    );
};


// ========================================
// ğŸ“… æ—¥æœŸæ­£è¦åŒ–å‡½å¼ (æ”¯æ´ Excel åºåˆ—è™Ÿ + ISO å­—ä¸²)
// ========================================
const normalizeDate = (dateInput) => {
    if (!dateInput && dateInput !== 0) return '';

    // å·²ç¶“æ˜¯ YYYY-MM-DD æ ¼å¼
    if (typeof dateInput === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
        return dateInput;
    }

    try {
        let date;

        // è™•ç† Excel æ—¥æœŸåºåˆ—è™Ÿï¼ˆæ•¸å­—é¡å‹ï¼‰
        if (typeof dateInput === 'number') {
            // Excel çš„æ—¥æœŸåºåˆ—è™ŸåŸºæº–æ˜¯ 1900-01-01 (å¯¦éš›ä¸Šæ˜¯ 1899-12-30)
            const excelEpoch = new Date(1899, 11, 30);
            const milliseconds = dateInput * 86400000;
            date = new Date(excelEpoch.getTime() + milliseconds);
        } else if (typeof dateInput === 'string') {
            // è™•ç† ISO å­—ä¸²ï¼ˆGoogle Sheetsï¼‰æˆ–å…¶ä»–æ—¥æœŸå­—ä¸²
            date = new Date(dateInput);

            // å¦‚æœæ˜¯ ISO å­—ä¸²æ ¼å¼ï¼ˆå«æ™‚å€ï¼‰ï¼Œèª¿æ•´ç‚ºç•¶åœ°æ—¥æœŸ
            if (/^\d{4}-\d{2}-\d{2}T/.test(dateInput)) {
                const utcDate = new Date(dateInput);
                date = new Date(utcDate.getUTCFullYear(), utcDate.getUTCMonth(), utcDate.getUTCDate());
            }
        } else {
            // å…¶ä»–é¡å‹å˜—è©¦ç›´æ¥è§£æ
            date = new Date(dateInput);
        }

        if (isNaN(date.getTime())) {
            return '';
        }

        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    } catch (e) {
        console.error('[normalizeDate] éŒ¯èª¤:', dateInput, e);
        return '';
    }
};

// å–å¾—å°ç£ç•¶å¤©æ—¥æœŸ
const getTaiwanToday = () => new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });

// è¨ˆç®—é–‹å§‹æ—¥æœŸ
const getStartDate = (endDateStr, duration) => {
    if (!duration || !endDateStr) return '';
    try {
        const end = new Date(endDateStr);
        const start = new Date(end);
        start.setDate(end.getDate() - duration);
        return start.toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });
    } catch (e) { return ''; }
};

// è§£æç›¸ä¾æ€§å­—ä¸²ç‚ºé™£åˆ—
const parseDependencies = (depStr) => {
    if (!depStr || typeof depStr !== 'string') return [];
    return depStr.split(',').map(id => id.trim()).filter(id => id);
};

// é©—è­‰ç›¸ä¾æ€§æ ¼å¼èˆ‡æœ‰æ•ˆæ€§
const validateDependencies = (depStr, currentTaskId, allTasks) => {
    const errors = [];
    if (!depStr || !depStr.trim()) return errors;

    const depIds = parseDependencies(depStr);

    // é™åˆ¶æœ€å¤§ç›¸ä¾æ•¸é‡
    if (depIds.length > 10) {
        errors.push('âš ï¸ ç›¸ä¾æ€§æ•¸é‡ä¸å¯è¶…é 10 å€‹');
        return errors;
    }

    for (const depId of depIds) {
        // æ–°ç‰ˆ Task ID æ ¼å¼: DEPT-YEAR-MONTH-SEQ (ä¾‹å¦‚: CHIP-2025-12-0005)
        // èˆŠç‰ˆ Task ID æ ¼å¼: ç´”æ•¸å­— (ä¾‹å¦‚: 12345)
        // YAML åŒ¯å…¥æ ¼å¼: å°ˆæ¡ˆä»£ç¢¼_ä»»å‹™ID (ä¾‹å¦‚: 016_vacuum_pump_control_task_sys_arch_design)
        const newIdPattern = /^[A-Z]{2,4}-\d{4}-\d{2}-\d{4}$/;
        const legacyIdPattern = /^\d+$/;
        const yamlIdPattern = /^\d{3}_[a-zA-Z0-9_]+$/;  // å¦‚ 016_vacuum_pump_control_task_xxx

        if (!newIdPattern.test(depId) && !legacyIdPattern.test(depId) && !yamlIdPattern.test(depId)) {
            errors.push(`âŒ ç›¸ä¾æ€§ ID "${depId}" æ ¼å¼ä¸æ­£ç¢ºï¼ˆæ‡‰ç‚º DEPT-YEAR-MM-NNNNã€ç´”æ•¸å­—æˆ– YAML æ ¼å¼ï¼‰`);
            continue;
        }

        // æª¢æŸ¥æ˜¯å¦ç›¸ä¾è‡ªå·±
        if (String(depId) === String(currentTaskId)) {
            errors.push(`âŒ ä»»å‹™ä¸èƒ½ç›¸ä¾è‡ªå·± (ID: ${depId})`);
            continue;
        }

        // æª¢æŸ¥ç›¸ä¾çš„ä»»å‹™æ˜¯å¦å­˜åœ¨
        const depTask = allTasks.find(t => String(t.id) === String(depId));
        if (!depTask) {
            errors.push(`âš ï¸ æ‰¾ä¸åˆ°ç›¸ä¾ä»»å‹™ ID: ${depId}`);
        }
    }

    return errors;
};

// é©—è­‰ä»»å‹™
const validateTask = (task) => {
    const errors = [];

    // ä»»å‹™åç¨±é©—è­‰
    if (!task.task?.trim()) {
        errors.push('âŒ ä»»å‹™åç¨±ä¸èƒ½ç‚ºç©º');
    } else if (task.task.length > 100) {
        errors.push('âŒ ä»»å‹™åç¨±ä¸èƒ½è¶…é100å­—å…ƒ');
    }

    // æ—¥æœŸé©—è­‰
    // å‡è¨­ normalizeDate æ˜¯å…¨åŸŸå‡½æ•¸ï¼Œå¦‚æœä¸æ˜¯ï¼Œéœ€è¦åœ¨æ­¤æª”æ¡ˆå®šç¾©æˆ–å‚³å…¥
    // index.html å®šç¾©äº† window.normalizeDateï¼Œæ‰€ä»¥é€™è£¡æ˜¯å¯ç”¨çš„
    const normalizedDate = typeof window !== 'undefined' && window.normalizeDate ? window.normalizeDate(task.date) : task.date;

    if (!task.date || !normalizedDate) {
        errors.push('âŒ å®Œæˆæ—¥æœŸæ ¼å¼ä¸æ­£ç¢º');
    } else {
        const taskDate = new Date(normalizedDate);
        const startDate = new Date(getStartDate(normalizedDate, task.duration));

        if (startDate > taskDate) {
            errors.push('âš ï¸ é–‹å§‹æ—¥æœŸæ™šæ–¼å®Œæˆæ—¥æœŸï¼Œè«‹ç¢ºèªå·¥æ™‚è¨­å®š');
        }

        // æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨åˆç†ç¯„åœå…§ï¼ˆéå»5å¹´åˆ°æœªä¾†5å¹´ï¼‰
        const fiveYearsAgo = new Date();
        fiveYearsAgo.setFullYear(fiveYearsAgo.getFullYear() - 5);
        const fiveYearsLater = new Date();
        fiveYearsLater.setFullYear(fiveYearsLater.getFullYear() + 5);

        if (taskDate < fiveYearsAgo || taskDate > fiveYearsLater) {
            errors.push('âš ï¸ æ—¥æœŸè¶…å‡ºåˆç†ç¯„åœï¼ˆ5å¹´å…§ï¼‰');
        }
    }

    // å·¥æ™‚é©—è­‰
    if (task.duration < 0) {
        errors.push('âŒ å·¥æ™‚ä¸èƒ½ç‚ºè² æ•¸');
    } else if (task.duration > 365) {
        errors.push('âš ï¸ å·¥æ™‚è¶…é365å¤©ï¼Œè«‹ç¢ºèªæ˜¯å¦æ­£ç¢º');
    }

    // è² è²¬äººé©—è­‰
    if (!task.owner?.trim()) {
        errors.push('âŒ è² è²¬äººä¸èƒ½ç‚ºç©º');
    }

    return errors;
};

// å¾ªç’°ç›¸ä¾æ€§æª¢æŸ¥
const detectCircularDependency = (taskId, dependencyStr, currentTasks) => {
    const depIds = parseDependencies(dependencyStr);
    if (depIds.length === 0) return false;

    // ä½¿ç”¨ BFS æª¢æŸ¥æ¯å€‹ç›¸ä¾æ€§éˆ
    for (const depId of depIds) {
        const visited = new Set();
        const queue = [depId];
        let depth = 0;

        while (queue.length > 0 && depth < 100) {
            const current = queue.shift();

            // æª¢æŸ¥æ˜¯å¦å½¢æˆå¾ªç’°
            if (String(current) === String(taskId)) return true;

            // é¿å…é‡è¤‡è¨ªå•
            if (visited.has(current)) continue;
            visited.add(current);

            // æ‰¾åˆ°ç•¶å‰ä»»å‹™çš„æ‰€æœ‰ç›¸ä¾æ€§
            const parent = currentTasks.find(t => String(t.id) === String(current));
            if (parent?.dependency) {
                const parentDeps = parseDependencies(parent.dependency);
                queue.push(...parentDeps);
            }

            depth++;
        }
    }
    return false;
};

// å–å¾—ç‹€æ…‹å¾½ç« 
const getStatusBadge = (t, todayStr) => {
    // è‹¥æœªå‚³å…¥ todayStrï¼Œå˜—è©¦ç²å–
    if (!todayStr) todayStr = getTaiwanToday();

    // å¦‚æœæ˜¯ JSXï¼Œå› ç‚º helpers.js æ˜¯ç´” JSï¼Œä¸èƒ½ç›´æ¥å¯« JSXï¼Œé™¤éä½¿ç”¨ Babel ç·¨è­¯
    // é€™è£¡æˆ‘å€‘å‡è¨­ä½¿ç”¨ React.createElement æˆ–è¿”å›ç‰©ä»¶çµæ§‹ä¾›çµ„ä»¶ä½¿ç”¨
    // ä½†ç‚ºäº†æ–¹ä¾¿ï¼Œæˆ‘å€‘å‡è¨­ helpers.js ä¹Ÿæœƒè¢« Babel è™•ç†
    // å¦‚æœä¸è¡Œçš„è©±ï¼Œé€™äº›å‡½æ•¸æ‡‰è©²ä¿ç•™åœ¨çµ„ä»¶å…§æˆ– index.html
    // æ—¢ç„¶ index.html æœ‰ babelï¼Œå®ƒå¼•å…¥ helpers.js (type="text/babel") æ‡‰è©²æ²’å•é¡Œ

    // Closed ç‹€æ…‹å„ªå…ˆåˆ¤æ–· (ä¸åŸ·è¡Œ/å–æ¶ˆçš„ä»»å‹™ä¸ç®—é€¾æœŸ)
    if (t.status === 'Closed') return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-slate-100 text-slate-500 border border-slate-300">âœ— ä¸åŸ·è¡Œ</span>;

    // Pending ç‹€æ…‹å„ªå…ˆåˆ¤æ–· (æ“±ç½®ä¸­çš„ä»»å‹™ä¸ç®—é€¾æœŸ)
    if (t.status === 'Pending') return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-amber-100 text-amber-700 border border-amber-200">â¸ Pending</span>;

    // é€¾æœŸåˆ¤æ–· (æ’é™¤ Doneã€Closedã€Pending)
    if (t.date < todayStr && t.status !== 'Done' && t.status !== 'Closed' && t.status !== 'Pending') return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-700 border border-red-200">â›” é€¾æœŸ</span>;

    const startDate = getStartDate(t.date, t.duration);
    if (t.status === 'Todo' && startDate <= todayStr) return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700 border border-yellow-200">âš ï¸ æ‡‰é–‹å·¥</span>;
    switch (t.status) {
        case 'Todo': return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-slate-100 text-slate-600">å¾…è¾¦</span>;
        case 'InProgress': return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-700 border border-blue-200">é€²è¡Œä¸­</span>;
        case 'Done': return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200">å®Œæˆ</span>;
        case 'Delayed': return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-orange-100 text-orange-700 border border-orange-200">å»¶èª¤</span>;
        default: return <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-gray-100 text-gray-600">{t.status}</span>;
    }
};

// å–å¾—è¡Œé«˜äº®æ¨£å¼
const getRowHighlight = (task, highlightUrgent, todayStr) => {
    if (!highlightUrgent) return '';
    if (!todayStr) todayStr = getTaiwanToday();

    // å·²å®Œæˆã€ä¸åŸ·è¡Œã€æˆ–æ“±ç½®ä¸­çš„ä»»å‹™ä¸é«˜äº®
    if (task.status === 'Done' || task.status === 'Closed' || task.status === 'Pending') return '';

    // å»¶é²ä»»å‹™ï¼ˆæœ€é«˜å„ªå…ˆï¼‰- åŒ…å« status ç‚º Delayed æˆ–å®Œæˆæ—¥æœŸå·²éï¼ˆæ’é™¤ Doneã€Closedã€Pendingï¼‰
    const isOverdue = task.date < todayStr;
    if (task.status === 'Delayed' || (task.status !== 'Done' && task.status !== 'Closed' && task.status !== 'Pending' && isOverdue)) {
        return 'bg-red-50 border-l-4 border-red-500';
    }

    // æ‡‰é–‹å·¥æœªå‹•
    const startDate = getStartDate(task.date, task.duration);
    if (task.status === 'Todo' && startDate <= todayStr && task.date >= todayStr) {
        return 'bg-yellow-50 border-l-4 border-yellow-500';
    }

    return '';
};

// ========================================
// ğŸ“§ PIC Email Format Helpers (æ–¹æ¡ˆ A)
// ========================================

/**
 * å°‡ email å¸³è™Ÿè½‰æ›ç‚ºé¡¯ç¤ºåç¨±
 * ä½¿ç”¨ Owners è¡¨é€²è¡Œå°ç…§ï¼Œæ‰¾ä¸åˆ°å‰‡ç›´æ¥é¡¯ç¤ºå¸³è™Ÿ
 * @param {string} emailAccount - email å¸³è™Ÿ (å¦‚ james.lu)
 * @param {Array} owners - Owners æ¸…å–® (ä¾†è‡ª API æˆ– Context)
 * @returns {string} é¡¯ç¤ºåç¨± (å¦‚ å®—ç©) æˆ– fallback å¸³è™Ÿ
 */
const getDisplayName = (emailAccount, owners = []) => {
    if (!emailAccount) return '';

    // æ¨™æº–åŒ–æ¯”å°
    const accountLower = emailAccount.toLowerCase().trim();

    // å¾ Owners è¡¨æ‰¾å°æ‡‰çš„é¡¯ç¤ºåç¨±
    const owner = owners.find(o => {
        if (!o.email) return false;
        const ownerAccount = o.email.split('@')[0].toLowerCase().trim();
        return ownerAccount === accountLower;
    });

    return owner?.ownerName || emailAccount;  // fallback é¡¯ç¤º email å¸³è™Ÿ
};

/**
 * å°‡é¡¯ç¤ºåç¨±è½‰æ›ç‚º email å¸³è™Ÿ
 * åå‘æŸ¥è©¢ï¼Œç”¨æ–¼è¡¨å–®æäº¤
 * @param {string} displayName - é¡¯ç¤ºåç¨± (å¦‚ å®—ç©)
 * @param {Array} owners - Owners æ¸…å–®
 * @returns {string} email å¸³è™Ÿ (å¦‚ james.lu) æˆ–åŸå§‹åç¨±
 */
const getOwnerEmail = (displayName, owners = []) => {
    if (!displayName) return '';

    const owner = owners.find(o => o.ownerName === displayName);

    if (owner?.email) {
        return owner.email.split('@')[0];  // å›å‚³ email å¸³è™Ÿéƒ¨åˆ†
    }

    return displayName;  // fallback
};

// ========================================
// ğŸŒ Global Export (è®“å…¶ä»–æª”æ¡ˆå¯ä»¥ä½¿ç”¨é€™äº›å‡½æ•¸)
// ========================================
// å› ç‚ºä½¿ç”¨ Babel è¼‰å…¥ï¼Œconst è²æ˜æ˜¯æ¨¡çµ„ä½œç”¨åŸŸ
// éœ€è¦æ˜ç¢ºé™„åŠ åˆ° window æ‰èƒ½è·¨æª”æ¡ˆè¨ªå•

window.getTeamColor = getTeamColor;
window.getProjectColor = getProjectColor;
window.getTeamBadgeClass = getTeamBadgeClass;
window.getPriorityBadge = getPriorityBadge;
window.getTaskIdBadge = getTaskIdBadge;
window.normalizeDate = normalizeDate;
window.getTaiwanToday = getTaiwanToday;
window.getStartDate = getStartDate;
window.parseDependencies = parseDependencies;
window.validateDependencies = validateDependencies;
window.validateTask = validateTask;
window.detectCircularDependency = detectCircularDependency;
window.getStatusBadge = getStatusBadge;
window.getRowHighlight = getRowHighlight;
window.getDisplayName = getDisplayName;
window.getOwnerEmail = getOwnerEmail;



</script>
    <script type="text/babel">
/**
 * LoginScreen çµ„ä»¶ (Lite ç‰ˆæœ¬)
 * é¡¯ç¤ºè¼‰å…¥ç•«é¢ - Lite ç‰ˆæœ¬è‡ªå‹•ä»¥ Local Admin èº«ä»½ç™»å…¥
 */

const LoginScreen = () => {
    return (
        <div className="min-h-screen flex items-center justify-center bg-slate-50 px-4">
            <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 border border-indigo-100">
                <div className="text-center mb-8">
                    <div className="bg-indigo-600 w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-200">
                        <Icon path={paths.list} size={32} className="text-white" />
                    </div>
                    <h1 className="text-2xl font-bold text-slate-800">Project Tracker</h1>
                    <div className="text-slate-500 text-sm">Lite Version</div>
                </div>

                <div className="space-y-6 text-center">
                    <div className="animate-pulse flex flex-col items-center">
                        <div className="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
                        <h3 className="text-lg font-medium text-slate-700">æ­£åœ¨è¼‰å…¥...</h3>
                        <p className="text-sm text-slate-500 mt-1">åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼</p>
                    </div>

                    <div className="mt-6 bg-green-50 text-green-700 px-4 py-3 rounded-lg text-sm text-left">
                        <div className="font-bold mb-1 flex items-center gap-2">
                            âœ… Lite ç‰ˆæœ¬ - ç„¡éœ€ç™»å…¥
                        </div>
                        <ul className="list-disc list-inside space-y-1 opacity-80">
                            <li>è‡ªå‹•ä»¥ Local Admin èº«ä»½é‹è¡Œ</li>
                            <li>é©åˆå€‹äººæˆ–å°åœ˜éšŠä½¿ç”¨</li>
                            <li>ç„¡éœ€è¨­å®š Google OAuth</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    );
};

window.LoginScreen = LoginScreen;

</script>
    <script type="text/babel">
// GanttView Component
// éœ€ç¢ºä¿å¼•å…¥: React, Recharts(é›–ç„¶æ­¤çµ„ä»¶æ²’ç”¨), helpers.js, icons.js
// Props: tasks, ganttFilterTeam, searchQuery, setGanttFilterTeam, setEditingTask, setIsModalOpen, setViewMode, isMobile, todayStr, showDependencies, setShowDependencies (if managed externally, but here it manages its own state for showDependencies unless lifted) 

// Note: In original code, showDependencies was state in App? 
// Let's check App: line 573: const [showDependencies, setShowDependencies] = useState(false);
// So it is passed as props or context.
// In the original GanttView definition in index.html, it used showDependencies from App scope.
// So I must add showDependencies and setShowDependencies to props.

const GanttView = () => {
    const {
        tasks = [],
        ganttFilterTeam = 'All',
        searchQuery = '',
        setGanttFilterTeam,
        setEditingTask,
        setIsModalOpen,
        setViewMode,
        isMobile,
        todayStr,
        showDependencies,
        setShowDependencies,
        TEAMS = []
    } = useAppContext();

    // Constants
    const PX_PER_DAY = 40;
    const ROW_HEIGHT = 40;
    const { useState, useEffect, useMemo, useRef } = React;

    // ============================================
    // å°ˆæ¡ˆé¡è‰²é…ç½® - ä¾éœ€æ±‚è‡ªè¡Œæ“´å……
    // ============================================
    const PROJECT_COLORS = {
        'PlanB': { bg: 'bg-emerald-500', border: '#10b981' },      // ç¶ è‰²
        'Machine': { bg: 'bg-purple-500', border: '#a855f7' },     // ç´«è‰²
        'Genentech': { bg: 'bg-blue-500', border: '#3b82f6' },     // è—è‰²
        'Platform': { bg: 'bg-orange-500', border: '#f97316' },    // æ©˜è‰²
        'Chip': { bg: 'bg-cyan-500', border: '#06b6d4' },          // é’è‰²
        'Software': { bg: 'bg-pink-500', border: '#ec4899' },      // ç²‰ç´…
        'QC': { bg: 'bg-amber-500', border: '#f59e0b' },           // é»ƒè‰²
    };
    const DEFAULT_COLOR = { bg: 'bg-slate-500', border: '#64748b' };

    // å–å¾—å°ˆæ¡ˆé¡è‰²çš„å‡½å¼
    const getProjectColor = (projectName) => {
        if (!projectName) return DEFAULT_COLOR;
        // æ”¯æ´éƒ¨åˆ†åŒ¹é…ï¼ˆä¾‹å¦‚ projectName åŒ…å«é—œéµå­—ï¼‰
        const exactMatch = PROJECT_COLORS[projectName];
        if (exactMatch) return exactMatch;
        // å˜—è©¦éƒ¨åˆ†åŒ¹é…
        for (const [key, value] of Object.entries(PROJECT_COLORS)) {
            if (projectName.toLowerCase().includes(key.toLowerCase())) {
                return value;
            }
        }
        return DEFAULT_COLOR;
    };

    const { sortedTasks, minDate, totalDays } = useMemo(() => {
        // å…ˆä¾æ“š Team ç¯©é¸
        let ganttTasks = tasks.filter(t => ganttFilterTeam === 'All' || (t.team && t.team === ganttFilterTeam));

        // å†ä¾æ“šæœå°‹æ¢ä»¶ç¯©é¸ï¼ˆæ”¯æ´å‰ç¶´è©æœå°‹ï¼‰
        if (searchQuery.trim()) {
            const query = searchQuery.trim();

            // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨å‰ç¶´è©æœå°‹ (ä¾‹å¦‚: "project:Genentech" æˆ– "purpose:å­”ç›¤")
            const prefixMatch = query.match(/^(project|purpose|owner|pic|team|task|note|status):(.*)/i);

            if (prefixMatch) {
                // å‰ç¶´è©æœå°‹æ¨¡å¼
                const field = prefixMatch[1].toLowerCase();
                const searchValue = prefixMatch[2].toLowerCase();

                ganttTasks = ganttTasks.filter(t => {
                    switch (field) {
                        case 'project':
                            return t.project && String(t.project).toLowerCase().includes(searchValue);
                        case 'purpose':
                            return t.purpose && String(t.purpose).toLowerCase().includes(searchValue);
                        case 'owner':
                        case 'pic':
                            return t.owner && String(t.owner).toLowerCase().includes(searchValue);
                        case 'team':
                            return t.team && String(t.team).toLowerCase().includes(searchValue);
                        case 'task':
                            return t.task && String(t.task).toLowerCase().includes(searchValue);
                        case 'note':
                            return t.notes && String(t.notes).toLowerCase().includes(searchValue);
                        case 'status':
                            return t.status && String(t.status).toLowerCase().includes(searchValue);
                        default:
                            return false;
                    }
                });
            } else {
                // ä¸€èˆ¬æœå°‹æ¨¡å¼ï¼ˆæœå°‹æ‰€æœ‰æ¬„ä½ï¼ŒåŒ…å« purposeï¼‰
                const lowerQuery = query.toLowerCase();
                ganttTasks = ganttTasks.filter(t => {
                    const matchTask = t.task && String(t.task).toLowerCase().includes(lowerQuery);
                    const matchOwner = t.owner && String(t.owner).toLowerCase().includes(lowerQuery);
                    const matchTeam = t.team && String(t.team).toLowerCase().includes(lowerQuery);
                    const matchProject = t.project && String(t.project).toLowerCase().includes(lowerQuery);
                    const matchPurpose = t.purpose && String(t.purpose).toLowerCase().includes(lowerQuery);
                    const matchNotes = t.notes && String(t.notes).toLowerCase().includes(lowerQuery);
                    return matchTask || matchOwner || matchTeam || matchProject || matchPurpose || matchNotes;
                });
            }
        }

        // è¼”åŠ©å‡½æ•¸ï¼šé©—è­‰æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
        const isValidDate = (d) => d instanceof Date && !isNaN(d.getTime());

        // å»é‡é‚è¼¯ï¼šä½¿ç”¨ Map ç¢ºä¿ç›¸åŒ ID çš„ä»»å‹™åªä¿ç•™ä¸€ç­†
        const uniqueTasksMap = new Map();
        ganttTasks.forEach(t => {
            if (!uniqueTasksMap.has(t.id)) {
                uniqueTasksMap.set(t.id, t);
            }
        });
        const uniqueTasks = Array.from(uniqueTasksMap.values());

        const sorted = uniqueTasks
            // å…ˆéæ¿¾æ‰æ²’æœ‰æœ‰æ•ˆæ—¥æœŸçš„ä»»å‹™
            .filter(t => {
                const endDate = new Date(t.date);
                return isValidDate(endDate);
            })
            .sort((a, b) => new Date(getStartDate(a.date, a.duration)) - new Date(getStartDate(b.date, b.duration)));

        let min = new Date();
        let max = new Date();
        if (sorted.length > 0) {
            // éæ¿¾æ‰ç„¡æ•ˆæ—¥æœŸï¼Œé¿å… NaN å•é¡Œ
            const dates = sorted.flatMap(t => {
                const startDate = new Date(getStartDate(t.date, t.duration));
                const endDate = new Date(t.date);
                return [startDate, endDate].filter(isValidDate);
            });

            if (dates.length > 0) {
                min = new Date(Math.min(...dates));
                max = new Date(Math.max(...dates));
            }
        }
        min.setDate(min.getDate() - 5);
        max.setDate(max.getDate() + 15);
        const days = Math.ceil((max - min) / (1000 * 60 * 60 * 24));
        return { sortedTasks: sorted, minDate: min, totalDays: days };
    }, [tasks, ganttFilterTeam, searchQuery]);

    const getLeftPos = (dStr) => {
        const d = new Date(dStr);
        const diff = Math.ceil((d - minDate) / (1000 * 60 * 60 * 24));
        return diff * PX_PER_DAY;
    };

    const todayPos = getLeftPos(todayStr);

    const drawDependencies = () => {
        if (!showDependencies) return null;
        const lines = [];

        sortedTasks.forEach((task, taskIndex) => {
            if (!task.dependency) return;

            // è§£æå¤šå€‹ç›¸ä¾æ€§
            const depIds = parseDependencies(task.dependency);

            depIds.forEach(depId => {
                const parent = sortedTasks.find(p => String(p.id) === String(depId));
                const parentIndex = sortedTasks.indexOf(parent);
                if (!parent || parentIndex === -1) return;

                const parentStartStr = getStartDate(parent.date, parent.duration);
                const parentX = getLeftPos(parentStartStr) + (parent.duration * PX_PER_DAY);
                const parentY = parentIndex * ROW_HEIGHT + 20;
                const childStartStr = getStartDate(task.date, task.duration);
                const childX = getLeftPos(childStartStr);
                const childY = taskIndex * ROW_HEIGHT + 20;

                // è¡çªåµæ¸¬ï¼šå­ä»»å‹™é–‹å§‹æ—¥æœŸæ—©æ–¼æˆ–ç­‰æ–¼çˆ¶ä»»å‹™å®Œæˆæ—¥æœŸ
                const hasConflict = parent.date >= childStartStr;
                const strokeColor = hasConflict ? '#dc2626' : '#94a3b8';
                const strokeWidth = hasConflict ? '2.5' : '1.5';
                const markerEnd = hasConflict ? 'url(#arrowhead-red)' : 'url(#arrowhead)';

                const path = `M ${parentX} ${parentY} C ${parentX + 20} ${parentY}, ${childX - 20} ${childY}, ${childX} ${childY}`;
                lines.push(
                    <path key={`${parent.id}-${task.id}`} d={path} stroke={strokeColor} strokeWidth={strokeWidth} fill="none" markerEnd={markerEnd} />
                );
            });
        });

        return lines;
    };

    // Group days by month for the month header
    const monthHeaders = useMemo(() => {
        const headers = [];
        let currentMonth = -1;
        let monthStartDay = 0;

        for (let i = 0; i < totalDays; i++) {
            const d = new Date(minDate);
            d.setDate(d.getDate() + i);
            const month = d.getMonth();

            if (month !== currentMonth) {
                if (currentMonth !== -1) {
                    headers.push({
                        month: currentMonth,
                        year: new Date(minDate.getTime() + (monthStartDay * 24 * 60 * 60 * 1000)).getFullYear(),
                        startDay: monthStartDay,
                        daysCount: i - monthStartDay
                    });
                }
                currentMonth = month;
                monthStartDay = i;
            }
        }
        // Add last month segment
        headers.push({
            month: currentMonth,
            year: new Date(minDate.getTime() + (monthStartDay * 24 * 60 * 60 * 1000)).getFullYear(),
            startDay: monthStartDay,
            daysCount: totalDays - monthStartDay
        });

        return headers;
    }, [minDate, totalDays]);

    // Grid lines for timeline
    const gridLines = Array.from({ length: totalDays }).map((_, i) => {
        const d = new Date(minDate);
        d.setDate(d.getDate() + i);
        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
        return <div key={i} className={`gantt-grid-col ${isWeekend ? 'bg-slate-50' : ''}`} style={{ width: `${PX_PER_DAY}px` }}></div>
    });

    // Timeline day header cells
    const timelineDayHeaders = Array.from({ length: totalDays }).map((_, i) => {
        const d = new Date(minDate);
        d.setDate(d.getDate() + i);
        return <div key={i} className={`gantt-day-cell ${d.getDay() === 0 || d.getDay() === 6 ? 'is-weekend' : ''}`} style={{ width: `${PX_PER_DAY}px` }}>{d.getDate()}</div>
    });

    // åŒæ­¥æ»¾å‹• refs
    const headerRef = useRef(null);
    const bodyRef = useRef(null);
    const hasScrolledToToday = useRef(false);

    // åˆæ¬¡è¼‰å…¥ï¼šæ»¾å‹•åˆ°ä»Šå¤©ä½ç½®ï¼ˆç½®ä¸­é¡¯ç¤ºï¼‰
    useEffect(() => {
        const bodyEl = bodyRef.current;
        if (!bodyEl || hasScrolledToToday.current) return;

        // è¨ˆç®—æ»¾å‹•ä½ç½®ï¼šä»Šå¤©ç´…ç·šç½®ä¸­
        const containerWidth = bodyEl.clientWidth;
        const scrollTarget = todayPos - (containerWidth / 2) + 200; // 200 æ˜¯å·¦å´ä»»å‹™æ¬„å¯¬åº¦

        if (scrollTarget > 0) {
            bodyEl.scrollLeft = scrollTarget;
            hasScrolledToToday.current = true;
        }
    }, [todayPos, sortedTasks]);

    // åŒæ­¥æ°´å¹³æ»¾å‹•
    useEffect(() => {
        const bodyEl = bodyRef.current;
        const headerEl = headerRef.current;

        if (!bodyEl || !headerEl) return;

        const handleBodyScroll = () => {
            if (headerEl) {
                headerEl.scrollLeft = bodyEl.scrollLeft;
            }
        };

        bodyEl.addEventListener('scroll', handleBodyScroll);
        return () => bodyEl.removeEventListener('scroll', handleBodyScroll);
    }, []);

    // è¡Œå‹•ç‰ˆå‹å–„æç¤º
    if (isMobile) {
        return (
            <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden p-8 text-center">
                <div className="text-6xl mb-4">ğŸ“±</div>
                <h3 className="text-xl font-bold text-slate-800 mb-2">å»ºè­°ä½¿ç”¨æ¡Œé¢ç‰ˆç€è¦½</h3>
                <p className="text-slate-600 mb-4">
                    ç”˜ç‰¹åœ–åœ¨å¤§è¢å¹•ä¸Šæœ‰æ›´å¥½çš„ä½¿ç”¨é«”é©—ã€‚<br />
                    å»ºè­°æ‚¨åœ¨æ¡Œä¸Šå‹é›»è…¦æˆ–å¹³æ¿æ©«å‘æ¨¡å¼ä¸‹æŸ¥çœ‹ã€‚
                </p>
                <button
                    onClick={() => setViewMode('dashboard')}
                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors"
                >
                    è¿”å›åˆ—è¡¨è¦–åœ–
                </button>
            </div>
        );
    }

    return (
        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col h-[600px]">
            <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                <h3 className="font-bold text-slate-700">å°ˆæ¡ˆç”˜ç‰¹åœ– (Gantt)</h3>
                <div className="flex items-center gap-4">
                    <div className="flex items-center gap-2 text-xs text-slate-600 bg-white px-2 py-1 rounded border shadow-sm">
                        <input type="checkbox" id="toggleDeps" checked={showDependencies} onChange={(e) => setShowDependencies(e.target.checked)} className="rounded text-indigo-600 focus:ring-indigo-500" />
                        <label htmlFor="toggleDeps" className="cursor-pointer select-none">é¡¯ç¤ºé€£ç·š (Beta)</label>
                    </div>
                    <div className="flex gap-2 flex-wrap">
                        {TEAMS.map(t => (
                            <button
                                key={t}
                                onClick={() => {
                                    setGanttFilterTeam(prev => prev === t ? 'All' : t);
                                }}
                                className={`px-3 py-1.5 rounded-md text-xs font-medium transition-colors cursor-pointer whitespace-nowrap ${ganttFilterTeam === 'All' || ganttFilterTeam === t
                                    ? 'bg-indigo-600 text-white shadow-md'
                                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                    }`}
                            >
                                {t || '(ç„¡åç¨±)'}
                            </button>
                        ))}
                    </div>
                </div>
            </div>

            <div className="gantt-wrapper">
                {/* Header Row */}
                <div className="gantt-header-row" ref={headerRef} style={{ overflowX: 'hidden' }}>
                    <div className="gantt-header-wrapper">
                        <div className="gantt-header-task">ä»»å‹™åç¨±</div>
                        <div className="gantt-header-timeline" style={{ width: `${totalDays * PX_PER_DAY}px` }}>
                            <div className="gantt-header-month-row">
                                {monthHeaders.map((m, idx) => (
                                    <div key={idx} className={`gantt-month-cell ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}`} style={{ width: `${m.daysCount * PX_PER_DAY}px` }}>
                                        {m.year}å¹´{m.month + 1}æœˆ
                                    </div>
                                ))}
                            </div>
                            <div className="gantt-header-day-row">
                                {timelineDayHeaders}
                            </div>
                        </div>
                    </div>
                </div>

                {/* Body */}
                <div className="gantt-body" ref={bodyRef}>
                    <div className="gantt-body-content" style={{ width: `${200 + totalDays * PX_PER_DAY}px` }}>
                        {/* Grid Background */}
                        <div className="gantt-grid-lines" style={{ width: `${totalDays * PX_PER_DAY}px` }}>{gridLines}</div>

                        {/* Today Line */}
                        {todayPos > 0 && <div className="today-line" style={{ left: `${200 + todayPos}px`, height: '100%' }}></div>}

                        {/* SVG Lines */}
                        <svg className="dependency-svg" style={{ left: '200px', width: `${totalDays * PX_PER_DAY}px`, height: `${sortedTasks.length * ROW_HEIGHT}px` }}>
                            <defs>
                                <marker id="arrowhead" markerWidth="6" markerHeight="4" refX="5" refY="2" orient="auto">
                                    <polygon points="0 0, 6 2, 0 4" fill="#94a3b8" />
                                </marker>
                                <marker id="arrowhead-red" markerWidth="6" markerHeight="4" refX="5" refY="2" orient="auto">
                                    <polygon points="0 0, 6 2, 0 4" fill="#dc2626" />
                                </marker>
                            </defs>
                            {drawDependencies()}
                        </svg>

                        {/* Task Rows */}
                        {sortedTasks.map(t => {
                            const start = getStartDate(t.date, t.duration);
                            let left = getLeftPos(start);
                            let width = t.duration * PX_PER_DAY;

                            // é™åˆ¶ left ä¸ç‚ºè² æ•¸ï¼Œä¸¦èª¿æ•´å¯¬åº¦
                            if (left < 0) {
                                width = Math.max(width + left, 0); // æ¸›å°‘è¶…å‡ºçš„éƒ¨åˆ†
                                left = 0;
                            }
                            // ç¢ºä¿æœ€å°å¯¬åº¦
                            width = Math.max(width, PX_PER_DAY / 2);

                            // ä½¿ç”¨é¡è‰²é…ç½®ç³»çµ±
                            const projectColor = getProjectColor(t.project);
                            const colorClass = projectColor.bg;
                            const borderColor = projectColor.border;
                            const isClosed = t.status === 'Closed';

                            // æ—¥æœŸè®Šæ›´æ­·å²è¨ˆç®—
                            const history = Array.isArray(t.dateHistory) ? t.dateHistory : [];
                            const originalDate = history.length > 0 ? history[0].date : null;
                            const hasDateChange = history.length > 1 && originalDate !== t.date;
                            const isRecurring = t.taskType === 'recurring';

                            // åŸå§‹æ™‚ç¨‹ä½ç½®è¨ˆç®—
                            let origLeft = 0, origWidth = 0, delayDays = 0;
                            if (hasDateChange && originalDate) {
                                const origStart = getStartDate(originalDate, t.duration);
                                origLeft = Math.max(getLeftPos(origStart), 0);
                                origWidth = t.duration * PX_PER_DAY;
                                delayDays = Math.round((new Date(t.date) - new Date(originalDate)) / (1000 * 60 * 60 * 24));
                            }

                            // ç›¸ä¾æ€§è¡çªåµæ¸¬
                            let hasConflict = false;
                            if (t.dependency) {
                                const depIds = parseDependencies(t.dependency);
                                const taskStart = start;
                                for (const depId of depIds) {
                                    const parent = sortedTasks.find(p => String(p.id) === String(depId));
                                    if (parent && parent.date >= taskStart) {
                                        hasConflict = true;
                                        break;
                                    }
                                }
                            }

                            return (
                                <div key={t.id} className={`gantt-row ${hasConflict ? 'bg-red-50' : ''}`}>
                                    <div className="gantt-task-col truncate flex items-center gap-1" title={t.task}>
                                        <span className="truncate">{t.task}</span>
                                        {hasConflict && <span className="bg-orange-100 text-orange-600 text-[9px] px-1 rounded flex-shrink-0">âš ï¸</span>}
                                        {/* Closed ç‹€æ…‹ï¼šç°è‰²æ¨™ç±¤ */}
                                        {isClosed && <span className="bg-slate-100 text-slate-500 text-[9px] px-1 rounded flex-shrink-0">âœ—</span>}
                                        {/* é€±æœŸæ€§ä»»å‹™ï¼šè—è‰²é€±æœŸæ¨™ç±¤ */}
                                        {isRecurring && hasDateChange && <span className="bg-blue-100 text-blue-600 text-[9px] px-1 rounded flex-shrink-0" title="é€±æœŸæ€§ä»»å‹™">ğŸ”„</span>}
                                        {/* ä¸€æ¬¡æ€§ä»»å‹™ï¼šç´…è‰²å»¶æœŸæ¨™ç±¤ */}
                                        {!isRecurring && hasDateChange && delayDays > 0 && <span className="bg-red-100 text-red-600 text-[9px] px-1 rounded flex-shrink-0">+{delayDays}å¤©</span>}
                                    </div>
                                    <div className="gantt-timeline-col">
                                        {/* åŸå§‹æ™‚ç¨‹æ·ºè‰²æ¢ */}
                                        {hasDateChange && (
                                            <div
                                                className="gantt-bar absolute"
                                                style={{
                                                    left: `${origLeft}px`,
                                                    width: `${origWidth}px`,
                                                    backgroundColor: isRecurring ? 'rgba(59, 130, 246, 0.3)' : 'rgba(148, 163, 184, 0.4)',
                                                    border: isRecurring ? '2px dashed #3b82f6' : '2px dashed #64748b',
                                                    zIndex: 10
                                                }}
                                                title={isRecurring ? `ä¸Šæ¬¡é€±æœŸ: ${originalDate}` : `åŸå§‹è¦åŠƒ: ${originalDate}`}
                                            />
                                        )}
                                        {/* ç›®å‰æ™‚ç¨‹æ¢ */}
                                        <div
                                            className={`gantt-bar ${isClosed ? '' : colorClass} ${t.status === 'Done' ? 'opacity-50 grayscale' : ''} ${hasConflict ? 'ring-2 ring-red-500 shadow-lg shadow-red-200' : ''}`}
                                            style={{
                                                left: `${left}px`,
                                                width: `${width}px`,
                                                zIndex: 20,
                                                // Closed ç‹€æ…‹ï¼šé€æ˜èƒŒæ™¯ + å°ˆæ¡ˆé¡è‰²è™›ç·šå¤–æ¡†
                                                ...(isClosed ? {
                                                    backgroundColor: 'rgba(148, 163, 184, 0.3)',
                                                    border: `3px dashed ${borderColor}`,
                                                    boxShadow: 'none'
                                                } : {})
                                            }}
                                            onClick={() => { setEditingTask(t); setIsModalOpen(true); }}
                                            title={`${t.task} (${t.duration}å¤©)${hasConflict ? ' - âš ï¸ç›¸ä¾æ€§è¡çª' : ''}${isClosed ? ' - å·²å–æ¶ˆ' : ''}`}
                                        >
                                            {t.duration > 2 && <span className="text-[10px] pl-1">{t.owner}</span>}
                                        </div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            </div>
        </div>
    );
};

window.GanttView = GanttView;

</script>
    <script type="text/babel">
// CalendarView Component
// Props: tasks, calendarMonth, setCalendarMonth, setEditingTask, setIsModalOpen
// éœ€å¼•å…¥: React, icons.js, helpers.js (getProjectColor)

const CalendarView = () => {
    const {
        tasks,
        calendarMonth,
        setCalendarMonth,
        setEditingTask,
        setIsModalOpen,
        searchQuery = ''
    } = useAppContext();
    const { useMemo } = React;

    // æ•ˆèƒ½å„ªåŒ–ï¼šå¿«å–æ—¥æ›†è¦–åœ–è³‡æ–™ï¼ˆæ·»åŠ æœå°‹éæ¿¾ï¼‰
    // åªæœ‰åœ¨æœˆä»½ã€ä»»å‹™æˆ–æœå°‹æ¢ä»¶æ”¹è®Šæ™‚æ‰é‡æ–°è¨ˆç®—
    const calendarDays = useMemo(() => {
        const year = calendarMonth.getFullYear();
        const month = calendarMonth.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const days = [];

        for (let i = 0; i < firstDay.getDay(); i++) days.push(null);

        for (let i = 1; i <= lastDay.getDate(); i++) {
            const dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
            let dayTasks = tasks.filter(t => t.date === dStr);

            // âœ… æ‡‰ç”¨æœå°‹éæ¿¾ï¼ˆèˆ‡ Dashboard/GanttView ä¸€è‡´ï¼‰
            if (searchQuery.trim()) {
                const query = searchQuery.trim();
                const prefixMatch = query.match(/^(project|purpose|owner|pic|team|task|note|category|status):(.*)/i);

                if (prefixMatch) {
                    // å‰ç¶´è©æœå°‹
                    const field = prefixMatch[1].toLowerCase();
                    const searchValue = prefixMatch[2].toLowerCase();

                    dayTasks = dayTasks.filter(t => {
                        switch (field) {
                            case 'project':
                                return t.project && String(t.project).toLowerCase().includes(searchValue);
                            case 'owner':
                            case 'pic':
                                return t.owner && String(t.owner).toLowerCase().includes(searchValue);
                            case 'team':
                                return t.team && String(t.team).toLowerCase().includes(searchValue);
                            case 'task':
                                return t.task && String(t.task).toLowerCase().includes(searchValue);
                            case 'note':
                                return t.notes && String(t.notes).toLowerCase().includes(searchValue);
                            case 'category':
                                return t.category && String(t.category).toLowerCase().includes(searchValue);
                            case 'purpose':
                                return t.purpose && String(t.purpose).toLowerCase().includes(searchValue);
                            case 'status':
                                return t.status && String(t.status).toLowerCase().includes(searchValue);
                            default:
                                return false;
                        }
                    });
                } else {
                    // ä¸€èˆ¬æœå°‹
                    const lowerQuery = query.toLowerCase();
                    dayTasks = dayTasks.filter(t => {
                        const matchTask = t.task && String(t.task).toLowerCase().includes(lowerQuery);
                        const matchOwner = t.owner && String(t.owner).toLowerCase().includes(lowerQuery);
                        const matchNotes = t.notes && String(t.notes).toLowerCase().includes(lowerQuery);
                        const matchCategory = t.category && String(t.category).toLowerCase().includes(lowerQuery);
                        const matchTeam = t.team && String(t.team).toLowerCase().includes(lowerQuery);
                        const matchProject = t.project && String(t.project).toLowerCase().includes(lowerQuery);
                        const matchPurpose = t.purpose && String(t.purpose).toLowerCase().includes(lowerQuery);
                        return matchTask || matchOwner || matchNotes || matchCategory || matchTeam || matchProject || matchPurpose;
                    });
                }
            }

            days.push({ date: i, fullDate: dStr, tasks: dayTasks });
        }
        return days;
    }, [calendarMonth, tasks, searchQuery]);

    const changeMonth = (offset) => {
        setCalendarMonth(prev => {
            const next = new Date(prev);
            next.setMonth(next.getMonth() + offset);
            return next;
        });
    };

    return (
        <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-lg font-bold text-slate-800">
                    {calendarMonth.toLocaleString('default', { year: 'numeric', month: 'long' })}
                </h2>
                <div className="flex gap-2">
                    <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-slate-100 rounded-full">
                        <Icon path={paths.left} />
                    </button>
                    <button onClick={() => changeMonth(1)} className="p-2 hover:bg-slate-100 rounded-full">
                        <Icon path={paths.right} />
                    </button>
                </div>
            </div>
            <div className="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200 rounded-lg overflow-hidden">
                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
                    <div key={d} className="bg-slate-50 py-2 text-center text-xs font-bold text-slate-500 uppercase">{d}</div>
                ))}
                {calendarDays.map((day, idx) => (
                    <div key={idx} className={`bg-white min-h-[120px] p-2 relative calendar-cell ${!day ? 'bg-slate-50/50' : ''}`}>
                        {day && (
                            <>
                                <span className={`text-xs font-medium ${day.date === new Date().getDate() && calendarMonth.getMonth() === new Date().getMonth() ? 'bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center' : 'text-slate-400'}`}>{day.date}</span>
                                <div className="mt-1 space-y-1 overflow-y-auto max-h-[100px] scrollbar-hide">
                                    {day.tasks.map(t => (
                                        <div key={t.id}
                                            onClick={() => { setEditingTask(t); setIsModalOpen(true); }}
                                            className={`group text-[10px] p-1 rounded border-l-2 cursor-pointer hover:opacity-80 flex items-center gap-1 ${getProjectColor(t.project)} ${t.isCheckpoint ? 'font-bold' : ''}`}>
                                            {t.isCheckpoint && <Icon path={paths.flag} size={8} />}
                                            <span className="truncate">
                                                <span className="font-mono text-[9px] mr-1 opacity-70 hidden group-hover:inline">#{t.id}</span>
                                                {t.task}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </>
                        )}
                    </div>
                ))}
            </div>
        </div>
    );
};

window.CalendarView = CalendarView;

</script>

    <script type="text/babel">
// TaskModal Component v2.1 - Step-by-Step Wizard (Lite Version)
// 4 æ­¥é©Ÿå¼•å°å¼è¡¨å–®
// éœ€è¦å¼•å…¥: React, icons.js


const TaskModal = ({
    isOpen,
    onClose,
    editingTask,
    onSubmit,
    TEAMS,
    PROJECTS,
    OWNERS,
    CATEGORIES,
    tasks = [],
    userPermission = 'viewer',
    teamsData = [] // å«æœ‰ Leader è³‡è¨Šçš„ Teams è³‡æ–™
}) => {
    const { useState, useEffect, useMemo } = React;
    const todayStr = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });

    // ==================== æ¬Šé™åˆ¤æ–· ====================
    const canDirectEdit = userPermission === 'admin' || userPermission === 'editor';

    // ==================== Step ç²¾éˆç‹€æ…‹ ====================
    const [currentStep, setCurrentStep] = useState(1);
    const [isQuickMode, setIsQuickMode] = useState(true);

    // ==================== è¡¨å–®è³‡æ–™ç‹€æ…‹ (å¿…é ˆåœ¨ forceFullMode ä¹‹å‰å®šç¾©) ====================
    const [formData, setFormData] = useState({});

    // åˆå§‹åŒ–è¡¨å–®è³‡æ–™
    useEffect(() => {
        if (isOpen) {
            setFormData({
                task: editingTask?.task || '',
                project: editingTask?.project || PROJECTS[0] || '',
                purpose: editingTask?.purpose || '',
                team: editingTask?.team || 'æ™¶ç‰‡',
                owner: editingTask?.owner || '',
                duration: editingTask?.duration || 1,
                issueDate: editingTask?.issueDate || todayStr,
                startDate: editingTask?.startDate || '',
                date: editingTask?.date || todayStr,
                status: editingTask?.status || 'Todo',
                priority: editingTask?.priority || 'Medium',
                dependency: editingTask?.dependency || '',
                verification: editingTask?.verification || '',
                notes: editingTask?.notes || '',
                isCheckpoint: editingTask?.isCheckpoint || false,
                issuePool: editingTask?.issuePool || false,
                taskType: editingTask?.taskType || 'one-time',
                recurringCycle: editingTask?.recurringCycle || '',
                // Phase 2.0 æ–°æ¬„ä½
                background: editingTask?.background || '',
                expectedResult: editingTask?.expectedResult || '',
                acceptanceCriteria: editingTask?.acceptanceCriteria || '',
                assistants: editingTask?.assistants || '',
                verificationFiles: editingTask?.verificationFiles || '[]',
                reviewer: editingTask?.reviewer || ''
            });
        }
    }, [editingTask, isOpen, PROJECTS, todayStr]);

    // ==================== åˆ¤æ–·æ˜¯å¦ç‚ºã€Œå¤§ caseã€éœ€å¼·åˆ¶å®Œæ•´æ¨¡å¼ ====================
    // åŒæ™‚æª¢æŸ¥ editingTask (åˆå§‹) å’Œ formData (å‹•æ…‹è¼¸å…¥)
    const forceFullMode = useMemo(() => {
        // å…ˆæª¢æŸ¥ editingTask (æ‰“é–‹ç·¨è¼¯ç¾æœ‰ä»»å‹™æ™‚)
        if (editingTask) {
            if ((editingTask.duration >= 5) ||
                (editingTask.priority === 'High') ||
                (editingTask.isCheckpoint === true) ||
                (editingTask.nodeType === 'epic')) {
                return true;
            }
        }
        // å†æª¢æŸ¥ formData (ç”¨æˆ¶åœ¨è¡¨å–®ä¸­çš„è¼¸å…¥)
        const duration = formData?.duration ?? 0;
        const priority = formData?.priority ?? '';
        const isCheckpoint = formData?.isCheckpoint ?? false;

        if (duration >= 5 || priority === 'High' || isCheckpoint === true) {
            return true;
        }
        return false;
    }, [editingTask, formData?.duration, formData?.priority, formData?.isCheckpoint]);

    // åˆå§‹åŒ–æ¨¡å¼ (æ‰“é–‹ Modal æ™‚)
    useEffect(() => {
        if (isOpen) {
            // åˆå§‹åˆ¤æ–·ï¼šç·¨è¼¯å¤§ case æ™‚å¼·åˆ¶å®Œæ•´æ¨¡å¼
            const initialForce = editingTask && (
                (editingTask.duration >= 5) ||
                (editingTask.priority === 'High') ||
                (editingTask.isCheckpoint === true) ||
                (editingTask.nodeType === 'epic')
            );
            setIsQuickMode(!initialForce);
            setCurrentStep(1);
        }
    }, [editingTask, isOpen]);

    // å‹•æ…‹åˆ‡æ›ï¼šç•¶ formData è§¸ç™¼ forceFullMode æ™‚è‡ªå‹•åˆ‡æ›åˆ°å®Œæ•´æ¨¡å¼
    useEffect(() => {
        if (forceFullMode && isQuickMode) {
            setIsQuickMode(false);
            // å¦‚æœç•¶å‰åœ¨å¿«é€Ÿæ¨¡å¼çš„æœ€å¾Œä¸€æ­¥ (Step 3)ï¼Œä¿æŒåœ¨ Step 3
            // é€™æ¨£ç”¨æˆ¶å¯ä»¥ç¹¼çºŒå®Œæˆå‰©é¤˜çš„ Step 4
        }
    }, [forceFullMode, isQuickMode]);

    const totalSteps = isQuickMode ? 2 : 4;

    // è¨ˆç®—æœ€å¾Œä¸€æ­¥çš„ step number
    // å¿«é€Ÿæ¨¡å¼ï¼šæœ€å¾Œä¸€æ­¥æ˜¯ Step 3
    // å®Œæ•´æ¨¡å¼ï¼šæœ€å¾Œä¸€æ­¥æ˜¯ Step 4
    const lastStepNumber = isQuickMode ? 3 : 4;

    // åˆ¤æ–·æ˜¯å¦åœ¨æœ€å¾Œä¸€æ­¥
    const isLastStep = currentStep === lastStepNumber;

    // ==================== è‡ªå‹•å¸¶å…¥ Reviewer ====================
    const handleTeamChange = (newTeam) => {
        setFormData(prev => {
            const teamInfo = teamsData.find(t => t.teamName === newTeam);
            return {
                ...prev,
                team: newTeam,
                // åªæœ‰ reviewer ç‚ºç©ºæ™‚æ‰è‡ªå‹•å¸¶å…¥
                reviewer: prev.reviewer || (teamInfo?.leader || '')
            };
        });
    };

    // ==================== æ™‚ç¨‹è®Šæ›´è™•ç† ====================
    const [dateChanged, setDateChanged] = useState(false);

    const handleDateChange = (newDate) => {
        setFormData(prev => ({ ...prev, date: newDate }));
        if (editingTask && newDate !== editingTask.date) {
            setDateChanged(true);
        } else {
            setDateChanged(false);
        }
    };

    // ==================== Purpose å»ºè­° ====================
    const uniquePurposes = useMemo(() => {
        if (!tasks) return [];
        return [...new Set(tasks.map(t => t.purpose).filter(Boolean))].sort();
    }, [tasks]);

    // ==================== AC é©—æ”¶æº–å‰‡è§£æ ====================
    const parseAC = (text) => {
        if (!text) return [];
        return text.split('\n')
            .filter(line => line.trim())
            .map(line => {
                const checked = line.includes('[x]') || line.includes('[X]');
                const content = line.replace(/^-?\s*\[[ xX]?\]\s*/, '').trim();
                return { checked, content };
            });
    };

    const formatAC = (items) => {
        return items.map(item => `- [${item.checked ? 'x' : ' '}] ${item.content}`).join('\n');
    };

    const [acItems, setAcItems] = useState([]);
    const [newAcItem, setNewAcItem] = useState('');

    useEffect(() => {
        setAcItems(parseAC(formData.acceptanceCriteria));
    }, [formData.acceptanceCriteria]);

    const addAcItem = () => {
        if (!newAcItem.trim()) return;
        const newItems = [...acItems, { checked: false, content: newAcItem.trim() }];
        setAcItems(newItems);
        setFormData(prev => ({ ...prev, acceptanceCriteria: formatAC(newItems) }));
        setNewAcItem('');
    };

    const removeAcItem = (index) => {
        const newItems = acItems.filter((_, i) => i !== index);
        setAcItems(newItems);
        setFormData(prev => ({ ...prev, acceptanceCriteria: formatAC(newItems) }));
    };

    const toggleAcItem = (index) => {
        const newItems = acItems.map((item, i) =>
            i === index ? { ...item, checked: !item.checked } : item
        );
        setAcItems(newItems);
        setFormData(prev => ({ ...prev, acceptanceCriteria: formatAC(newItems) }));
    };

    // ==================== ç‹€æ…‹é¸é … ====================
    const getStatusOptions = () => {
        const options = [
            { value: 'Todo', label: 'å¾…åŸ·è¡Œ' },
            { value: 'InProgress', label: 'é€²è¡Œä¸­' },
            { value: 'Pending', label: 'æš«åœ/ç­‰å¾…' },
            { value: 'Done', label: 'å®Œæˆ' },
            { value: 'Closed', label: 'ä¸åŸ·è¡Œ/å–æ¶ˆ' },
            { value: 'Delayed', label: 'å»¶èª¤' }
        ];
        return options;
    };

    // ==================== å°èˆªè™•ç† ====================
    const handleNext = (e) => {
        if (e) e.preventDefault();

        // å¿«é€Ÿæ¨¡å¼ï¼šStep 1 â†’ Step 3
        if (isQuickMode && currentStep === 1) {
            setCurrentStep(3);
            return;
        }

        // å®Œæ•´æ¨¡å¼æˆ–å…¶ä»–æƒ…æ³ï¼šæ­£å¸¸éå¢
        // Step 1 â†’ 2 â†’ 3 â†’ 4
        if (currentStep < 4) {
            setCurrentStep(currentStep + 1);
        }
    };

    const handlePrev = (e) => {
        if (e) e.preventDefault();

        // å¿«é€Ÿæ¨¡å¼ï¼šStep 3 â†’ Step 1
        if (isQuickMode && currentStep === 3) {
            setCurrentStep(1);
            return;
        }

        // å®Œæ•´æ¨¡å¼æˆ–å…¶ä»–æƒ…æ³ï¼šæ­£å¸¸éæ¸›
        if (currentStep > 1) {
            setCurrentStep(currentStep - 1);
        }
    };

    // ==================== è¡¨å–®æäº¤èˆ‡é©—è­‰ ====================
    const validateForm = () => {
        // 1. é©—è­‰ Step 3 (è² è²¬æŒ‡æ´¾) - é€™æ˜¯ã€Œç¡¬é™åˆ¶ (Hard Block)ã€ï¼Œç¼ºäº†ç„¡æ³•é‹ä½œ
        // ç„¡è«–æ˜¯å¿«é€Ÿé‚„æ˜¯å®Œæ•´æ¨¡å¼ï¼Œéƒ½å¿…é ˆæœ‰ Owner å’Œ Date
        if (!formData.owner) {
            alert('è«‹åœ¨ Step 3 é¸æ“‡ã€Œè² è²¬äººã€');
            setCurrentStep(isQuickMode ? 3 : 3);
            return false;
        }
        if (!formData.date) {
            alert('è«‹åœ¨ Step 3 è¨­å®šã€Œå®Œæˆæ—¥ã€');
            setCurrentStep(isQuickMode ? 3 : 3);
            return false;
        }

        // 2. é©—è­‰ AC å®Œæˆåº¦ (è‹¥ç‹€æ…‹è¨­ç‚º Done) - é€™æ˜¯ã€Œç¡¬é™åˆ¶ã€
        // åªæœ‰ç•¶æ‰€æœ‰ AC éƒ½æ‰“å‹¾æ™‚ï¼Œæ‰å…è¨±è¨­ç‚º Done
        if (formData.status === 'Done' && acItems.length > 0) {
            const uncheckedCount = acItems.filter(item => !item.checked).length;
            if (uncheckedCount > 0) {
                const msg = `âš ï¸ å°šæœ‰ ${uncheckedCount} é …é©—æ”¶æº–å‰‡ (AC) æœªå®Œæˆï¼Œç„¡æ³•æ¨™è¨˜ç‚ºã€Œå®Œæˆã€ï¼\n\nè«‹å‹™å¿…å®Œæˆæ‰€æœ‰é©—æ”¶æ¢ä»¶ã€‚`;

                if (isQuickMode) {
                    const confirmSwitch = window.confirm(`${msg}\n\næ˜¯å¦åˆ‡æ›è‡³å®Œæ•´æ¨¡å¼é€²è¡Œç¢ºèªï¼Ÿ`);
                    if (confirmSwitch) {
                        setIsQuickMode(false);
                        setCurrentStep(2); // AC åœ¨ Step 2
                    }
                } else {
                    alert(msg);
                    setCurrentStep(2);
                }
                return false;
            }
        }

        // 3. é©—è­‰å®Œæ•´æ¨¡å¼ä¸‹çš„ Step 2 (ä»»å‹™å®šç¾©) - æ”¹ç‚ºã€Œè»Ÿé™åˆ¶ (Soft Warning)ã€
        // é‡å° Epic æˆ– å¤§ Task (>5å¤©)ï¼Œå»ºè­°å¡«å¯«ä½†ä¸å¼·åˆ¶é˜»æ“‹
        if (!isQuickMode) {
            const missingFields = [];

            if (!formData.background || formData.background.length < 15) {
                missingFields.push('å•é¡ŒèƒŒæ™¯ (Background) - å»ºè­°è©³è¿°');
            }
            if (!formData.expectedResult) {
                missingFields.push('é æœŸçµæœ (Expected Result)');
            }

            // è‹¥æœ‰ç¼ºæ¼ï¼Œè·³å‡ºç¢ºèªè¦–çª—
            if (missingFields.length > 0) {
                const msg = `âš ï¸ ç‚ºäº†ç¢ºä¿ä»»å‹™å“è³ªï¼Œå»ºè­°å¡«å¯«ä»¥ä¸‹æ¬„ä½ï¼š\n\n${missingFields.map(f => `â€¢ ${f}`).join('\n')}\n\nç¢ºå®šè¦å¿½ç•¥ä¸¦å­˜æª”å—ï¼Ÿ`;
                const ignoreAndSave = window.confirm(msg);

                if (!ignoreAndSave) {
                    // ç”¨æˆ¶é¸æ“‡ã€Œå–æ¶ˆã€å»è£œå¡« -> è·³è½‰åˆ° Step 2
                    setCurrentStep(2);
                    return false;
                }
                // ç”¨æˆ¶é¸æ“‡ã€Œç¢ºå®šã€-> å…è¨±å­˜æª” (return true)
            }
        }

        return true;
    };

    const handleFormSubmit = (e) => {
        e.preventDefault();

        // åŸ·è¡Œæ‰‹å‹•é©—è­‰
        if (!validateForm()) return;

        // å»ºç«‹éš±è—çš„ form ä¸¦è§¸ç™¼ onSubmit
        const form = e.target;
        const formDataObj = new FormData(form);

        // å¡«å…¥æ‰€æœ‰ formData å€¼
        Object.entries(formData).forEach(([key, value]) => {
            if (typeof value === 'boolean') {
                if (value) formDataObj.set(key, 'on');
            } else {
                formDataObj.set(key, value);
            }
        });

        onSubmit(e);
    };

    if (!isOpen) return null;

    // ==================== Step å…§å®¹æ¸²æŸ“ ====================
    const renderStepContent = () => {
        switch (currentStep) {
            case 1:
                return renderStep1();
            case 2:
                return renderStep2();
            case 3:
                return renderStep3();
            case 4:
                return renderStep4();
            default:
                return null;
        }
    };

    // Step 1: åŸºæœ¬è³‡è¨Š
    const renderStep1 = () => (
        <div className="space-y-4">
            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                    ä»»å‹™å…§å®¹ <span className="text-red-500">*</span>
                </label>
                <input
                    name="task"
                    value={formData.task}
                    onChange={(e) => setFormData(prev => ({ ...prev, task: e.target.value }))}
                    required
                    className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                    placeholder="è«‹æè¿°è¦å®Œæˆçš„ä»»å‹™..."
                />
            </div>

            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                    å°ˆæ¡ˆ (Project) <span className="text-red-500">*</span>
                </label>
                <select
                    name="project"
                    value={formData.project}
                    onChange={(e) => setFormData(prev => ({ ...prev, project: e.target.value }))}
                    required
                    className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500"
                >
                    {PROJECTS.map(p => <option key={p} value={p}>{p}</option>)}
                </select>
            </div>

            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                    ç›®çš„ (Purpose)
                    <span className="text-xs text-slate-500 ml-1">(é¸å¡«)</span>
                </label>
                <input
                    list="purpose-suggestions"
                    name="purpose"
                    value={formData.purpose}
                    onChange={(e) => setFormData(prev => ({ ...prev, purpose: e.target.value }))}
                    placeholder="ä¾‹å¦‚: æ°´ç æ¼‚ç§»ã€ç”¢å“å“è³ªæå‡..."
                    className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                />
                <datalist id="purpose-suggestions">
                    {uniquePurposes.map(p => <option key={p} value={p} />)}
                </datalist>
            </div>
        </div>
    );

    // Step 2: ä»»å‹™å®šç¾© (åƒ…å®Œæ•´æ¨¡å¼)
    const renderStep2 = () => (
        <div className="space-y-4">
            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                    å•é¡ŒèƒŒæ™¯ (Background)
                    <span className="text-xs text-slate-500 ml-1">ç‚ºä»€éº¼è¦åšé€™å€‹ä»»å‹™ï¼Ÿ</span>
                </label>
                <textarea
                    name="background"
                    value={formData.background}
                    onChange={(e) => setFormData(prev => ({ ...prev, background: e.target.value }))}
                    rows="3"
                    placeholder="æè¿°å•é¡Œçš„èƒŒæ™¯ã€ç¾æ³ã€ç—›é»..."
                    className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                />
            </div>

            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                    é æœŸçµæœ (Expected Result)
                    <span className="text-xs text-slate-500 ml-1">å®Œæˆå¾Œæœƒæ˜¯ä»€éº¼æ¨£å­ï¼Ÿ</span>
                </label>
                <textarea
                    name="expectedResult"
                    value={formData.expectedResult}
                    onChange={(e) => setFormData(prev => ({ ...prev, expectedResult: e.target.value }))}
                    rows="2"
                    placeholder="ä¾‹å¦‚: æ°´ç æ¼‚ç§»å•é¡Œæ­¸é›¶ã€è‰¯ç‡æå‡è‡³ 95%..."
                    className="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                />
            </div>

            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                    é©—æ”¶æº–å‰‡ (Acceptance Criteria)
                    <span className="text-xs text-slate-500 ml-1">å¦‚ä½•åˆ¤æ–·ä»»å‹™å®Œæˆï¼Ÿ</span>
                </label>
                <div className="bg-slate-50 p-3 rounded-lg border space-y-2">
                    {acItems.map((item, index) => (
                        <div key={index} className="flex items-center gap-2 bg-white p-2 rounded border">
                            <input
                                type="checkbox"
                                checked={item.checked}
                                onChange={() => toggleAcItem(index)}
                                className="w-4 h-4 text-indigo-600"
                            />
                            <span className={`flex-1 text-sm ${item.checked ? 'line-through text-slate-400' : ''}`}>
                                {item.content}
                            </span>
                            <button
                                type="button"
                                onClick={() => removeAcItem(index)}
                                className="text-red-400 hover:text-red-600 text-xs"
                            >
                                åˆªé™¤
                            </button>
                        </div>
                    ))}
                    <div className="flex gap-2">
                        <input
                            type="text"
                            value={newAcItem}
                            onChange={(e) => setNewAcItem(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addAcItem())}
                            placeholder="æ–°å¢é©—æ”¶æ¢ä»¶..."
                            className="flex-1 border rounded p-2 text-sm"
                        />
                        <button
                            type="button"
                            onClick={addAcItem}
                            className="px-3 py-2 bg-indigo-100 text-indigo-600 rounded text-sm hover:bg-indigo-200"
                        >
                            + æ–°å¢
                        </button>
                    </div>
                    <p className="text-xs text-slate-500">ğŸ’¡ æç¤ºï¼šé©—æ”¶æ™‚éœ€å‹¾é¸æ‰€æœ‰æ¢ä»¶æ‰èƒ½æ¨™è¨˜ç‚ºå®Œæˆ</p>
                </div>
                {/* éš±è—æ¬„ä½å„²å­˜ AC */}
                <input type="hidden" name="acceptanceCriteria" value={formData.acceptanceCriteria} />
            </div>
        </div>
    );

    // Step 3: è² è²¬æŒ‡æ´¾
    const renderStep3 = () => (
        <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">
                        éƒ¨é–€ (Team) <span className="text-red-500">*</span>
                    </label>
                    <select
                        name="team"
                        value={formData.team}
                        onChange={(e) => handleTeamChange(e.target.value)}
                        className="w-full border rounded-lg p-2 text-sm"
                    >
                        {TEAMS.map(t => <option key={t} value={t}>{t}</option>)}
                    </select>
                </div>
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">
                        è² è²¬äºº (PIC) <span className="text-red-500">*</span>
                    </label>
                    <input
                        list="owners"
                        name="owner"
                        value={formData.owner}
                        onChange={(e) => setFormData(prev => ({ ...prev, owner: e.target.value }))}
                        required
                        className="w-full border rounded-lg p-2 text-sm"
                    />
                    <datalist id="owners">{OWNERS.map(o => <option key={o} value={o} />)}</datalist>
                </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">
                        å”åŠ©è€… (Assistants)
                        <span className="text-xs text-slate-500 ml-1">é€—è™Ÿåˆ†éš”</span>
                    </label>
                    <input
                        name="assistants"
                        value={formData.assistants}
                        onChange={(e) => setFormData(prev => ({ ...prev, assistants: e.target.value }))}
                        placeholder="ä¾‹å¦‚: Alice, Bob"
                        className="w-full border rounded-lg p-2 text-sm"
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">
                        é©—æ”¶äºº (Reviewer)
                        <span className="text-xs text-indigo-600 ml-1">âš¡ è‡ªå‹•å¸¶å…¥éƒ¨é–€ä¸»ç®¡</span>
                    </label>
                    <input
                        list="owners"
                        name="reviewer"
                        value={formData.reviewer}
                        onChange={(e) => setFormData(prev => ({ ...prev, reviewer: e.target.value }))}
                        placeholder="è² è²¬æ ¸å‡†é©—æ”¶çš„äºº"
                        className="w-full border rounded-lg p-2 text-sm bg-indigo-50"
                    />
                </div>
            </div>

            {/* Status & Priority - Moved to Step 3 for Quick Mode access */}
            <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">ç‹€æ…‹</label>
                    <select
                        name="status"
                        value={formData.status}
                        onChange={(e) => setFormData(prev => ({ ...prev, status: e.target.value }))}
                        className="w-full border rounded-lg p-2 text-sm"
                    >
                        {getStatusOptions().map(opt => (
                            <option key={opt.value} value={opt.value}>
                                {opt.label}
                            </option>
                        ))}
                    </select>
                </div>
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">å„ªå…ˆç´š</label>
                    <select
                        name="priority"
                        value={formData.priority}
                        onChange={(e) => setFormData(prev => ({ ...prev, priority: e.target.value }))}
                        className="w-full border rounded-lg p-2 text-sm"
                    >
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
            </div>

            <div className="grid grid-cols-3 gap-4">
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">Issue Date</label>
                    <input
                        type="date"
                        name="issueDate"
                        value={formData.issueDate}
                        onChange={(e) => setFormData(prev => ({ ...prev, issueDate: e.target.value }))}
                        className="w-full border rounded-lg p-2 text-sm"
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">
                        å®Œæˆæ—¥ <span className="text-red-500">*</span>
                        {!canDirectEdit && editingTask && <span className="text-xs text-amber-600 ml-1">(è®Šæ›´éœ€å¯©æ ¸)</span>}
                    </label>
                    <input
                        type="date"
                        name="date"
                        value={formData.date}
                        onChange={(e) => handleDateChange(e.target.value)}
                        required
                        className={`w-full border rounded-lg p-2 text-sm ${dateChanged && !canDirectEdit ? 'border-amber-400 bg-amber-50' : ''}`}
                    />
                </div>
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">å·¥æ™‚ (å¤©)</label>
                    <input
                        type="number"
                        name="duration"
                        value={formData.duration}
                        onChange={(e) => setFormData(prev => ({ ...prev, duration: parseInt(e.target.value) || 1 }))}
                        min="1"
                        className="w-full border rounded-lg p-2 text-sm"
                    />
                </div>
            </div>

            {dateChanged && !canDirectEdit && (
                <div className="bg-amber-50 p-3 rounded-lg border border-amber-200">
                    <p className="text-xs text-amber-600">âš ï¸ æ™‚ç¨‹è®Šæ›´å°‡é€å‡ºå¯©æ ¸ç”³è«‹</p>
                    <input
                        name="dateChangeReason"
                        placeholder="è«‹å¡«å¯«è®Šæ›´åŸå› ..."
                        className="w-full border rounded p-2 text-sm mt-2"
                    />
                </div>
            )}
        </div>
    );

    // Step 4: é©—æ”¶è¨­å®š (åƒ…å®Œæ•´æ¨¡å¼)
    const renderStep4 = () => (
        <div className="space-y-4">

            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">é©—è­‰æ–¹å¼ (Verification)</label>
                <textarea
                    name="verification"
                    value={formData.verification}
                    onChange={(e) => setFormData(prev => ({ ...prev, verification: e.target.value }))}
                    rows="2"
                    placeholder="å¦‚ä½•é©—è­‰æ­¤ä»»å‹™å·²å®Œæˆï¼Ÿ"
                    className="w-full border rounded-lg p-2 text-sm"
                />
            </div>

            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">å‚™è¨» (Notes)</label>
                <textarea
                    name="notes"
                    value={formData.notes}
                    onChange={(e) => setFormData(prev => ({ ...prev, notes: e.target.value }))}
                    rows="2"
                    placeholder="å…¶ä»–èªªæ˜..."
                    className="w-full border rounded-lg p-2 text-sm"
                />
            </div>

            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                    å‰ç½®ä»»å‹™ (Dependency)
                    <span className="text-xs text-slate-500 ml-1">å¤šå€‹è«‹ç”¨é€—è™Ÿåˆ†éš”</span>
                </label>
                <input
                    name="dependency"
                    value={formData.dependency}
                    onChange={(e) => setFormData(prev => ({ ...prev, dependency: e.target.value }))}
                    placeholder="ä¾‹å¦‚: CHIP-2026-01-0001, SW-2026-01-0002"
                    className="w-full border rounded-lg p-2 text-sm"
                />
            </div>

            <div className="bg-slate-50 p-3 rounded-lg border space-y-2">
                <div className="flex items-center gap-3">
                    <input
                        type="checkbox"
                        name="isCheckpoint"
                        id="isCheckpoint"
                        checked={formData.isCheckpoint}
                        onChange={(e) => setFormData(prev => ({ ...prev, isCheckpoint: e.target.checked }))}
                        className="w-4 h-4 text-indigo-600"
                    />
                    <label htmlFor="isCheckpoint" className="text-sm font-medium text-slate-700">
                        ğŸš© è¨­ç‚ºæª¢æŸ¥é» (Checkpoint)
                    </label>
                </div>
                <div className="flex items-center gap-3">
                    <input
                        type="checkbox"
                        name="issuePool"
                        id="issuePool"
                        checked={formData.issuePool}
                        onChange={(e) => setFormData(prev => ({ ...prev, issuePool: e.target.checked }))}
                        className="w-4 h-4 text-indigo-600"
                    />
                    <label htmlFor="issuePool" className="text-sm font-medium text-slate-700">
                        ğŸ”– åŠ å…¥ Issue èªé ˜å€
                    </label>
                </div>
            </div>


            {/* é©—æ”¶å ±å‘Š (Lite ç‰ˆæœ¬ä¸æ”¯æ´æª”æ¡ˆä¸Šå‚³) */}
            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                    é©—æ”¶å ±å‘Š
                    <span className="text-xs text-slate-500 ml-1">(Lite ç‰ˆæœ¬)</span>
                </label>
                <div className="bg-slate-100 border-2 border-dashed border-slate-300 rounded-lg p-4 text-center">
                    <p className="text-sm text-slate-500">ğŸ“ æª”æ¡ˆä¸Šå‚³åŠŸèƒ½åœ¨ Lite ç‰ˆæœ¬ä¸­æœªå•Ÿç”¨</p>
                    <p className="text-xs text-slate-400 mt-1">è«‹åƒè€ƒ docs/FEATURE_DRIVE_UPLOAD.md äº†è§£å¦‚ä½•å•Ÿç”¨</p>
                </div>
            </div>

            {/* éš±è—æ¬„ä½ */}
            <input type="hidden" name="taskType" value={formData.taskType} />
            <input type="hidden" name="recurringCycle" value={formData.recurringCycle} />
            <input type="hidden" name="verificationFiles" value={formData.verificationFiles} />
        </div>
    );

    // ==================== Step Indicator ====================
    const renderStepIndicator = () => {
        const steps = isQuickMode
            ? [{ num: 1, label: 'åŸºæœ¬è³‡è¨Š' }, { num: 3, label: 'è² è²¬æŒ‡æ´¾' }]
            : [
                { num: 1, label: 'åŸºæœ¬è³‡è¨Š' },
                { num: 2, label: 'ä»»å‹™å®šç¾©' },
                { num: 3, label: 'è² è²¬æŒ‡æ´¾' },
                { num: 4, label: 'é©—æ”¶è¨­å®š' }
            ];

        return (
            <div className="flex items-center justify-center gap-2 mb-4">
                {steps.map((step, idx) => (
                    <React.Fragment key={step.num}>
                        <div
                            onClick={() => setCurrentStep(step.num)}
                            className={`flex items-center justify-center w-8 h-8 rounded-full text-sm font-medium transition-colors cursor-pointer hover:bg-indigo-50
                                ${currentStep === step.num
                                    ? 'bg-indigo-600 text-white hover:bg-indigo-700'
                                    : currentStep > step.num
                                        ? 'bg-indigo-100 text-indigo-600'
                                        : 'bg-slate-100 text-slate-400'}`}
                        >
                            {currentStep > step.num ? 'âœ“' : step.num}
                        </div>
                        {idx < steps.length - 1 && (
                            <div className={`w-12 h-1 rounded ${currentStep > step.num ? 'bg-indigo-300' : 'bg-slate-200'}`} />
                        )}
                    </React.Fragment>
                ))}
            </div>
        );
    };

    // ==================== ä¸»è¦æ¸²æŸ“ ====================
    return (
        <div
            className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
            role="dialog"
            aria-modal="true"
        >
            <div className="bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] animate-fade-in overflow-hidden flex flex-col">
                {/* Header */}
                <div className="p-4 border-b flex justify-between items-center bg-slate-50 flex-shrink-0">
                    <div>
                        <h3 className="font-bold text-slate-800">
                            {editingTask ? 'ç·¨è¼¯ä»»å‹™' : 'æ–°å¢ä»»å‹™'}
                        </h3>
                        <div className="flex items-center gap-2 mt-1">
                            <span className="text-xs text-slate-500">
                                Step {isQuickMode ? (currentStep === 1 ? 1 : 2) : currentStep} / {totalSteps}
                            </span>
                            {!forceFullMode && (
                                <button
                                    type="button"
                                    onClick={() => setIsQuickMode(!isQuickMode)}
                                    className="text-xs text-indigo-600 hover:underline"
                                >
                                    {isQuickMode ? 'å±•é–‹å®Œæ•´è¡¨å–® â–¼' : 'æ”¶åˆ â–²'}
                                </button>
                            )}
                            {forceFullMode && (
                                <span className="text-xs text-amber-600">âš ï¸ æ­¤ä»»å‹™éœ€å®Œæ•´å¡«å¯«</span>
                            )}
                        </div>
                    </div>
                    <button
                        onClick={onClose}
                        className="text-slate-400 hover:text-slate-600"
                        aria-label="é—œé–‰"
                    >
                        <Icon path={paths.x} />
                    </button>
                </div>

                {/* Step Indicator */}
                <div className="px-6 pt-4">
                    {renderStepIndicator()}
                </div>

                {/* Form Content */}
                <div className="overflow-y-auto flex-1 px-6 pb-4">
                    <form onSubmit={handleFormSubmit} id="task-form">
                        {renderStepContent()}

                        {/* éš±è—æ¬„ä½ - ç¢ºä¿æ‰€æœ‰è³‡æ–™éƒ½åœ¨ DOM ä¸­å¯è¢« FormData å–å¾— */}
                        {/* Step 1 æ¬„ä½ */}
                        <input type="hidden" name="task" value={formData.task || ''} />
                        <input type="hidden" name="project" value={formData.project || ''} />
                        <input type="hidden" name="purpose" value={formData.purpose || ''} />

                        {/* Step 2 æ¬„ä½ (å®Œæ•´æ¨¡å¼) */}
                        <input type="hidden" name="background" value={formData.background || ''} />
                        <input type="hidden" name="expectedResult" value={formData.expectedResult || ''} />
                        <input type="hidden" name="acceptanceCriteria" value={formData.acceptanceCriteria || ''} />

                        {/* Step 3 æ¬„ä½ */}
                        <input type="hidden" name="team" value={formData.team || ''} />
                        <input type="hidden" name="owner" value={formData.owner || ''} />
                        <input type="hidden" name="assistants" value={formData.assistants || ''} />
                        <input type="hidden" name="reviewer" value={formData.reviewer || ''} />
                        <input type="hidden" name="issueDate" value={formData.issueDate || ''} />
                        <input type="hidden" name="startDate" value={formData.startDate || ''} />
                        <input type="hidden" name="date" value={formData.date || ''} />
                        <input type="hidden" name="duration" value={formData.duration || 1} />

                        {/* Step 4 æ¬„ä½ (å®Œæ•´æ¨¡å¼) */}
                        <input type="hidden" name="status" value={formData.status || 'Todo'} />
                        <input type="hidden" name="priority" value={formData.priority || 'Medium'} />
                        <input type="hidden" name="verification" value={formData.verification || ''} />
                        <input type="hidden" name="notes" value={formData.notes || ''} />
                        <input type="hidden" name="dependency" value={formData.dependency || ''} />
                        <input type="hidden" name="isCheckpoint" value={formData.isCheckpoint ? 'on' : ''} />
                        <input type="hidden" name="issuePool" value={formData.issuePool ? 'on' : ''} />
                        <input type="hidden" name="taskType" value={formData.taskType || 'one-time'} />
                        <input type="hidden" name="recurringCycle" value={formData.recurringCycle || ''} />
                        <input type="hidden" name="verificationFiles" value={formData.verificationFiles || '[]'} />
                    </form>
                </div>

                {/* Footer - Navigation Buttons */}
                <div className="p-4 border-t bg-white flex justify-between items-center flex-shrink-0">
                    <div>
                        {currentStep > 1 && (
                            <button
                                type="button"
                                onClick={handlePrev}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm"
                            >
                                â† ä¸Šä¸€æ­¥
                            </button>
                        )}
                    </div>
                    <div className="flex gap-2">
                        <button
                            type="button"
                            onClick={onClose}
                            className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm"
                        >
                            å–æ¶ˆ
                        </button>

                        {isLastStep ? (
                            // æœ€å¾Œä¸€æ­¥é¡¯ç¤ºå„²å­˜æŒ‰éˆ•
                            dateChanged && !canDirectEdit && editingTask ? (
                                <button
                                    type="button"
                                    onClick={() => {
                                        if (onSubmitDateChangeRequest) {
                                            onSubmitDateChangeRequest({
                                                taskId: editingTask.id,
                                                newDate: formData.date,
                                                reason: document.querySelector('[name="dateChangeReason"]')?.value || ''
                                            });
                                        }
                                    }}
                                    className="px-4 py-2 bg-amber-500 text-white rounded-lg text-sm font-medium hover:bg-amber-600"
                                >
                                    ğŸ“ ç”³è«‹æ™‚ç¨‹è®Šæ›´
                                </button>
                            ) : (
                                <button
                                    type="submit"
                                    form="task-form"
                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700"
                                >
                                    ğŸ’¾ å„²å­˜
                                </button>
                            )
                        ) : (
                            // éæœ€å¾Œä¸€æ­¥é¡¯ç¤ºä¸‹ä¸€æ­¥æŒ‰éˆ•
                            <button
                                type="button"
                                onClick={handleNext}
                                className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700"
                            >
                                ä¸‹ä¸€æ­¥ â†’
                            </button>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

window.TaskModal = TaskModal;

</script>
    <script type="text/babel">
// ContextMenu Component - å³éµé¸å–®çµ„ä»¶
// åŠŸèƒ½: ç·¨è¼¯ / åˆªé™¤ / è¤‡è£½ID / ç‹€æ…‹åˆ‡æ›

const ContextMenu = ({ task, position, onClose, onEdit, onDelete, onChangeStatus, onCopyId, canDelete = true }) => {
    const menuRef = React.useRef(null);

    // é»æ“Šå¤–éƒ¨é—œé–‰é¸å–®
    React.useEffect(() => {
        const handleClickOutside = (e) => {
            if (menuRef.current && !menuRef.current.contains(e.target)) {
                onClose();
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [onClose]);

    // ESC é—œé–‰é¸å–®
    React.useEffect(() => {
        const handleKeyDown = (e) => {
            if (e.key === 'Escape') onClose();
        };
        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
    }, [onClose]);

    if (!task || !position) return null;

    const menuItems = [
        {
            icon: 'âœï¸',
            label: 'ç·¨è¼¯ä»»å‹™',
            onClick: () => { onEdit(task); onClose(); }
        },
        {
            icon: 'ğŸ“‹',
            label: 'è¤‡è£½ Task ID',
            onClick: () => { onCopyId(task.id); onClose(); }
        },
        { type: 'divider' },
        {
            icon: 'â¸ï¸',
            label: 'æ¨™è¨˜ç‚ºå¾…è¾¦',
            onClick: () => { onChangeStatus(task, 'Todo'); onClose(); },
            disabled: task.status === 'Todo'
        },
        {
            icon: 'â–¶ï¸',
            label: 'æ¨™è¨˜ç‚ºé€²è¡Œä¸­',
            onClick: () => { onChangeStatus(task, 'InProgress'); onClose(); },
            disabled: task.status === 'InProgress'
        },
        {
            icon: 'âœ…',
            label: 'æ¨™è¨˜ç‚ºå®Œæˆ',
            onClick: () => { onChangeStatus(task, 'Done'); onClose(); },
            disabled: task.status === 'Done'
        },
        // åªæœ‰æœ‰åˆªé™¤æ¬Šé™æ™‚æ‰é¡¯ç¤ºåˆªé™¤é¸é …
        ...(canDelete ? [
            { type: 'divider' },
            {
                icon: 'ğŸ—‘ï¸',
                label: 'åˆªé™¤ä»»å‹™',
                onClick: () => { onDelete(task.id); onClose(); },
                danger: true
            }
        ] : [])
    ];

    return (
        <div
            ref={menuRef}
            className="fixed bg-white rounded-lg shadow-xl border border-slate-200 py-1 z-50 min-w-48"
            style={{
                left: Math.min(position.x, window.innerWidth - 200),
                top: Math.min(position.y, window.innerHeight - 300)
            }}
        >
            {menuItems.map((item, index) => {
                if (item.type === 'divider') {
                    return <div key={index} className="border-t border-slate-200 my-1" />;
                }
                return (
                    <button
                        key={index}
                        onClick={item.onClick}
                        disabled={item.disabled}
                        className={`w-full px-4 py-2 text-left text-sm flex items-center gap-3 transition-colors
                            ${item.disabled
                                ? 'text-slate-300 cursor-not-allowed'
                                : item.danger
                                    ? 'text-red-600 hover:bg-red-50'
                                    : 'text-slate-700 hover:bg-slate-100'
                            }`}
                    >
                        <span className="text-base">{item.icon}</span>
                        <span>{item.label}</span>
                    </button>
                );
            })}
        </div>
    );
};

window.ContextMenu = ContextMenu;

</script>
    <script type="text/babel">
// SearchInput Component
// æœå°‹è‡ªå‹•å®Œæˆå…ƒä»¶ - é¡ä¼¼ Google æœå°‹çš„å‰ç¶´æç¤ºåŠŸèƒ½
// Props: value, onChange, tasks, TEAMS, PROJECTS, OWNERS

const SearchInput = ({ value, onChange, tasks, TEAMS, PROJECTS, OWNERS }) => {
    const { useState, useEffect, useRef, useMemo } = React;

    const [showSuggestions, setShowSuggestions] = useState(false);
    const [selectedIndex, setSelectedIndex] = useState(0);
    const inputRef = useRef(null);
    const suggestionsRef = useRef(null);

    // æ”¯æ´çš„å‰ç¶´é¡å‹
    const PREFIXES = ['project:', 'purpose:', 'owner:', 'team:', 'task:', 'note:', 'status:'];

    // æ”¯æ´çš„ç‹€æ…‹å€¼
    const STATUS_VALUES = ['Todo', 'InProgress', 'Done', 'Pending', 'Closed'];

    // å¾ä»»å‹™ä¸­æå–å”¯ä¸€çš„ Purpose å€¼
    const uniquePurposes = useMemo(() => {
        if (!tasks) return [];
        return [...new Set(tasks.map(t => t.purpose).filter(Boolean))].sort();
    }, [tasks]);

    // å¾ä»»å‹™ä¸­æå–å”¯ä¸€çš„ Owner å€¼
    const uniqueOwners = useMemo(() => {
        if (!tasks) return [];
        const taskOwners = tasks.map(t => t.owner).filter(Boolean);
        const allOwners = [...new Set([...taskOwners, ...(OWNERS || [])])];
        return allOwners.sort();
    }, [tasks, OWNERS]);

    // åˆ†æè¼¸å…¥ä¸¦ç”¢ç”Ÿå»ºè­°
    const suggestions = useMemo(() => {
        if (!value) {
            // ç©ºå€¼æ™‚é¡¯ç¤ºå¯ç”¨çš„å‰ç¶´æç¤º
            return [];
        }

        const lowerValue = value.toLowerCase();

        // æª¢æŸ¥æ˜¯å¦æ­£åœ¨è¼¸å…¥å‰ç¶´
        const partialPrefixMatch = PREFIXES.find(p =>
            p.startsWith(lowerValue) && p !== lowerValue
        );

        if (partialPrefixMatch && lowerValue.length > 0 && !lowerValue.includes(':')) {
            // ä½¿ç”¨è€…æ­£åœ¨è¼¸å…¥å‰ç¶´ï¼Œé¡¯ç¤ºå¯èƒ½çš„å‰ç¶´
            return PREFIXES
                .filter(p => p.startsWith(lowerValue))
                .map(p => ({ type: 'prefix', value: p, display: p }));
        }

        // æª¢æŸ¥æ˜¯å¦å·²è¼¸å…¥å®Œæ•´å‰ç¶´
        const prefixMatch = value.match(/^(project|purpose|owner|team|task|note|status):(.*)$/i);

        if (prefixMatch) {
            const field = prefixMatch[1].toLowerCase();
            const partial = prefixMatch[2].toLowerCase();

            let items = [];
            switch (field) {
                case 'project':
                    items = (PROJECTS || []).filter(p =>
                        p && p.toLowerCase().includes(partial)
                    );
                    break;
                case 'purpose':
                    items = uniquePurposes.filter(p =>
                        p.toLowerCase().includes(partial)
                    );
                    break;
                case 'owner':
                    items = uniqueOwners.filter(o =>
                        o && o.toLowerCase().includes(partial)
                    );
                    break;
                case 'team':
                    items = (TEAMS || []).filter(t =>
                        t && t.toLowerCase().includes(partial)
                    );
                    break;
                case 'status':
                    items = STATUS_VALUES.filter(s =>
                        s.toLowerCase().includes(partial)
                    );
                    break;
                default:
                    items = [];
            }

            return items.slice(0, 8).map(item => ({
                type: 'value',
                value: `${field}:${item}`,
                display: item,
                field: field
            }));
        }

        return [];
    }, [value, PROJECTS, TEAMS, uniquePurposes, uniqueOwners]);

    // æ˜¯å¦é¡¯ç¤ºå»ºè­°æ¸…å–®
    useEffect(() => {
        setShowSuggestions(suggestions.length > 0);
        setSelectedIndex(0);
    }, [suggestions]);

    // é»æ“Šå¤–éƒ¨é—œé–‰å»ºè­°
    useEffect(() => {
        const handleClickOutside = (e) => {
            if (inputRef.current && !inputRef.current.contains(e.target) &&
                suggestionsRef.current && !suggestionsRef.current.contains(e.target)) {
                setShowSuggestions(false);
            }
        };

        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    // é¸å–å»ºè­°
    const selectSuggestion = (suggestion) => {
        onChange(suggestion.value);
        setShowSuggestions(false);
        inputRef.current?.focus();
    };

    // éµç›¤å°èˆª
    const handleKeyDown = (e) => {
        if (!showSuggestions || suggestions.length === 0) return;

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                setSelectedIndex(prev =>
                    prev < suggestions.length - 1 ? prev + 1 : 0
                );
                break;
            case 'ArrowUp':
                e.preventDefault();
                setSelectedIndex(prev =>
                    prev > 0 ? prev - 1 : suggestions.length - 1
                );
                break;
            case 'Enter':
                if (showSuggestions && suggestions[selectedIndex]) {
                    e.preventDefault();
                    selectSuggestion(suggestions[selectedIndex]);
                }
                break;
            case 'Escape':
                setShowSuggestions(false);
                break;
        }
    };

    // å–å¾—å‰ç¶´çš„ä¸­æ–‡æ¨™ç±¤
    const getPrefixLabel = (prefix) => {
        const labels = {
            'project:': 'å°ˆæ¡ˆ',
            'purpose:': 'ç›®çš„',
            'owner:': 'è² è²¬äºº',
            'team:': 'éƒ¨é–€',
            'task:': 'ä»»å‹™',
            'note:': 'å‚™è¨»',
            'status:': 'ç‹€æ…‹'
        };
        return labels[prefix] || prefix;
    };

    return (
        <div className="relative w-full">
            {/* æœå°‹è¼¸å…¥æ¡† */}
            <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400">
                <Icon path={paths.search} size={16} />
            </div>
            <input
                ref={inputRef}
                type="text"
                value={value}
                onChange={(e) => onChange(e.target.value)}
                onKeyDown={handleKeyDown}
                onFocus={() => suggestions.length > 0 && setShowSuggestions(true)}
                placeholder="æœå°‹ä»»å‹™ã€è² è²¬äººã€å‚™è¨»... (è¼¸å…¥ project: æˆ– purpose: é€²éšæœå°‹)"
                className="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none shadow-sm h-10"
            />
            {value && (
                <button
                    onClick={() => { onChange(''); setShowSuggestions(false); }}
                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600"
                >
                    <Icon path={paths.x} size={16} />
                </button>
            )}

            {/* å»ºè­°æ¸…å–® */}
            {showSuggestions && suggestions.length > 0 && (
                <div
                    ref={suggestionsRef}
                    className="absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"
                >
                    <div className="px-3 py-2 text-xs text-slate-500 border-b bg-slate-50 font-medium">
                        {suggestions[0]?.type === 'prefix' ? 'ğŸ’¡ å¯ç”¨çš„æœå°‹å‰ç¶´' : 'ğŸ“‹ å»ºè­°é¸é …'}
                    </div>
                    {suggestions.map((suggestion, index) => (
                        <div
                            key={suggestion.value}
                            onClick={() => selectSuggestion(suggestion)}
                            className={`px-3 py-2 cursor-pointer flex items-center gap-2 transition-colors ${index === selectedIndex
                                ? 'bg-indigo-50 text-indigo-700'
                                : 'hover:bg-slate-50'
                                }`}
                        >
                            {suggestion.type === 'prefix' ? (
                                <>
                                    <span className="text-indigo-500 font-mono text-sm">{suggestion.value}</span>
                                    <span className="text-slate-400 text-xs">- æœå°‹{getPrefixLabel(suggestion.value)}</span>
                                </>
                            ) : (
                                <>
                                    <span className="text-xs text-slate-400 font-mono bg-slate-100 px-1.5 py-0.5 rounded">
                                        {suggestion.field}:
                                    </span>
                                    <span className="font-medium">{suggestion.display}</span>
                                </>
                            )}
                        </div>
                    ))}
                    <div className="px-3 py-1.5 text-[10px] text-slate-400 border-t bg-slate-50">
                        â†‘â†“ é¸æ“‡ â€¢ Enter ç¢ºèª â€¢ Esc é—œé–‰
                    </div>
                </div>
            )}
        </div>
    );
};

window.SearchInput = SearchInput;

</script>
    <script type="text/babel">
// Dashboard Component
// Props: tasks, filteredTasks, stats, filterTeam, setFilterTeam, filterProject, setFilterProject, filterStat, toggleStatFilter, searchQuery, setSearchQuery, hideCompleted, setHideCompleted, highlightUrgent, setHighlightUrgent, setEditingTask, setIsModalOpen, handleDelete, TEAMS, PROJECTS, chartData, isLoading, todayStr
// éœ€å¼•å…¥: React, Recharts, Icon, paths, helpers.js

const Dashboard = () => {
    const {
        // Data
        tasks,
        filteredTasks,
        stats,
        chartData,
        isLoading,
        TEAMS,
        PROJECTS,
        OWNERS,
        todayStr,

        // State / Setters
        filterTeam,
        setFilterTeam,
        filterProject,
        setFilterProject,
        filterStat,
        toggleStatFilter,
        searchQuery,
        setSearchQuery,
        hideCompleted,
        setHideCompleted,
        highlightUrgent,
        setHighlightUrgent,
        setEditingTask,
        setIsModalOpen,
        handleDelete,
        handleSave,
        updateTaskStatus,

        // Auth
        user,
        hasPermission,

        // Alerts
        alerts
    } = useAppContext();

    // ç‹€æ…‹å¾ªç’°åˆ‡æ›å‡½æ•¸
    const cycleStatus = (task) => {
        const statusOrder = ['Todo', 'InProgress', 'Done'];
        const currentIndex = statusOrder.indexOf(task.status);
        const nextStatus = statusOrder[(currentIndex + 1) % statusOrder.length];
        updateTaskStatus(task, nextStatus);
    };

    // å±•é–‹è¡Œç‹€æ…‹
    const [expandedRow, setExpandedRow] = React.useState(null);

    // ç·Šå¯†æ¨¡å¼ç‹€æ…‹ (å¾ localStorage è®€å–)
    const [compactMode, setCompactMode] = React.useState(() => {
        const saved = localStorage.getItem('compactMode');
        return saved === 'true';
    });

    // ç·Šå¯†æ¨¡å¼åˆ‡æ›æ™‚å„²å­˜åˆ° localStorage
    const toggleCompactMode = () => {
        const newValue = !compactMode;
        setCompactMode(newValue);
        localStorage.setItem('compactMode', String(newValue));
    };

    // å³éµé¸å–®ç‹€æ…‹
    const [contextMenu, setContextMenu] = React.useState({ visible: false, task: null, position: { x: 0, y: 0 } });

    // å³éµé¸å–®è™•ç†
    const handleContextMenu = (e, task) => {
        e.preventDefault();
        setContextMenu({
            visible: true,
            task: task,
            position: { x: e.clientX, y: e.clientY }
        });
    };

    // é—œé–‰å³éµé¸å–®
    const closeContextMenu = () => {
        setContextMenu({ visible: false, task: null, position: { x: 0, y: 0 } });
    };

    // è®Šæ›´ç‹€æ…‹ (å³éµé¸å–®ç”¨)
    const changeStatus = (task, newStatus) => {
        updateTaskStatus(task, newStatus);
    };

    // è¤‡è£½ Task ID
    const copyTaskId = (id) => {
        navigator.clipboard.writeText(String(id)).then(() => {
            // å¯ä»¥åŠ å…¥ toast é€šçŸ¥
            console.log('âœ… å·²è¤‡è£½ Task ID:', id);
        }).catch(err => {
            console.error('è¤‡è£½å¤±æ•—:', err);
        });
    };

    const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } = window.Recharts || {};

    return (
        <div className="space-y-4">
            {/* Stat Cards - 1è¡Œç·Šæ¹Šç‰ˆ */}
            <div className="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4">
                {[
                    { label: 'ç¸½ä»»å‹™', val: stats.total, color: 'text-slate-800', bgGradient: 'from-slate-50 to-slate-100', icon: 'ğŸ“Š', type: null },
                    { label: 'æª¢æŸ¥é»', val: stats.checkpoints, color: 'text-indigo-600', bgGradient: 'from-indigo-50 to-indigo-100', icon: 'ğŸ“', type: 'Checkpoints' },
                    { label: 'å¾…è¾¦æ€¥ä»¶', val: stats.pendingHigh, color: 'text-orange-600', bgGradient: 'from-orange-50 to-orange-100', icon: 'âš¡', type: 'Urgent' },
                    { label: 'æ‡‰é–‹å·¥æœªå‹•', val: stats.lateStart, color: 'text-red-600', bgGradient: 'from-red-50 to-red-100', icon: 'â°', type: 'LateStart' },
                    { label: 'å·²é€¾æœŸ', val: stats.delayed, color: 'text-rose-600', bgGradient: 'from-rose-50 to-rose-100', icon: 'âŒ', type: 'Delayed' },
                    { label: 'å·²å®Œæˆ', val: stats.completed, color: 'text-green-600', bgGradient: 'from-green-50 to-green-100', icon: 'âœ“', type: 'Completed' }
                ].map((s, i) => (
                    <button
                        key={i}
                        onClick={() => s.type !== undefined && toggleStatFilter(s.type)}
                        className={`bg-gradient-to-br ${s.bgGradient} p-4 rounded-lg border-2 shadow-md text-left transition-all duration-200 hover:shadow-xl hover:-translate-y-1 hover:scale-105 ${filterStat === s.type
                            ? 'ring-2 ring-indigo-500 border-indigo-300'
                            : 'border-transparent hover:border-slate-200'
                            }`}
                    >
                        <div className="flex items-center justify-between mb-1.5">
                            <div className="text-xs text-slate-600 font-medium">{s.label}</div>
                            <div className="text-xl">{s.icon}</div>
                        </div>
                        <div className={`text-3xl font-bold ${s.color}`}>{s.val}</div>
                    </button>
                ))}
            </div>

            {/* ç¯©é¸èˆ‡æœå°‹å€ - å„ªåŒ–å¸ƒå±€ */}
            <div className="space-y-3">
                {/* ç¬¬ä¸€è¡Œ: Team ç¯©é¸æŒ‰éˆ• */}
                <div className="flex flex-wrap gap-2 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                    {['All', ...TEAMS].map(t => (
                        <button
                            key={t}
                            onClick={() => setFilterTeam(t)}
                            className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all whitespace-nowrap ${filterTeam === t
                                ? 'bg-slate-800 text-white shadow-md'
                                : 'text-slate-600 hover:bg-slate-100 hover:shadow-sm'
                                }`}
                        >
                            {t}
                        </button>
                    ))}
                </div>

                {/* ç¬¬äºŒè¡Œ: åŠŸèƒ½æ§åˆ¶åˆ— (æœå°‹ + é–‹é—œ) */}
                <div className="flex flex-col md:flex-row gap-3">
                    {/* æœå°‹æ¡† */}
                    <div className="flex-1">
                        <SearchInput
                            value={searchQuery}
                            onChange={setSearchQuery}
                            tasks={tasks}
                            TEAMS={TEAMS}
                            PROJECTS={PROJECTS}
                            OWNERS={OWNERS}
                        />
                    </div>

                    {/* æ§åˆ¶é–‹é—œç¾¤çµ„ */}
                    <div className="flex gap-3">
                        {/* éš±è—å·²å®Œæˆ/æ“±ç½® */}
                        <label className="flex items-center gap-2 text-sm bg-white px-3 py-2 rounded-lg border shadow-sm cursor-pointer whitespace-nowrap h-10 hover:bg-slate-50">
                            <input
                                type="checkbox"
                                checked={hideCompleted}
                                onChange={(e) => setHideCompleted(e.target.checked)}
                                className="w-4 h-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 focus:ring-2"
                            />
                            <span className="font-medium">éš±è—å·²å®Œæˆ/æ“±ç½®</span>
                        </label>

                        {/* é«˜äº®é–‹é—œ */}
                        <div className="flex items-center gap-2 text-sm bg-white px-3 py-2 rounded-lg border shadow-sm h-10 hover:bg-slate-50">
                            <input
                                type="checkbox"
                                id="highlightUrgent"
                                checked={highlightUrgent}
                                onChange={(e) => setHighlightUrgent(e.target.checked)}
                                className="rounded text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                            />
                            <label htmlFor="highlightUrgent" className="text-slate-600 cursor-pointer select-none whitespace-nowrap font-medium">
                                å¼·èª¿å»¶é²/æ‡‰é–‹å·¥
                            </label>
                        </div>

                        {/* ç·Šå¯†æ¨¡å¼åˆ‡æ› */}
                        <button
                            onClick={toggleCompactMode}
                            className={`flex items-center gap-2 text-sm px-3 py-2 rounded-lg border shadow-sm h-10 transition-colors whitespace-nowrap font-medium ${compactMode
                                ? 'bg-indigo-50 text-indigo-700 border-indigo-200 hover:bg-indigo-100'
                                : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'
                                }`}
                            title="åˆ‡æ›ç·Šå¯†/æ¨™æº–æ¨¡å¼"
                        >
                            {compactMode ? 'â‰¡' : 'â˜°'} {compactMode ? 'ç·Šå¯†' : 'æ¨™æº–'}
                        </button>

                        {/* åŒ¯å‡ºå¿«ç…§æŒ‰éˆ• */}
                        <button
                            onClick={() => exportSnapshot(tasks)}
                            className="flex items-center gap-2 text-sm bg-emerald-50 text-emerald-700 px-3 py-2 rounded-lg border border-emerald-200 shadow-sm h-10 hover:bg-emerald-100 transition-colors whitespace-nowrap font-medium"
                            title="åŒ¯å‡ºç•¶å‰ä»»å‹™æ¸…å–®ä½œç‚ºé€±å ±åŸºæº–å¿«ç…§"
                        >
                            <Icon path={paths.download || "M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"} size={16} />
                            ğŸ“¥ åŒ¯å‡ºå¿«ç…§
                        </button>
                    </div>
                </div>
            </div>

            {/* æœå°‹çµæœæç¤º */}
            {searchQuery && (
                <div className="px-4 py-3 bg-indigo-50 border border-indigo-200 rounded-lg flex items-center justify-between">
                    <span className="text-sm text-indigo-700 flex items-center gap-2">
                        <Icon path={paths.search} size={14} />
                        æœå°‹ã€Œ<strong>{searchQuery}</strong>ã€æ‰¾åˆ° <strong>{filteredTasks.length}</strong> å€‹çµæœ
                    </span>
                    <button
                        onClick={() => setSearchQuery('')}
                        className="text-indigo-600 hover:text-indigo-800 text-sm font-medium transition-colors"
                    >
                        æ¸…é™¤æœå°‹
                    </button>
                </div>
            )}

            {filteredTasks.length === 0 && !isLoading ? (
                <div className="p-12 text-center bg-white rounded-xl border shadow-sm">
                    <div className="text-slate-300 mb-4"><Icon path={paths.list} size={48} className="mx-auto" /></div>
                    <h3 className="text-lg font-bold text-slate-600 mb-2">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ä»»å‹™</h3>
                    <p className="text-slate-400">è«‹èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–æ–°å¢ä»»å‹™</p>
                </div>
            ) : (
                <>
                    {/* æ‰‹æ©Ÿç‰ˆï¼šå¡ç‰‡åˆ—è¡¨ */}
                    <div className="md:hidden space-y-3">
                        {filteredTasks.sort((a, b) => new Date(a.date) - new Date(b.date)).map(t => (
                            <div
                                key={t.id}
                                className={`bg-white rounded-lg border shadow-sm p-4 ${getRowHighlight(t, highlightUrgent, todayStr)}`}
                                onClick={() => { setEditingTask(t); setIsModalOpen(true); }}
                            >
                                <div className="flex items-start justify-between mb-2">
                                    {getTaskIdBadge(t.id)}
                                    <button
                                        onClick={(e) => { e.stopPropagation(); cycleStatus(t); }}
                                        className="hover:opacity-80"
                                    >
                                        {getStatusBadge(t, todayStr)}
                                    </button>
                                </div>
                                <h4 className="font-medium text-slate-900 mb-2 line-clamp-2">{t.task}</h4>
                                <div className="flex flex-wrap gap-2 mb-2">
                                    <span className={`text-[10px] px-2 py-0.5 rounded-full border font-medium ${getTeamBadgeClass(t.team)}`}>{t.team}</span>
                                    {t.project && <span className={`text-[10px] px-2 py-0.5 rounded-md border font-medium ${getProjectColor(t.project)}`}>{t.project}</span>}
                                    {getPriorityBadge(t.priority)}
                                </div>
                                <div className="flex items-center justify-between text-sm text-slate-600">
                                    <span>ğŸ“… {t.date}</span>
                                    <span>ğŸ‘¤ {getDisplayName(t.owner, OWNERS)}</span>
                                </div>
                                <div className="flex justify-end gap-2 mt-3 pt-3 border-t">
                                    <button
                                        onClick={(e) => { e.stopPropagation(); setEditingTask(t); setIsModalOpen(true); }}
                                        className="px-3 py-1.5 text-sm text-indigo-600 hover:bg-indigo-50 rounded-md transition-colors"
                                    >
                                        âœï¸ ç·¨è¼¯
                                    </button>
                                    <button
                                        onClick={(e) => { e.stopPropagation(); handleDelete(t.id); }}
                                        className="px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 rounded-md transition-colors"
                                    >
                                        ğŸ—‘ï¸ åˆªé™¤
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* æ¡Œæ©Ÿç‰ˆï¼šè¡¨æ ¼ */}
                    <div className="hidden md:block bg-white rounded-xl border-2 border-slate-200 shadow-md overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead className="bg-gradient-to-r from-slate-50 to-slate-100 border-b-2 border-slate-200">
                                    <tr>
                                        <th className={`px-4 ${compactMode ? 'py-2' : 'py-4'} text-left font-semibold text-slate-700 w-44`}>ID</th>
                                        <th className={`px-4 ${compactMode ? 'py-2' : 'py-4'} text-left font-semibold text-slate-700 ${compactMode ? 'w-48' : 'w-40'}`}>ç‹€æ…‹</th>
                                        <th className={`px-4 ${compactMode ? 'py-2' : 'py-4'} text-left font-semibold text-slate-700`}>ä»»å‹™</th>
                                        <th className={`px-4 ${compactMode ? 'py-2' : 'py-4'} text-left font-semibold text-slate-700 w-36`}>å·¥æ™‚/å»ºè­°é–‹å§‹</th>
                                        <th className={`px-4 ${compactMode ? 'py-2' : 'py-4'} text-left font-semibold text-slate-700 w-28`}>å®Œæˆæ—¥</th>
                                        <th className={`px-4 ${compactMode ? 'py-2' : 'py-4'} text-left font-semibold text-slate-700 w-20`}>è² è²¬äºº</th>
                                        <th className={`px-4 ${compactMode ? 'py-2' : 'py-4'} text-right font-semibold text-slate-700 w-24`}>å‹•ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-200">
                                    {filteredTasks.sort((a, b) => new Date(a.date) - new Date(b.date)).map(t => (
                                        <React.Fragment key={t.id}>
                                            <tr
                                                className={`hover:bg-slate-50 group transition-all duration-150 cursor-pointer ${t.isCheckpoint ? 'bg-indigo-50/50' : ''} ${getRowHighlight(t, highlightUrgent, todayStr)}`}
                                                tabIndex={0}
                                                onClick={() => setExpandedRow(expandedRow === t.id ? null : t.id)}
                                                onDoubleClick={() => { setEditingTask(t); setIsModalOpen(true); }}
                                                onContextMenu={(e) => handleContextMenu(e, t)}
                                                title="é»æ“Šå±•é–‹è©³æƒ… | é›™æ“Šç·¨è¼¯ | å³éµæ›´å¤šé¸é …"
                                            >
                                                <td className={`px-4 ${compactMode ? 'py-1.5' : 'py-4'}`}>
                                                    <div className="flex items-center gap-2">
                                                        <span className={`text-slate-400 transition-transform ${expandedRow === t.id ? 'rotate-90' : ''}`}>â–¶</span>
                                                        {getTaskIdBadge(t.id)}
                                                    </div>
                                                </td>
                                                <td className={`px-4 ${compactMode ? 'py-1.5' : 'py-4'}`}>
                                                    <div className={compactMode ? 'flex items-center gap-2 flex-wrap' : ''}>
                                                        <button
                                                            onClick={(e) => { e.stopPropagation(); cycleStatus(t); }}
                                                            className="hover:opacity-80 transition-opacity"
                                                            title="é»æ“Šåˆ‡æ›ç‹€æ…‹"
                                                        >
                                                            {getStatusBadge(t, todayStr)}
                                                        </button>
                                                        <div className={`text-[10px] ${compactMode ? '' : 'mt-1.5'} px-2 py-0.5 w-fit rounded-full border font-medium ${getTeamBadgeClass(t.team)}`}>{t.team}</div>
                                                        {t.project && <div className={`text-[10px] ${compactMode ? '' : 'mt-1'} px-2 py-0.5 w-fit rounded-md border font-medium ${getProjectColor(t.project)}`}>{t.project}</div>}
                                                    </div>
                                                </td>
                                                <td className={`px-4 ${compactMode ? 'py-1.5' : 'py-4'}`}>
                                                    <div className="font-medium text-slate-900 flex items-center gap-2">
                                                        {t.isCheckpoint && <Icon path={paths.flag} size={14} className="text-indigo-600 fill-indigo-100 flex-shrink-0" />}
                                                        <span className={compactMode ? 'line-clamp-1' : 'line-clamp-2'}>{t.task}</span>
                                                        {t.dependency && <div className="tooltip-container flex-shrink-0"><Icon path={paths.link} size={12} className="text-slate-400" /><span className="tooltip-text">å‰ç½®ä»»å‹™: {parseDependencies(t.dependency).map(id => `#${id}`).join(', ')}</span></div>}
                                                        {t.notes && <div className="tooltip-container flex-shrink-0"><Icon path={paths.file} size={12} className="text-slate-400" /><span className="tooltip-text">{t.notes}</span></div>}
                                                    </div>
                                                    {!compactMode && <div className="mt-1">{getPriorityBadge(t.priority)}</div>}
                                                </td>
                                                <td className={`px-4 ${compactMode ? 'py-1.5' : 'py-4'} text-slate-600`}>
                                                    <div className="flex items-center gap-1.5"><Icon path={paths.timer} size={14} className="text-slate-400" /> <span className="font-medium">{t.duration}</span> å¤©</div>
                                                    {!compactMode && <div className="text-[10px] text-slate-400 mt-1">Start: {getStartDate(t.date, t.duration)}</div>}
                                                </td>
                                                <td className={`px-4 ${compactMode ? 'py-1.5' : 'py-4'}`}>
                                                    <div className="flex items-center gap-1.5">
                                                        <span className="font-semibold text-slate-700">{t.date}</span>
                                                        {/* å»¶æœŸ/é€±æœŸæ¨™ç±¤ */}
                                                        {(() => {
                                                            const history = Array.isArray(t.dateHistory) ? t.dateHistory : [];
                                                            const isRecurring = t.taskType === 'recurring';

                                                            // é€±æœŸæ€§ä»»å‹™ï¼šé¡¯ç¤ºé€±æœŸæ›´æ–°æ¨™ç±¤
                                                            if (isRecurring && history.length > 1) {
                                                                return (
                                                                    <span
                                                                        className="bg-blue-100 text-blue-600 text-[10px] px-1 py-0.5 rounded font-medium"
                                                                        title={`é€±æœŸæ€§ä»»å‹™ - å·²æ›´æ–° ${history.length - 1} æ¬¡`}
                                                                    >
                                                                        ğŸ”„
                                                                    </span>
                                                                );
                                                            }

                                                            // ä¸€æ¬¡æ€§ä»»å‹™ï¼šé¡¯ç¤ºå»¶æœŸå¤©æ•¸
                                                            if (history.length > 1) {
                                                                const originalDate = history[0]?.date;
                                                                const currentDate = t.date;
                                                                if (originalDate && currentDate && originalDate !== currentDate) {
                                                                    const origEnd = new Date(originalDate);
                                                                    const currEnd = new Date(currentDate);
                                                                    const delayDays = Math.round((currEnd - origEnd) / (1000 * 60 * 60 * 24));
                                                                    if (delayDays > 0) {
                                                                        return (
                                                                            <span
                                                                                className="bg-red-100 text-red-600 text-[10px] px-1.5 py-0.5 rounded font-medium"
                                                                                title={`åŸå§‹è¦åŠƒ: ${originalDate}`}
                                                                            >
                                                                                +{delayDays}å¤©
                                                                            </span>
                                                                        );
                                                                    } else if (delayDays < 0) {
                                                                        return (
                                                                            <span
                                                                                className="bg-green-100 text-green-600 text-[10px] px-1.5 py-0.5 rounded font-medium"
                                                                                title={`åŸå§‹è¦åŠƒ: ${originalDate}`}
                                                                            >
                                                                                {delayDays}å¤©
                                                                            </span>
                                                                        );
                                                                    }
                                                                }
                                                            }
                                                            return null;
                                                        })()}
                                                    </div>
                                                </td>
                                                <td className={`px-4 ${compactMode ? 'py-1.5' : 'py-4'}`}>
                                                    <div
                                                        className="w-8 h-8 rounded-full bg-gradient-to-br from-slate-200 to-slate-300 flex items-center justify-center text-xs font-bold text-slate-700 shadow-sm cursor-default"
                                                        title={getDisplayName(t.owner, OWNERS)}
                                                    >
                                                        {t.owner ? (t.owner.length <= 2 ? t.owner : t.owner.substring(0, 2)) : '?'}
                                                    </div>
                                                </td>
                                                <td className={`px-4 ${compactMode ? 'py-1.5' : 'py-4'} text-right`}>
                                                    <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-all duration-200">
                                                        <button
                                                            onClick={() => { setEditingTask(t); setIsModalOpen(true); }}
                                                            className="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors"
                                                            title="ç·¨è¼¯"
                                                        >
                                                            <Icon path={paths.edit} size={16} />
                                                        </button>
                                                        <button
                                                            onClick={() => handleDelete(t.id)}
                                                            className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors"
                                                            title="åˆªé™¤"
                                                        >
                                                            <Icon path={paths.trash} size={16} />
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {expandedRow === t.id && (
                                                <tr className="bg-slate-50 border-b border-slate-200">
                                                    <td colSpan={7} className="px-6 py-4">
                                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                                            <div>
                                                                <span className="text-slate-500">ç›®çš„:</span>
                                                                <span className="font-medium text-slate-700 ml-1">{t.purpose || '-'}</span>
                                                            </div>
                                                            <div>
                                                                <span className="text-slate-500">å°ˆæ¡ˆ:</span>
                                                                <span className="font-medium text-slate-700 ml-1">{t.project || '-'}</span>
                                                            </div>
                                                            <div>
                                                                <span className="text-slate-500">åˆ†é¡:</span>
                                                                <span className="font-medium text-slate-700 ml-1">{t.category || '-'}</span>
                                                            </div>
                                                            <div>
                                                                <span className="text-slate-500">Issue Date:</span>
                                                                <span className="font-medium text-slate-700 ml-1">{t.issueDate || '-'}</span>
                                                            </div>
                                                            <div>
                                                                <span className="text-slate-500">ç›¸ä¾ä»»å‹™:</span>
                                                                <span className="font-medium text-slate-700 ml-1">{t.dependency || 'ç„¡'}</span>
                                                            </div>
                                                            <div className="col-span-2 md:col-span-4">
                                                                <span className="text-slate-500">å‚™è¨»:</span>
                                                                <span className="font-medium text-slate-700 ml-1">{t.notes || 'ç„¡'}</span>
                                                            </div>
                                                            {/* æ—¥æœŸè®Šæ›´æ­·å² */}
                                                            {Array.isArray(t.dateHistory) && t.dateHistory.length > 1 && (
                                                                <div className="col-span-2 md:col-span-4 mt-2 pt-2 border-t border-slate-200">
                                                                    <span className="text-slate-500">ğŸ“… æ—¥æœŸè®Šæ›´æ­·å²:</span>
                                                                    <div className="flex flex-wrap gap-2 mt-1">
                                                                        {t.dateHistory.map((h, idx) => (
                                                                            <span key={idx} className="inline-flex items-center gap-1 text-xs bg-slate-100 px-2 py-1 rounded">
                                                                                <span className="text-indigo-600 font-semibold">v{h.version}</span>
                                                                                <span className="font-medium">{h.date}</span>
                                                                                <span className="text-slate-500">({h.reason})</span>
                                                                            </span>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </React.Fragment>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </>
            )}

            {/* åœ“é¤…åœ– - ç§»åˆ°ä»»å‹™åˆ—è¡¨ä¸‹æ–¹ */}
            <div className="bg-white p-6 rounded-xl border-2 border-slate-200 shadow-md">
                <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-slate-800 text-lg flex items-center gap-2">
                        <span>ğŸ“Š</span>
                        å°ˆæ¡ˆåˆ†å¸ƒ
                    </h3>
                    <div className="text-xs text-slate-500">
                        ä¾Teamåˆ†é¡çµ±è¨ˆ
                    </div>
                </div>
                <div className="h-80">
                    {window.Recharts && (
                        <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                                <Pie
                                    data={chartData}
                                    dataKey="value"
                                    cx="50%"
                                    cy="50%"
                                    innerRadius={80}
                                    outerRadius={120}
                                    paddingAngle={5}
                                >
                                    {chartData.map((e, i) => <Cell key={i} fill={e.color} />)}
                                </Pie>
                                <Tooltip />
                                <Legend verticalAlign="bottom" height={36} />
                            </PieChart>
                        </ResponsiveContainer>
                    )}
                </div>
            </div>

            {/* å³éµé¸å–® */}
            {
                contextMenu.visible && (
                    <ContextMenu
                        task={contextMenu.task}
                        position={contextMenu.position}
                        onClose={closeContextMenu}
                        onEdit={(t) => { setEditingTask(t); setIsModalOpen(true); }}
                        onDelete={handleDelete}
                        onChangeStatus={changeStatus}
                        onCopyId={copyTaskId}
                        canDelete={hasPermission('admin')}
                    />
                )
            }
        </div >
    );
};

window.Dashboard = Dashboard;

</script>
    <script type="text/babel">
// TopicView Component
// Topic è¿½è¹¤è¦–åœ– - æŒ‰ Purpose åˆ†çµ„é¡¯ç¤ºä»»å‹™é€²åº¦
// Props: å¾ AppContext å–å¾—

const TopicView = () => {
    const {
        tasks = [],
        setEditingTask,
        setIsModalOpen,
        todayStr,
        searchQuery = '',
        setSearchQuery
    } = useAppContext();

    const { useState, useMemo } = React;

    // å±•é–‹ç‹€æ…‹ç®¡ç†
    const [expandedTopics, setExpandedTopics] = useState({});
    const [showCompleted, setShowCompleted] = useState(false);
    const [topicSearch, setTopicSearch] = useState('');

    // æŒ‰ Purpose åˆ†çµ„ä»»å‹™
    const groupedTopics = useMemo(() => {
        // å…ˆæŒ‰æœå°‹æ¢ä»¶éæ¿¾
        let filteredTasks = tasks;
        if (topicSearch.trim()) {
            const lowerSearch = topicSearch.toLowerCase();
            filteredTasks = tasks.filter(t =>
                (t.purpose && t.purpose.toLowerCase().includes(lowerSearch)) ||
                (t.task && t.task.toLowerCase().includes(lowerSearch))
            );
        }

        // æŒ‰ Purpose åˆ†çµ„
        const grouped = filteredTasks.reduce((acc, task) => {
            const purpose = task.purpose || '(æœªåˆ†é¡)';
            if (!acc[purpose]) {
                acc[purpose] = {
                    name: purpose,
                    tasks: [],
                    completed: 0,
                    total: 0
                };
            }
            acc[purpose].tasks.push(task);
            acc[purpose].total++;
            if (task.status === 'Done' || task.status === 'Closed') {
                acc[purpose].completed++;
            }
            return acc;
        }, {});

        // è½‰æ›ç‚ºé™£åˆ—ä¸¦è¨ˆç®—é€²åº¦
        return Object.values(grouped).map(topic => ({
            ...topic,
            progress: topic.total > 0 ? Math.round((topic.completed / topic.total) * 100) : 0,
            isCompleted: topic.completed === topic.total && topic.total > 0
        })).sort((a, b) => {
            // é€²è¡Œä¸­çš„æ’å‰é¢ï¼Œå·²å®Œæˆçš„æ’å¾Œé¢
            if (a.isCompleted !== b.isCompleted) {
                return a.isCompleted ? 1 : -1;
            }
            // åŒç‹€æ…‹æŒ‰ä»»å‹™æ•¸é‡æ’åºï¼ˆå¤šçš„åœ¨å‰ï¼‰
            return b.total - a.total;
        });
    }, [tasks, topicSearch]);

    // åˆ†é›¢é€²è¡Œä¸­å’Œå·²å®Œæˆ
    const inProgressTopics = groupedTopics.filter(t => !t.isCompleted);
    const completedTopics = groupedTopics.filter(t => t.isCompleted);

    // åˆ‡æ›å±•é–‹ç‹€æ…‹
    const toggleExpand = (topicName) => {
        setExpandedTopics(prev => ({
            ...prev,
            [topicName]: !prev[topicName]
        }));
    };

    // å–å¾—ç‹€æ…‹åœ–ç¤º
    const getStatusIcon = (status) => {
        switch (status) {
            case 'Done': return 'âœ…';
            case 'Closed': return 'ğŸš«';
            case 'InProgress': return 'ğŸ”µ';
            case 'Pending': return 'â¸ï¸';
            case 'Delayed': return 'ğŸ”´';
            default: return 'â¬œ';
        }
    };

    // å–å¾—é€²åº¦æ¢é¡è‰²
    const getProgressColor = (progress) => {
        if (progress === 100) return 'bg-green-500';
        if (progress >= 75) return 'bg-emerald-500';
        if (progress >= 50) return 'bg-blue-500';
        if (progress >= 25) return 'bg-yellow-500';
        return 'bg-orange-500';
    };

    // Topic å¡ç‰‡æ¸²æŸ“
    const renderTopicCard = (topic) => {
        const isExpanded = expandedTopics[topic.name];

        return (
            <div key={topic.name} className="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden mb-3">
                {/* Topic æ¨™é¡Œåˆ— */}
                <div
                    className="p-4 cursor-pointer hover:bg-slate-50 transition-colors flex items-center justify-between"
                    onClick={() => toggleExpand(topic.name)}
                >
                    <div className="flex items-center gap-3 flex-1">
                        <span className={`transform transition-transform ${isExpanded ? 'rotate-90' : ''}`}>â–¶</span>
                        <div className="flex-1">
                            <div className="flex items-center gap-2">
                                <span className="font-bold text-slate-800">{topic.name}</span>
                                <span className="text-sm text-slate-500">
                                    ({topic.completed}/{topic.total})
                                </span>
                                {topic.isCompleted && <span className="text-green-500">âœ“ å®Œæˆ</span>}
                            </div>
                            {/* é€²åº¦æ¢ */}
                            <div className="mt-2 flex items-center gap-2">
                                <div className="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
                                    <div
                                        className={`h-full ${getProgressColor(topic.progress)} transition-all duration-300`}
                                        style={{ width: `${topic.progress}%` }}
                                    />
                                </div>
                                <span className="text-xs font-medium text-slate-600 w-10">{topic.progress}%</span>
                            </div>
                        </div>
                    </div>
                </div>

                {/* å±•é–‹çš„ä»»å‹™æ¸…å–® */}
                {isExpanded && (
                    <div className="border-t border-slate-200 bg-slate-50">
                        <div className="divide-y divide-slate-200">
                            {topic.tasks
                                .sort((a, b) => new Date(a.date) - new Date(b.date))
                                .map(task => (
                                    <div
                                        key={task.id}
                                        className="p-3 hover:bg-slate-100 cursor-pointer transition-colors flex items-center gap-3"
                                        onClick={() => { setEditingTask(task); setIsModalOpen(true); }}
                                    >
                                        <span className="text-lg">{getStatusIcon(task.status)}</span>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2">
                                                {getTaskIdBadge(task.id)}
                                                <span className={`text-xs px-1.5 py-0.5 rounded ${task.team === 'æ™¶ç‰‡' ? 'bg-purple-100 text-purple-700' :
                                                    task.team === 'QA' ? 'bg-green-100 text-green-700' :
                                                        task.team === 'è»Ÿé«”' ? 'bg-blue-100 text-blue-700' :
                                                            task.team === 'æ©Ÿæ§‹' ? 'bg-orange-100 text-orange-700' :
                                                                'bg-slate-100 text-slate-700'
                                                    }`}>{task.team}</span>
                                            </div>
                                            <div className="font-medium text-slate-800 truncate">{task.task}</div>
                                            <div className="text-xs text-slate-500">
                                                ğŸ“… {task.date} â€¢ ğŸ‘¤ {task.owner}
                                            </div>
                                        </div>
                                        <Icon path={paths.edit} size={16} className="text-slate-400" />
                                    </div>
                                ))}
                        </div>
                    </div>
                )}
            </div>
        );
    };

    return (
        <div className="space-y-4">
            {/* æ¨™é¡Œå’Œæœå°‹ */}
            <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div className="flex items-center gap-3">
                        <div className="bg-indigo-600 text-white p-2 rounded-lg">ğŸ“‹</div>
                        <div>
                            <h2 className="text-lg font-bold text-slate-800">Topic è¿½è¹¤</h2>
                            <p className="text-sm text-slate-500">æŒ‰ç›®çš„ (Purpose) è¿½è¹¤è·¨éƒ¨é–€ä»»å‹™é€²åº¦</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-2">
                        <div className="relative">
                            <Icon path={paths.search} size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                            <input
                                type="text"
                                placeholder="æœå°‹ Topic..."
                                value={topicSearch}
                                onChange={(e) => setTopicSearch(e.target.value)}
                                className="pl-9 pr-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none w-64"
                            />
                        </div>
                    </div>
                </div>

                {/* çµ±è¨ˆæ‘˜è¦ */}
                <div className="mt-4 grid grid-cols-3 gap-4">
                    <div className="bg-blue-50 rounded-lg p-3 text-center">
                        <div className="text-2xl font-bold text-blue-600">{groupedTopics.length}</div>
                        <div className="text-xs text-blue-600">ç¸½ Topics</div>
                    </div>
                    <div className="bg-orange-50 rounded-lg p-3 text-center">
                        <div className="text-2xl font-bold text-orange-600">{inProgressTopics.length}</div>
                        <div className="text-xs text-orange-600">é€²è¡Œä¸­</div>
                    </div>
                    <div className="bg-green-50 rounded-lg p-3 text-center">
                        <div className="text-2xl font-bold text-green-600">{completedTopics.length}</div>
                        <div className="text-xs text-green-600">å·²å®Œæˆ</div>
                    </div>
                </div>
            </div>

            {/* é€²è¡Œä¸­çš„ Topics */}
            {inProgressTopics.length > 0 && (
                <div>
                    <h3 className="text-sm font-bold text-slate-600 mb-2 flex items-center gap-2">
                        ğŸ”´ é€²è¡Œä¸­ ({inProgressTopics.length})
                    </h3>
                    {inProgressTopics.map(renderTopicCard)}
                </div>
            )}

            {/* å·²å®Œæˆçš„ Topics */}
            {completedTopics.length > 0 && (
                <div>
                    <button
                        className="text-sm font-bold text-slate-600 mb-2 flex items-center gap-2 hover:text-slate-800"
                        onClick={() => setShowCompleted(!showCompleted)}
                    >
                        <span className={`transform transition-transform ${showCompleted ? 'rotate-90' : ''}`}>â–¶</span>
                        ğŸŸ¢ å·²å®Œæˆ ({completedTopics.length})
                    </button>
                    {showCompleted && completedTopics.map(renderTopicCard)}
                </div>
            )}

            {/* ç©ºç‹€æ…‹ */}
            {groupedTopics.length === 0 && (
                <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-12 text-center">
                    <div className="text-6xl mb-4">ğŸ“‹</div>
                    <h3 className="text-xl font-bold text-slate-600 mb-2">å°šç„¡ Topic</h3>
                    <p className="text-slate-400">
                        {topicSearch ? 'æ²’æœ‰ç¬¦åˆæœå°‹æ¢ä»¶çš„ Topic' : 'åœ¨ä»»å‹™ä¸­å¡«å¯« Purpose æ¬„ä½å³å¯å»ºç«‹ Topic'}
                    </p>
                </div>
            )}
        </div>
    );
};

window.TopicView = TopicView;

</script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } = window.Recharts || {};

        // âœ… Task IDéƒ¨é–€ä»£ç¢¼Mapping (ç”¨æ–¼æœªä¾†Task IDå‡ç´š)
        const DEPT_CODES = {
            'æ™¶ç‰‡': 'CHIP',
            'æ©Ÿæ§‹': 'MECH',
            'è»Ÿé«”': 'SW',
            'é›»æ§': 'EC',
            'æµé“': 'FLOW',
            'ç”Ÿé†«': 'BIO',
            'QA': 'QA',
            'ç®¡ç†': 'MGT',
            'issue': 'ISS'
        };
    </script>
    
    <!-- Custom Hooks -->
    <script type="text/babel">
// ===== hooks/useAuth.js =====
/**
 * useAuth Hook
 * ç®¡ç†ä½¿ç”¨è€…èªè­‰ç‹€æ…‹
 */

// ç¢ºä¿ React Hooks å¯ç”¨
const { useState, useEffect } = React;

const useAuth = () => {
    // ç‹€æ…‹
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [user, setUser] = useState(null); // { email, name, permission }
    const [isLoading, setIsLoading] = useState(true);
    const [authError, setAuthError] = useState(null);

    // åˆå§‹åŒ–æª¢æŸ¥
    useEffect(() => {
        checkSession();
    }, []);

    const checkSession = async () => {
        setIsLoading(true);
        setAuthError(null);
        try {
            // âœ… Lite ç‰ˆæœ¬ï¼šLocal Admin æ¨¡å¼ï¼Œè·³é OAuth é©—è­‰
            // æ‰€æœ‰ä½¿ç”¨è€…é è¨­ç‚º Adminï¼Œé©åˆå€‹äººæˆ–å°åœ˜éšŠä½¿ç”¨
            console.log('âœ… Lite ç‰ˆæœ¬ï¼šå•Ÿç”¨ Local Admin æ¨¡å¼');
            setUser({
                email: 'local@admin',
                name: 'Local Admin',
                permission: 'admin'
            });
            setIsAuthenticated(true);

        } catch (err) {
            console.warn('âŒ åˆå§‹åŒ–å¤±æ•—:', err);
            setIsAuthenticated(false);
            setUser(null);
            setAuthError(err.message || 'åˆå§‹åŒ–éŒ¯èª¤');
        } finally {
            setIsLoading(false);
        }
    };

    // ç™»å‡º (Lite ç‰ˆæœ¬é‡æ–°æ•´ç†é é¢å³å¯)
    const handleLogout = () => {
        setIsAuthenticated(false);
        setUser(null);
        window.location.reload();
    };

    return {
        isAuthenticated,
        user,
        isLoading,
        authError,
        checkSession, // ä¾› LoginScreen é‡è©¦ç”¨
        handleLogout
    };
};


// ===== hooks/useTaskData.js =====
/**
 * useTaskData Hook
 * ç®¡ç†ä»»å‹™è³‡æ–™çš„è¼‰å…¥ã€ä¸Šå‚³ã€å„²å­˜å’Œåˆªé™¤
 */

function useTaskData(isAuthenticated) {
    // Fallback data if API fails and no backup exists
    const INITIAL_DATA = [];

    // Helper: çµ±ä¸€çš„ Task æ ¼å¼åŒ–å‡½æ•¸
    const formatTaskItem = (item) => {
        const normalizedDate = normalizeDate(item.date);

        // è§£æ dateHistory (è™•ç†å¯èƒ½è¢«èˆŠæ ¼å¼æ±¡æŸ“çš„è³‡æ–™)
        let dateHistory = [];
        if (item.dateHistory) {
            let historyStr = String(item.dateHistory);
            try {
                // å¦‚æœä»¥ [ é–‹é ­ï¼Œå¯èƒ½æ˜¯ JSON æ ¼å¼
                if (historyStr.trim().startsWith('[')) {
                    // è™•ç†è¢«åˆ†è™Ÿè¿½åŠ èˆŠæ ¼å¼çš„æƒ…æ³: "[{...}];oldformat"
                    const jsonEndIndex = historyStr.indexOf('];');
                    if (jsonEndIndex !== -1) {
                        historyStr = historyStr.substring(0, jsonEndIndex + 1);
                    }
                    dateHistory = JSON.parse(historyStr);
                }
            } catch (e) {
                console.warn('[dateHistory] è§£æå¤±æ•—:', e.message, 'åŸå§‹è³‡æ–™:', item.dateHistory);
                dateHistory = [];
            }
        }

        // è‹¥ç„¡æ­·å²è¨˜éŒ„ï¼Œä»¥ç•¶å‰ date å»ºç«‹åˆå§‹è¨˜éŒ„
        if (dateHistory.length === 0 && normalizedDate) {
            dateHistory = [{
                date: normalizedDate,
                changedAt: new Date().toISOString(),
                reason: 'åˆå§‹è¦åŠƒ',
                version: 1
            }];
        }

        return {
            ...item,
            id: item.id,
            duration: Math.max(Number(item.duration) || 1, 1), // æœ€å°å€¼ç‚º 1ï¼Œé¿å…ç”˜ç‰¹åœ–ç•°å¸¸
            isCheckpoint: item.isCheckpoint === true || item.isCheckpoint === "TRUE",
            date: normalizedDate,
            issueDate: normalizeDate(item.issueDate) || '',
            startDate: normalizeDate(item.startDate) || '',
            dependency: item.dependency || '',
            notes: item.notes || '',
            category: item.category || item.team || 'Mechanism',
            dateHistory: dateHistory, // å·²è§£æçš„é™£åˆ—
            taskType: item.taskType || 'one-time', // ä»»å‹™é¡å‹
            recurringCycle: item.recurringCycle || '', // é€±æœŸè¨­å®š
            // Phase 2.0 Task å“è³ªå¼·åŒ–æ¬„ä½
            background: item.background || '',
            expectedResult: item.expectedResult || '',
            acceptanceCriteria: item.acceptanceCriteria || '',
            assistants: item.assistants || '',
            verificationFiles: item.verificationFiles || '[]',
            reviewer: item.reviewer || ''
        };
    };
    const [tasks, setTasks] = React.useState([]);
    const [isLoading, setIsLoading] = React.useState(true);
    const [isOffline, setIsOffline] = React.useState(false);
    const [apiError, setApiError] = React.useState(null);
    const [dataSource, setDataSource] = React.useState('google');
    const [uploadProgress, setUploadProgress] = React.useState('');
    const fileInputRef = React.useRef(null);

    // è¼‰å…¥ä»»å‹™è³‡æ–™
    React.useEffect(() => {
        if (!isAuthenticated) return;

        setIsLoading(true);
        const fetchData = async () => {
            try {
                setApiError(null);
                const result = await window.callApi('read');

                if (!result.success) {
                    throw new Error(result.error || 'è®€å–å¤±æ•—');
                }

                const data = result.data || [];

                if (Array.isArray(data) && data.length > 0) {
                    const firstItem = data[0];
                    const isUTMFormat = firstItem.hasOwnProperty('ID') || firstItem.hasOwnProperty('Task');

                    let formatted;
                    if (isUTMFormat) {
                        const convertResult = convertUTMToTracker(data);
                        formatted = convertResult.data;
                    } else {
                        formatted = data.map(formatTaskItem);
                    }
                    setTasks(formatted);
                    setDataSource('google');
                    setIsOffline(false);
                } else {
                    setTasks(INITIAL_DATA);
                    setIsOffline(false);
                }

            } catch (err) {
                console.error("API Error:", err);
                let errorMsg = err.message || 'æœªçŸ¥éŒ¯èª¤';

                if (errorMsg.includes('Failed to fetch')) {
                    errorMsg = 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯';
                }

                setApiError(errorMsg);

                const backup = localStorage.getItem('tasks_backup');
                if (backup) {
                    try {
                        const backupTasks = JSON.parse(backup);
                        const backupTime = localStorage.getItem('tasks_backup_time');
                        setTasks(backupTasks);
                        setApiError(`${errorMsg} - ä½¿ç”¨æœ¬åœ°å‚™ä»½ (${new Date(backupTime).toLocaleString('zh-TW')})`);
                    } catch (e) {
                        setTasks(INITIAL_DATA);
                    }
                } else {
                    setTasks(INITIAL_DATA);
                }
                setIsOffline(true);
            } finally {
                setIsLoading(false);
            }
        };
        fetchData();
    }, [isAuthenticated]);

    // Excel æª”æ¡ˆä¸Šå‚³è™•ç†
    const handleFileUpload = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const validExtensions = ['.xlsx', '.xls', '.csv'];
        const fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
        if (!validExtensions.includes(fileExtension)) {
            alert('æª”æ¡ˆæ ¼å¼ä¸æ”¯æ´ï¼è«‹ä¸Šå‚³ Excel (.xlsx, .xls) æˆ– CSV (.csv) æª”æ¡ˆ');
            return;
        }

        setIsLoading(true);
        setUploadProgress(`æ­£åœ¨è®€å– ${file.name}...`);

        try {
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    setUploadProgress('æ­£åœ¨è§£ææª”æ¡ˆ...');

                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: true });

                    setUploadProgress('æ­£åœ¨è½‰æ›è³‡æ–™æ ¼å¼...');

                    // ğŸ†• æª¢æŸ¥æ˜¯å¦ç‚ºå¿«ç…§æª”æ¡ˆ (ç”¨æ–¼é€±å ±æ¯”å°)
                    if (jsonData[0] && (jsonData[0]._SnapshotDate || jsonData[0]['_SnapshotDate'])) {
                        console.log('ğŸ“Š åµæ¸¬åˆ°å¿«ç…§æª”æ¡ˆï¼Œé€²è¡Œé€±å ±æ¯”å°...');
                        setUploadProgress('åµæ¸¬åˆ°å¿«ç…§æª”æ¡ˆï¼Œæ­£åœ¨æ¯”å°...');

                        // å–å¾—ç•¶å‰ä»»å‹™æ¸…å–®é€²è¡Œæ¯”å°
                        const currentTasks = tasks;
                        const diff = compareSnapshots(jsonData, currentTasks);

                        // é€é window äº‹ä»¶é€šçŸ¥ App é¡¯ç¤ºå ±å‘Š Modal
                        window.dispatchEvent(new CustomEvent('showWeeklyReport', { detail: diff }));

                        setUploadProgress(`âœ“ æ¯”å°å®Œæˆï¼å¿«ç…§æ—¥æœŸ: ${diff.snapshotDate}`);
                        setTimeout(() => setUploadProgress(''), 3000);
                        setIsLoading(false);
                        return;
                    }

                    const result = convertUTMToTracker(jsonData);

                    if (!result.success) {
                        const errorMsg = result.errors.join('\n');
                        if (result.data.length > 0) {
                            alert(`éƒ¨åˆ†è³‡æ–™è½‰æ›å¤±æ•—:\n${errorMsg}\n\nå·²æˆåŠŸè¼‰å…¥ ${result.stats.converted} / ${result.stats.total} ç­†ä»»å‹™`);
                        } else {
                            throw new Error(`è³‡æ–™è½‰æ›å¤±æ•—:\n${errorMsg}`);
                        }
                    }

                    if (result.data.length === 0) {
                        throw new Error('æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„ä»»å‹™è³‡æ–™');
                    }

                    setTasks(result.data);
                    setDataSource('excel');
                    setIsOffline(true);
                    setApiError(null);

                    try {
                        localStorage.setItem('tasks_backup', JSON.stringify(result.data));
                        localStorage.setItem('tasks_backup_time', new Date().toISOString());
                        localStorage.setItem('tasks_backup_source', file.name);
                    } catch (e) {
                        console.warn('æœ¬åœ°å„²å­˜å¤±æ•—:', e);
                    }

                    setUploadProgress(`âœ“ æˆåŠŸè¼‰å…¥ ${result.data.length} ç­†ä»»å‹™ (ä¾†è‡ª ${file.name})`);
                    setTimeout(() => setUploadProgress(''), 3000);

                } catch (parseError) {
                    console.error('è§£æéŒ¯èª¤:', parseError);
                    alert(`æª”æ¡ˆè§£æå¤±æ•—: ${parseError.message}`);
                    setUploadProgress('');
                } finally {
                    setIsLoading(false);
                }
            };

            reader.onerror = (error) => {
                console.error('æª”æ¡ˆè®€å–éŒ¯èª¤:', error);
                alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹é‡è©¦');
                setUploadProgress('');
                setIsLoading(false);
            };

            reader.readAsArrayBuffer(file);

        } catch (error) {
            console.error('ä¸Šå‚³éŒ¯èª¤:', error);
            alert(`ä¸Šå‚³å¤±æ•—: ${error.message}`);
            setUploadProgress('');
            setIsLoading(false);
        }
    };

    // è™•ç†å„²å­˜
    const handleSave = (e, editingTask, todayStr) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const dateChangeReason = fd.get('dateChangeReason')?.trim() || '';
        const defaultDate = getTaiwanToday();
        const newDate = fd.get('date') || defaultDate;

        // è™•ç† dateHistory - ç¢ºä¿æ˜¯é™£åˆ—
        let dateHistory = [];
        if (Array.isArray(editingTask?.dateHistory)) {
            dateHistory = editingTask.dateHistory;
        } else if (typeof editingTask?.dateHistory === 'string') {
            // å˜—è©¦è§£æå­—ä¸²
            try {
                const parsed = JSON.parse(editingTask.dateHistory);
                dateHistory = Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                console.warn('âš ï¸ dateHistory è§£æå¤±æ•—ï¼Œé‡ç½®ç‚ºç©ºé™£åˆ—');
                dateHistory = [];
            }
        }

        const oldDate = editingTask?.date;
        const isDateChanged = editingTask && oldDate !== newDate;
        const isNewTask = !editingTask;

        if (isNewTask || isDateChanged) {
            dateHistory = [...dateHistory, {
                date: newDate,
                changedAt: new Date().toISOString(),
                reason: isNewTask ? 'åˆå§‹è¦åŠƒ' : (dateChangeReason || 'æ—¥æœŸèª¿æ•´'),
                version: dateHistory.length + 1
            }];
        }

        const isEditing = !!editingTask;
        const newItem = {
            ...(isEditing && { id: editingTask.id }),
            project: fd.get('project'),
            purpose: fd.get('purpose') || '',
            team: fd.get('team'),
            task: fd.get('task'),
            owner: fd.get('owner'),
            issueDate: fd.get('issueDate') || '',
            startDate: fd.get('startDate') || '',
            date: newDate,
            duration: parseInt(fd.get('duration') || 0),
            isCheckpoint: fd.get('isCheckpoint') === 'on',
            issuePool: fd.get('issuePool') === 'on',
            priority: fd.get('priority'),
            status: fd.get('status'),
            dependency: fd.get('dependency'),
            verification: fd.get('verification'),
            notes: fd.get('notes'),
            dateHistory: JSON.stringify(dateHistory), // å‚³é€çµ¦å¾Œç«¯æ™‚è½‰ç‚º JSON å­—ä¸²
            taskType: fd.get('taskType') || 'one-time',
            recurringCycle: fd.get('recurringCycle') || '',
            // Phase 2.0 Task å“è³ªå¼·åŒ–æ¬„ä½
            background: fd.get('background') || '',
            expectedResult: fd.get('expectedResult') || '',
            acceptanceCriteria: fd.get('acceptanceCriteria') || '',
            assistants: fd.get('assistants') || '',
            verificationFiles: fd.get('verificationFiles') || '[]',
            reviewer: fd.get('reviewer') || ''
        };

        const validationErrors = validateTask(newItem);
        if (validationErrors.length > 0) {
            alert('é©—è­‰å¤±æ•—:\n' + validationErrors.join('\n'));
            return;
        }

        if (isEditing) {
            const depErrors = validateDependencies(newItem.dependency, newItem.id, tasks);
            if (depErrors.length > 0) {
                alert('ç›¸ä¾æ€§é©—è­‰å¤±æ•—:\n' + depErrors.join('\n'));
                return;
            }
            if (newItem.dependency && detectCircularDependency(newItem.id, newItem.dependency, tasks)) {
                alert('éŒ¯èª¤ï¼šåµæ¸¬åˆ°å¾ªç’°ç›¸ä¾æ€§ï¼');
                return;
            }
        }

        let updatedTasks = tasks;
        if (isEditing) {
            updatedTasks = tasks.map(t => t.id === newItem.id ? newItem : t);
            setTasks(updatedTasks);
        }

        if (isEditing) {
            try {
                localStorage.setItem('tasks_backup', JSON.stringify(updatedTasks));
                localStorage.setItem('tasks_backup_time', new Date().toISOString());
            } catch (e) {
                console.warn('æœ¬åœ°å„²å­˜å¤±æ•—:', e);
            }
        }

        if (!isOffline) {
            const action = isEditing ? 'update' : 'upsert';
            // âœ… ä½¿ç”¨ callApi
            window.callApi(action, newItem)
                .then((result) => {
                    if (!result.success) throw new Error(result.error);

                    console.log('âœ… å·²ç™¼é€è‡³ Google Sheets');
                    if (!isEditing) {
                        setIsLoading(true);
                        setTimeout(() => {
                            // Reload data
                            window.callApi('read')
                                .then(result => {
                                    if (result.success && Array.isArray(result.data)) {
                                        const data = result.data;
                                        const formatted = data.map(formatTaskItem);
                                        setTasks(formatted);
                                    }
                                })
                                .finally(() => setIsLoading(false));
                        }, 1000);
                    }
                })
                .catch(err => {
                    console.error("âŒ ç™¼é€å¤±æ•—:", err);
                    alert('å„²å­˜åˆ° Google Sheets æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œä½†æœ¬åœ°å·²æ›´æ–°: ' + err.message);
                });
        }

        return true; // è¡¨ç¤ºå„²å­˜æˆåŠŸï¼Œç”± App é—œé–‰ modal
    };

    const handleDelete = (id) => {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™å—ï¼Ÿ(å°‡åŒæ­¥åˆªé™¤ Google Sheet è³‡æ–™)')) return;
        setTasks(prev => prev.filter(x => x.id !== id));

        if (!isOffline) {
            // âœ… ä½¿ç”¨ callApi
            window.callApi('delete', { id: id })
                .then((res) => {
                    if (!res.success) throw new Error(res.error);
                    console.log('âœ… åˆªé™¤æˆåŠŸ');
                })
                .catch(err => console.error("âŒ Delete Error:", err));
        }
    };

    // å¿«é€Ÿæ›´æ–°ä»»å‹™ç‹€æ…‹ï¼ˆç”¨æ–¼å³éµé¸å–®ã€é»æ“Šåˆ‡æ›ç­‰ï¼‰
    const updateTaskStatus = (task, newStatus) => {
        if (!task || !task.id) return;

        // ğŸ†• [v7.5.13] å¼·åˆ¶ AC æª¢æŸ¥ï¼šè‹¥å˜—è©¦æ¨™è¨˜ç‚º Doneï¼Œå¿…é ˆå®Œæˆæ‰€æœ‰é©—æ”¶æº–å‰‡
        if (newStatus === 'Done') {
            let acItems = [];
            try {
                if (Array.isArray(task.acceptanceCriteria)) {
                    acItems = task.acceptanceCriteria;
                } else if (typeof task.acceptanceCriteria === 'string') {
                    const acStr = task.acceptanceCriteria.trim();
                    if (acStr.startsWith('[')) {
                        // JSON æ ¼å¼
                        acItems = JSON.parse(acStr);
                    } else if (acStr.includes('- [')) {
                        // Markdown æ ¼å¼: "- [ ] Task 1"
                        acItems = acStr.split('\n')
                            .filter(line => line.trim())
                            .map(line => ({
                                checked: line.includes('[x]') || line.includes('[X]'),
                                content: line.replace(/^-?\s*\[[ xX]?\]\s*/, '').trim()
                            }));
                    }
                }
            } catch (e) {
                console.warn('AC è§£æå¤±æ•—:', e);
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰æœªå‹¾é¸çš„é …ç›®
            const uncheckedCount = acItems.filter(item => !item.checked).length;

            if (uncheckedCount > 0) {
                alert(`âš ï¸ ç„¡æ³•æ¨™è¨˜ç‚ºã€Œå®Œæˆã€ï¼\n\næ­¤ä»»å‹™å°šæœ‰ ${uncheckedCount} é …é©—æ”¶æº–å‰‡ (AC) æœªé€šéã€‚\n\nè«‹é›™æ“Šä»»å‹™é–‹å•Ÿç·¨è¼¯è¦–çª—ï¼Œä¸¦å‹¾é¸æ‰€æœ‰é©—æ”¶é …ç›®ã€‚`);
                return false; // é˜»æ“‹æ›´æ–°
            }
        }

        const updatedTask = { ...task, status: newStatus };

        // æ›´æ–°æœ¬åœ°ç‹€æ…‹
        setTasks(prev => prev.map(t => t.id === task.id ? updatedTask : t));

        // åŒæ­¥åˆ°é ç«¯
        if (!isOffline) {
            // å›å‚³ Promise ä»¥ä¾¿èª¿ç”¨è€…çŸ¥é“çµæœ
            return window.callApi('update', updatedTask)
                .then((res) => {
                    if (!res.success) throw new Error(res.error);
                    console.log('âœ… ç‹€æ…‹æ›´æ–°æˆåŠŸ:', newStatus);
                    return true;
                })
                .catch(err => {
                    console.error("âŒ ç‹€æ…‹æ›´æ–°å¤±æ•—:", err);
                    // å›æ»¾æœ¬åœ°ç‹€æ…‹
                    setTasks(prev => prev.map(t => t.id === task.id ? task : t));
                    return false;
                });
        }
        return Promise.resolve(true);
    };

    // ğŸ†• åŒæ­¥åˆ°é›²ç«¯ï¼ˆAdmin Onlyï¼‰- å°‡ Excel åŒ¯å…¥çš„è³‡æ–™å¯«å…¥ Google Sheets
    const [syncProgress, setSyncProgress] = React.useState('');
    const [isSyncing, setIsSyncing] = React.useState(false);

    const handleSyncToCloud = async () => {
        if (!tasks || tasks.length === 0) {
            alert('âŒ æ²’æœ‰ä»»å‹™è³‡æ–™å¯åŒæ­¥');
            return;
        }

        if (!confirm(`ç¢ºå®šè¦å°‡ ${tasks.length} ç­†ä»»å‹™åŒæ­¥åˆ° Google Sheetsï¼Ÿ\n\nâš ï¸ é€™æœƒå°‡æ‰€æœ‰ Excel åŒ¯å…¥çš„è³‡æ–™å¯«å…¥é›²ç«¯è³‡æ–™åº«ã€‚`)) {
            return;
        }

        setIsSyncing(true);
        setSyncProgress(`é–‹å§‹åŒæ­¥ ${tasks.length} ç­†ä»»å‹™...`);

        let successCount = 0;
        let failCount = 0;
        const errors = [];

        for (let i = 0; i < tasks.length; i++) {
            const task = tasks[i];
            setSyncProgress(`åŒæ­¥ä¸­... ${i + 1}/${tasks.length} (${task.task?.substring(0, 20)}...)`);

            try {
                // ğŸ†• æª¢æ¸¬ YAML æ ¼å¼ ID (å¦‚ 016_vacuum_pump_control_M3)
                const isYamlFormatId = (id) => {
                    if (!id) return false;
                    return /^\d{3}_/.test(String(id));
                };

                // æº–å‚™ä»»å‹™è³‡æ–™
                let taskData = {
                    ...task,
                    dateHistory: Array.isArray(task.dateHistory)
                        ? JSON.stringify(task.dateHistory)
                        : task.dateHistory || '[]'
                };

                // ğŸ†• YAML ID â†’ Legacy_ID è½‰æ›
                if (isYamlFormatId(task.id)) {
                    taskData.legacy_id = task.id;  // ä¿ç•™åŸ YAML ID ç‚º legacy_id
                    delete taskData.id;             // ç§»é™¤ idï¼Œè®“å¾Œç«¯ç”¢ç”Ÿæ–°æ ¼å¼ ID
                    console.log(`[Sync] è½‰æ› YAML ID: ${task.id} â†’ legacy_id`);
                }

                const result = await window.callApi('upsert', taskData);

                if (result.success) {
                    successCount++;
                } else {
                    failCount++;
                    errors.push(`${task.id}: ${result.error}`);
                }
            } catch (err) {
                failCount++;
                errors.push(`${task.id}: ${err.message}`);
            }

            // æ¯ 10 ç­†æš«åœä¸€ä¸‹ï¼Œé¿å… API éè¼‰
            if ((i + 1) % 10 === 0) {
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        setIsSyncing(false);
        setSyncProgress('');
        setIsOffline(false);
        setDataSource('google');

        if (failCount === 0) {
            alert(`âœ… åŒæ­¥å®Œæˆï¼æˆåŠŸ: ${successCount} ç­†`);
        } else {
            alert(`âš ï¸ åŒæ­¥å®Œæˆ\næˆåŠŸ: ${successCount} ç­†\nå¤±æ•—: ${failCount} ç­†\n\nå¤±æ•—é …ç›®:\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? '\n...' : ''}`);
        }
    };

    return {
        tasks,
        setTasks,
        isLoading,
        setIsLoading,
        isOffline,
        apiError,
        dataSource,
        uploadProgress,
        fileInputRef,
        handleFileUpload,
        handleSave,
        handleDelete,
        updateTaskStatus,
        // ğŸ†• åŒæ­¥åˆ°é›²ç«¯
        handleSyncToCloud,
        syncProgress,
        isSyncing
    };
}

// å°å‡ºåˆ° window
window.useTaskData = useTaskData;


// ===== hooks/useFilters.js =====
/**
 * useFilters Hook
 * ç®¡ç†ç¯©é¸ã€æœå°‹ã€çµ±è¨ˆå’Œåœ–è¡¨è³‡æ–™
 */

function useFilters(tasks, todayStr, apiError, dynamicTeams, TEAMS) {
    // State
    const [filterTeam, setFilterTeam] = React.useState('All');
    const [filterProject, setFilterProject] = React.useState('All');
    const [filterStat, setFilterStat] = React.useState(null);
    const [searchQuery, setSearchQuery] = React.useState('');
    const [ganttFilterTeam, setGanttFilterTeam] = React.useState('All');
    const [showDependencies, setShowDependencies] = React.useState(false);
    const [viewMode, setViewMode] = React.useState('dashboard');

    // å¾ localStorage è®€å–åˆå§‹è¨­å®š
    const [highlightUrgent, setHighlightUrgent] = React.useState(() => {
        const saved = localStorage.getItem('highlightUrgent');
        return saved !== null ? JSON.parse(saved) : true;
    });

    const [hideCompleted, setHideCompleted] = React.useState(() => {
        const saved = localStorage.getItem('hideCompleted');
        return saved !== null ? JSON.parse(saved) : true;
    });

    // æŒä¹…åŒ–è¨­å®š
    React.useEffect(() => {
        localStorage.setItem('highlightUrgent', JSON.stringify(highlightUrgent));
    }, [highlightUrgent]);

    React.useEffect(() => {
        localStorage.setItem('hideCompleted', JSON.stringify(hideCompleted));
    }, [hideCompleted]);

    // çµ±è¨ˆ
    const stats = React.useMemo(() => {
        if (!todayStr) return { total: 0, checkpoints: 0, pendingHigh: 0, completed: 0, lateStart: 0, delayed: 0 };
        const baseTasks = tasks.filter(t => filterTeam === 'All' || (t.team && t.team === filterTeam));
        return {
            total: baseTasks.length,
            checkpoints: baseTasks.filter(t => t.isCheckpoint).length,
            pendingHigh: baseTasks.filter(t => t.priority === 'High' && t.status !== 'Done').length,
            completed: baseTasks.filter(t => t.status === 'Done').length,
            lateStart: baseTasks.filter(t => {
                const startDate = getStartDate(t.date, t.duration);
                return t.status === 'Todo' && startDate <= todayStr && t.date >= todayStr;
            }).length,
            delayed: baseTasks.filter(t => t.date < todayStr && t.status !== 'Done' && t.status !== 'Closed' && t.status !== 'Pending' && t.taskType !== 'recurring').length
        };
    }, [tasks, todayStr, filterTeam]);

    // ç¯©é¸ä»»å‹™
    const filteredTasks = React.useMemo(() => {
        const filterFunctions = {
            'Checkpoints': (t) => t.isCheckpoint,
            'Urgent': (t) => t.status !== 'Done' && t.priority === 'High',
            'Completed': (t) => t.status === 'Done',
            'LateStart': (t) => {
                const startDate = getStartDate(t.date, t.duration);
                return t.status === 'Todo' && startDate <= todayStr && t.date >= todayStr;
            },
            'Delayed': (t) => t.date < todayStr && t.status !== 'Done' && t.status !== 'Closed' && t.status !== 'Pending' && t.taskType !== 'recurring'
        };

        let result = tasks.filter(t => {
            if (filterTeam === 'All') return true;
            if (filterTeam === 'issue' || filterTeam === 'Issue') {
                return (t.team && (t.team === 'issue' || t.team === 'Issue')) || t.issuePool === true;
            }
            return t.team && t.team === filterTeam;
        });

        if (filterProject !== 'All') {
            result = result.filter(t => t.project && t.project === filterProject);
        }

        if (filterStat && filterFunctions[filterStat]) {
            result = result.filter(filterFunctions[filterStat]);
        }

        if (searchQuery.trim()) {
            const query = searchQuery.trim();
            const prefixMatch = query.match(/^(project|owner|pic|team|task|note|category|purpose|status):(.*)/i);

            if (prefixMatch) {
                const field = prefixMatch[1].toLowerCase();
                const searchValue = prefixMatch[2].toLowerCase();
                result = result.filter(t => {
                    switch (field) {
                        case 'project': return t.project && String(t.project).toLowerCase().includes(searchValue);
                        case 'owner': case 'pic': return t.owner && String(t.owner).toLowerCase().includes(searchValue);
                        case 'team': return t.team && String(t.team).toLowerCase().includes(searchValue);
                        case 'task': return t.task && String(t.task).toLowerCase().includes(searchValue);
                        case 'note': return t.notes && String(t.notes).toLowerCase().includes(searchValue);
                        case 'category': return t.category && String(t.category).toLowerCase().includes(searchValue);
                        case 'purpose': return t.purpose && String(t.purpose).toLowerCase().includes(searchValue);
                        case 'status': return t.status && String(t.status).toLowerCase().includes(searchValue);
                        default: return false;
                    }
                });
            } else {
                const lowerQuery = query.toLowerCase();
                result = result.filter(t => {
                    const matchTask = t.task && String(t.task).toLowerCase().includes(lowerQuery);
                    const matchOwner = t.owner && String(t.owner).toLowerCase().includes(lowerQuery);
                    const matchNotes = t.notes && String(t.notes).toLowerCase().includes(lowerQuery);
                    const matchCategory = t.category && String(t.category).toLowerCase().includes(lowerQuery);
                    const matchTeam = t.team && String(t.team).toLowerCase().includes(lowerQuery);
                    const matchProject = t.project && String(t.project).toLowerCase().includes(lowerQuery);
                    const matchPurpose = t.purpose && String(t.purpose).toLowerCase().includes(lowerQuery);
                    return matchTask || matchOwner || matchNotes || matchCategory || matchTeam || matchProject || matchPurpose;
                });
            }
        }

        if (hideCompleted) {
            result = result.filter(t => t.status !== 'Done' && t.status !== 'Pending');
        }

        return result;
    }, [tasks, filterTeam, filterProject, filterStat, todayStr, searchQuery, hideCompleted]);

    // è­¦å‘Šè¨Šæ¯
    const alerts = React.useMemo(() => {
        if (!todayStr) return [];
        const list = [];
        const overdueCount = tasks.filter(t => t.date < todayStr && t.status !== 'Done' && t.status !== 'Closed' && t.status !== 'Pending' && t.taskType !== 'recurring').length;
        if (overdueCount > 0) list.push({ type: 'danger', msg: `æœ‰ ${overdueCount} å€‹ä»»å‹™å·²é€¾æœŸ` });
        if (apiError) list.push({ type: 'warning', msg: `ç³»çµ±é›¢ç·šä¸­ (${apiError})` });
        return list;
    }, [tasks, todayStr, apiError]);

    // Chart Data
    const chartData = React.useMemo(() => {
        const teamList = dynamicTeams.length > 0 ? dynamicTeams : TEAMS;
        return teamList.map(team => ({
            name: team,
            value: tasks.filter(t => t.team && t.team === team).length,
            color: getTeamColor(team)
        })).filter(item => item.value > 0);
    }, [tasks, dynamicTeams, TEAMS]);

    const toggleStatFilter = (type) => {
        setFilterStat(prev => prev === type ? null : type);
        setViewMode('dashboard');
    };

    return {
        // State
        filterTeam,
        setFilterTeam,
        filterProject,
        setFilterProject,
        filterStat,
        setFilterStat,
        searchQuery,
        setSearchQuery,
        ganttFilterTeam,
        setGanttFilterTeam,
        showDependencies,
        setShowDependencies,
        viewMode,
        setViewMode,
        highlightUrgent,
        setHighlightUrgent,
        hideCompleted,
        setHideCompleted,
        // Computed
        stats,
        filteredTasks,
        alerts,
        chartData,
        toggleStatFilter
    };
}

// å°å‡ºåˆ° window
window.useFilters = useFilters;


    </script>
    <!-- WBS Phase 3: Hooks -->
    <script type="text/babel">
/**
 * useWbsApi Hook
 * WBS (Work Breakdown Structure) ç›¸é—œ API å°è£
 * ç®¡ç†ä»»å‹™æ¨¹çµæ§‹çš„è¼‰å…¥ã€ç§»å‹•ã€æ’åºå’ŒåŒ¯å…¥
 */

const { useState, useCallback } = React;

const useWbsApi = () => {
    // ç‹€æ…‹
    const [treeData, setTreeData] = useState({ tree: [], independent: [] });
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);

    /**
     * å–å¾—ä»»å‹™æ¨¹çµæ§‹
     * @param {string} projectId - å¯é¸ï¼Œç¯©é¸ç‰¹å®šå°ˆæ¡ˆ
     */
    const fetchTaskTree = useCallback(async (projectId = '') => {
        setIsLoading(true);
        setError(null);
        try {
            const result = await window.callApi('getTaskTree', {
                projectId,
                includeIndependent: true
            });
            if (result.success) {
                setTreeData({
                    tree: result.tree || [],
                    independent: result.independent || []
                });
                console.log('[useWbsApi] ä»»å‹™æ¨¹è¼‰å…¥æˆåŠŸ:', result.tree?.length, 'æ ¹ç¯€é»');
            } else {
                throw new Error(result.error || 'æœªçŸ¥éŒ¯èª¤');
            }
        } catch (err) {
            console.error('[useWbsApi] fetchTaskTree éŒ¯èª¤:', err);
            setError(err.message || err.toString());
        } finally {
            setIsLoading(false);
        }
    }, []);

    /**
     * ç§»å‹•ä»»å‹™åˆ°æ–°çˆ¶ç¯€é»
     * @param {string} taskId - è¦ç§»å‹•çš„ä»»å‹™ ID
     * @param {string} newParentId - æ–°çˆ¶ç¯€é» ID (ç©ºå­—ä¸²è¡¨ç¤ºç§»è‡³æ ¹ç¯€é»)
     * @param {number} newSortOrder - æ–°æ’åºä½ç½®
     */
    const moveTask = useCallback(async (taskId, newParentId, newSortOrder = 0) => {
        setIsLoading(true);
        setError(null);
        try {
            const result = await window.callApi('moveTask', {
                taskId,
                newParentId,
                newSortOrder
            });
            if (result.success) {
                console.log('[useWbsApi] ä»»å‹™ç§»å‹•æˆåŠŸ:', result.message);
                // é‡æ–°è¼‰å…¥æ¨¹ç‹€çµæ§‹
                await fetchTaskTree();
                return true;
            } else {
                throw new Error(result.error || 'ç§»å‹•å¤±æ•—');
            }
        } catch (err) {
            console.error('[useWbsApi] moveTask éŒ¯èª¤:', err);
            setError(err.message || err.toString());
            return false;
        } finally {
            setIsLoading(false);
        }
    }, [fetchTaskTree]);

    /**
     * æ‰¹æ¬¡æ’åºä»»å‹™
     * @param {string} parentId - çˆ¶ç¯€é» ID
     * @param {string[]} taskIds - æ’åºå¾Œçš„ä»»å‹™ ID é™£åˆ—
     */
    const reorderTasks = useCallback(async (parentId, taskIds) => {
        setIsLoading(true);
        setError(null);
        try {
            const result = await window.callApi('reorderTasks', { parentId, taskIds });
            if (result.success) {
                console.log('[useWbsApi] æ’åºæˆåŠŸ');
                await fetchTaskTree();
                return true;
            } else {
                throw new Error(result.error || 'æ’åºå¤±æ•—');
            }
        } catch (err) {
            console.error('[useWbsApi] reorderTasks éŒ¯èª¤:', err);
            setError(err.message || err.toString());
            return false;
        } finally {
            setIsLoading(false);
        }
    }, [fetchTaskTree]);

    /**
     * è§£æ Markdown WBS æ–‡å­—
     * @param {string} markdownText - Markdown æ ¼å¼çš„ WBS æ–‡å­—
     */
    const parseMarkdown = useCallback(async (markdownText) => {
        setIsLoading(true);
        setError(null);
        try {
            const result = await window.callApi('parseMarkdownWBS', { markdownText });
            if (result.success) {
                console.log('[useWbsApi] Markdown è§£ææˆåŠŸ:', result.count, 'å€‹ä»»å‹™');
                return result.tasks;
            } else {
                throw new Error(result.error || 'è§£æå¤±æ•—');
            }
        } catch (err) {
            console.error('[useWbsApi] parseMarkdown éŒ¯èª¤:', err);
            setError(err.message || err.toString());
            return null;
        } finally {
            setIsLoading(false);
        }
    }, []);

    /**
     * è§£æ YAML WBS ç‰©ä»¶
     * @param {Object} yamlObj - ç”± js-yaml è§£æå¾Œçš„ JavaScript ç‰©ä»¶
     * @param {string} projectStartDate - å°ˆæ¡ˆèµ·å§‹æ—¥æœŸ (YYYY-MM-DD)
     */
    const parseYaml = useCallback(async (yamlObj, projectStartDate) => {
        setIsLoading(true);
        setError(null);
        try {
            const result = await window.callApi('parseYamlWBS', { yamlObj, projectStartDate });
            if (result.success) {
                console.log('[useWbsApi] YAML è§£ææˆåŠŸ:', result.count, 'å€‹ä»»å‹™');
                return result.tasks;
            } else {
                throw new Error(result.error || 'è§£æå¤±æ•—');
            }
        } catch (err) {
            console.error('[useWbsApi] parseYaml éŒ¯èª¤:', err);
            setError(err.message || err.toString());
            return null;
        } finally {
            setIsLoading(false);
        }
    }, []);

    /**
     * æ‰¹æ¬¡åŒ¯å…¥ WBS ä»»å‹™
     * @param {Array} tasks - è§£æå¾Œçš„ä»»å‹™é™£åˆ— (åŒ…å« tempId, parentId ç­‰)
     */
    const importTasks = useCallback(async (tasks) => {
        setIsLoading(true);
        setError(null);
        try {
            const result = await window.callApi('importWBSTasks', { tasks });
            if (result.success) {
                console.log('[useWbsApi] åŒ¯å…¥æˆåŠŸ:', result.message);
                // é‡æ–°è¼‰å…¥æ¨¹ç‹€çµæ§‹
                await fetchTaskTree();
                return result;
            } else {
                throw new Error(result.error || 'åŒ¯å…¥å¤±æ•—');
            }
        } catch (err) {
            console.error('[useWbsApi] importTasks éŒ¯èª¤:', err);
            setError(err.message || err.toString());
            return null;
        } finally {
            setIsLoading(false);
        }
    }, [fetchTaskTree]);

    /**
     * æª¢æŸ¥é‡è¤‡ä»»å‹™
     * @param {string} scope - 'global' | 'project'
     * @param {string} projectId - å°ˆæ¡ˆ ID (scope ç‚º 'project' æ™‚å¿…å¡«)
     * @param {string} mode - 'strict' | 'fuzzy'
     */
    const checkDuplicates = useCallback(async (scope = 'global', projectId = '', mode = 'strict') => {
        setIsLoading(true);
        setError(null);
        try {
            const result = await window.callApi('checkDuplicateTasks', { scope, projectId, mode });
            if (result.success) {
                console.log('[useWbsApi] é‡è¤‡æª¢æŸ¥å®Œæˆ:', result.totalDuplicates, 'å€‹é‡è¤‡');
                return result;
            } else {
                throw new Error(result.error || 'æª¢æŸ¥å¤±æ•—');
            }
        } catch (err) {
            console.error('[useWbsApi] checkDuplicates éŒ¯èª¤:', err);
            setError(err.message || err.toString());
            return null;
        } finally {
            setIsLoading(false);
        }
    }, []);

    /**
     * æ›´æ–°æœ¬åœ°ä»»å‹™æ¨¹è³‡æ–™ (ä¸é‡æ–° fetch)
     * ç”¨æ–¼æ¨‚è§€æ›´æ–° (Optimistic Update)
     */
    const updateLocalTask = useCallback((taskId, updates) => {
        setTreeData(prev => {
            const newTree = structuredClone(prev.tree);
            const newIndependent = [...prev.independent];

            // éè¿´å°‹æ‰¾ä¸¦æ›´æ–°
            const updateNode = (nodes) => {
                for (let i = 0; i < nodes.length; i++) {
                    if (nodes[i].id === taskId) {
                        nodes[i] = { ...nodes[i], ...updates };
                        return true;
                    }
                    if (nodes[i].children && nodes[i].children.length > 0) {
                        if (updateNode(nodes[i].children)) return true;
                    }
                }
                return false;
            };

            // å…ˆæ‰¾ Tree
            if (!updateNode(newTree)) {
                // æ²’æ‰¾åˆ°ï¼Œæ‰¾ Independent
                const idx = newIndependent.findIndex(t => t.id === taskId);
                if (idx !== -1) {
                    newIndependent[idx] = { ...newIndependent[idx], ...updates };
                }
            }

            return { tree: newTree, independent: newIndependent };
        });
    }, []);

    return {
        // ç‹€æ…‹
        treeData,
        isLoading,
        error,

        // æ–¹æ³•
        fetchTaskTree,
        moveTask,
        reorderTasks,
        parseMarkdown,
        parseYaml,
        importTasks,
        checkDuplicates,
        updateLocalTask // ğŸ†• åŒ¯å‡ºæ­¤æ–¹æ³•
    };
};

// å°å‡ºåˆ° window (éµå¾ªç¾æœ‰æ…£ä¾‹)
window.useWbsApi = useWbsApi;

</script>

    
    <!-- React Contexts -->
    <script type="text/babel">
// ===== contexts/AppContext.jsx =====
/**
 * AppContext
 * æä¾›å…¨åŸŸç‹€æ…‹ç®¡ç†ï¼Œé¿å… Prop Drilling
 */

const AppContext = React.createContext(null);

const AppProvider = ({ children, value }) => {
    return (
        <AppContext.Provider value={value}>
            {children}
        </AppContext.Provider>
    );
};

// Custom Hook for easier usage
const useAppContext = () => {
    const context = React.useContext(AppContext);
    if (!context) {
        throw new Error('useAppContext must be used within an AppProvider');
    }
    return context;
};

// å°å‡ºåˆ° window
window.AppContext = AppContext;
window.AppProvider = AppProvider;
window.useAppContext = useAppContext;


    </script>

    
    <!-- App Component -->
    <script type="text/babel">
/**
 * App Component
 * é‡æ§‹å¾Œä½¿ç”¨ hooks ç®¡ç†è³‡æ–™èˆ‡ç¯©é¸
 */

// ç¢ºä¿ React Hooks å¯ç”¨
const { useState, useEffect, useMemo, useRef } = React;
// ç¢ºä¿ Recharts çµ„ä»¶å¯ç”¨
const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } = window.Recharts || {};

const App = () => {
    // âœ… ä½¿ç”¨ useAuth hook ç®¡ç†èªè­‰ (Session Mode)
    const { isAuthenticated, user, isLoading: isAuthLoading, authError, checkSession, handleLogout } = useAuth();

    // æ¬Šé™æª¢æŸ¥ Helper
    const hasPermission = (role) => {
        if (!user || !user.permission) return false;
        if (user.permission === 'admin') return true; // Admin has all permissions
        if (role === 'editor' && user.permission === 'editor') return true;
        return user.permission === role;
    };

    // âœ… UI ç›¸é—œç‹€æ…‹
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingTask, setEditingTask] = useState(null);
    const [todayStr, setTodayStr] = useState('');
    const [calendarMonth, setCalendarMonth] = useState(new Date());
    const [isMobile, setIsMobile] = useState(false);

    // ğŸ†• é€±å ± Modal ç‹€æ…‹
    const [isReportModalOpen, setIsReportModalOpen] = useState(false);
    const [reportData, setReportData] = useState(null);


    // âœ… Phase 1: å‹•æ…‹ä¸»è³‡æ–™
    const [dynamicTeams, setDynamicTeams] = useState([]);
    const [dynamicProjects, setDynamicProjects] = useState([]);
    const [dynamicOwners, setDynamicOwners] = useState([]);
    const [teamsFullData, setTeamsFullData] = useState([]); // æ–°å¢ï¼šå« Leader è³‡è¨Šçš„å®Œæ•´ Teams

    // å‚™ä»½åˆ—è¡¨
    const TEAMS_FALLBACK = ['æ™¶ç‰‡', 'æ©Ÿæ§‹', 'è»Ÿé«”', 'é›»æ§', 'æµé“', 'ç”Ÿé†«', 'QA', 'ç®¡ç†', 'issue'];
    const PROJECTS_FALLBACK = ['CKSX', 'Jamstec', 'Genentech', '5880 Chip', 'Internal', 'TBD', 'Other'];
    const OWNERS_FALLBACK = ['Anting', 'å®—è½…', 'Jerry', 'å­å®—', 'Jun', 'æ…¶å¾·', 'HW', 'EE', 'RD', 'QA', 'SW', 'All', 'Unassigned'];

    const TEAMS = dynamicTeams.length > 0 ? dynamicTeams : TEAMS_FALLBACK;
    const PROJECTS = dynamicProjects.length > 0 ? dynamicProjects : PROJECTS_FALLBACK;
    const OWNERS = dynamicOwners.length > 0 ? dynamicOwners : OWNERS_FALLBACK;

    const {
        tasks,
        setTasks,
        isLoading,
        isOffline,
        apiError,
        dataSource,
        uploadProgress,
        fileInputRef,
        handleFileUpload,
        handleSave: taskDataHandleSave,
        handleDelete,
        updateTaskStatus,
        // ğŸ†• åŒæ­¥åˆ°é›²ç«¯
        handleSyncToCloud,
        syncProgress,
        isSyncing
    } = useTaskData(isAuthenticated);

    // âœ… ä½¿ç”¨ useFilters hook
    const {
        filterTeam,
        setFilterTeam,
        filterProject,
        setFilterProject,
        filterStat,
        searchQuery,
        setSearchQuery,
        ganttFilterTeam,
        setGanttFilterTeam,
        showDependencies,
        setShowDependencies,
        viewMode,
        setViewMode,
        highlightUrgent,
        setHighlightUrgent,
        hideCompleted,
        setHideCompleted,
        stats,
        filteredTasks,
        alerts,
        chartData,
        toggleStatFilter
    } = useFilters(tasks, todayStr, apiError, dynamicTeams, TEAMS);

    // ==================== Effects ====================

    // åµæ¸¬è¡Œå‹•è£ç½®
    useEffect(() => {
        const checkMobile = () => setIsMobile(window.innerWidth < 768);
        checkMobile();
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
    }, []);

    // åˆå§‹åŒ–æ—¥æœŸ
    useEffect(() => {
        setTodayStr(getTaiwanToday());
        setCalendarMonth(new Date());
    }, []);

    // ğŸ†• ç›£è½é€±å ±äº‹ä»¶
    useEffect(() => {
        const handleShowReport = (e) => {
            setReportData(e.detail);
            setIsReportModalOpen(true);
        };

        window.addEventListener('showWeeklyReport', handleShowReport);
        return () => window.removeEventListener('showWeeklyReport', handleShowReport);
    }, []);

    // âœ… Phase 1: è¼‰å…¥å‹•æ…‹ä¸»è³‡æ–™
    useEffect(() => {
        const loadMasterData = async () => {
            try {
                // âœ… ä½¿ç”¨ callApiå¹³è¡Œè«‹æ±‚
                const [teamsData, projectsData, ownersData] = await Promise.all([
                    window.callApi('getTeams'),
                    window.callApi('getProjects'),
                    window.callApi('getOwners')
                ]);

                if (teamsData.success) {
                    setDynamicTeams(teamsData.data.filter(t => t.isActive).map(t => t.teamName));
                    setTeamsFullData(teamsData.data.filter(t => t.isActive)); // ä¿å­˜å®Œæ•´è³‡æ–™å« Leader
                    console.log('âœ… å‹•æ…‹è¼‰å…¥ Teams:', teamsData.data.length);
                }

                if (projectsData.success) {
                    setDynamicProjects(projectsData.data.map(p => p.projectName));
                    console.log('âœ… å‹•æ…‹è¼‰å…¥ Projects:', projectsData.data.length);
                }

                if (ownersData.success) {
                    setDynamicOwners(ownersData.data.filter(o => o.isActive).map(o => o.ownerName));
                    console.log('âœ… å‹•æ…‹è¼‰å…¥ Owners:', ownersData.data.length);
                }
            } catch (error) {
                console.error('âŒ è¼‰å…¥ä¸»è³‡æ–™å¤±æ•—:', error);
            }
        };
        if (isAuthenticated && !isOffline) {
            loadMasterData();
        }
    }, [isAuthenticated, isOffline]);

    // ==================== äº‹ä»¶è™•ç†å‡½æ•¸ ====================

    // åŒ…è£ handleSave ä»¥é—œé–‰ modal
    const handleSave = (e) => {
        const success = taskDataHandleSave(e, editingTask, todayStr);
        if (success) {
            setIsModalOpen(false);
        }
    };

    // è§£æç›¸ä¾æ€§å­—ä¸²
    const parseDependencies = (depStr) => {
        if (!depStr || typeof depStr !== 'string') return [];
        return depStr.split(',').map(id => id.trim()).filter(id => id);
    };



    const changeMonth = (delta) => {
        const d = new Date(calendarMonth);
        d.setMonth(d.getMonth() + delta);
        setCalendarMonth(d);
    };

    // ==================== æº–å‚™ Context Value ====================

    const contextValue = {
        // Auth
        isAuthenticated, checkSession, handleLogout,

        // UI State
        isModalOpen, setIsModalOpen,
        editingTask, setEditingTask,
        todayStr,
        calendarMonth, setCalendarMonth,
        isMobile,
        viewMode, setViewMode,

        // Master Data
        dynamicTeams, setDynamicTeams,
        dynamicProjects, setDynamicProjects,
        dynamicOwners, setDynamicOwners,
        TEAMS, PROJECTS, OWNERS,

        // Task Data (from useTaskData)
        tasks, setTasks,
        isLoading, isOffline, apiError, dataSource,
        uploadProgress, fileInputRef,
        handleFileUpload,
        handleSave: handleSave, // Use the wrapper
        handleDelete,
        updateTaskStatus,

        // Auth info for permission checking
        user, hasPermission,

        // Filters & Stats (from useFilters)
        filterTeam, setFilterTeam,
        filterProject, setFilterProject,
        filterStat, toggleStatFilter,
        searchQuery, setSearchQuery,
        ganttFilterTeam, setGanttFilterTeam,
        showDependencies, setShowDependencies,
        highlightUrgent, setHighlightUrgent,
        hideCompleted, setHideCompleted,
        stats, filteredTasks, alerts, chartData
    };

    // ==================== æ¸²æŸ“è¦–åœ– ====================

    // ç™»å…¥æª¢æŸ¥
    if (!isAuthenticated) {
        if (authError) {
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50 px-4">
                    <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 border border-red-100 text-center">
                        <div className="mb-4 text-red-500">
                            <Icon path={paths.alert} size={48} className="mx-auto" />
                        </div>
                        <h3 className="text-xl font-bold text-slate-800 mb-2">é©—è­‰å¤±æ•—</h3>
                        <span className="text-slate-400 text-xs text-center block mt-4">v7.6.0</span>
                        <p className="text-red-600 mb-6 bg-red-50 p-3 rounded">{authError}</p>
                        <button onClick={checkSession} className="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                            é‡è©¦é©—è­‰
                        </button>
                    </div>
                </div>
            );
        }
        return <LoginScreen />;
    }

    return (
        <AppProvider value={contextValue}>
            <div className="min-h-screen pb-10">
                {/* Header */}
                <div className="bg-white border-b sticky top-0 z-30 shadow-sm px-6 py-4 flex justify-between items-center">
                    <div className="flex items-center gap-3">
                        <div className="bg-indigo-600 text-white p-2 rounded-lg"><Icon path={paths.list} /></div>
                        <h1 className="text-xl font-bold text-slate-800">Project Tracker <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">v7.6.0</span></h1>
                        {isLoading && <div className="flex items-center text-sm text-slate-500 gap-2 ml-4"><div className="w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full spinner"></div> è¼‰å…¥ä¸­...</div>}
                        {uploadProgress && <div className="flex items-center text-sm text-indigo-600 gap-2 ml-4 bg-indigo-50 px-2 py-1 rounded"><Icon path={paths.file} size={14} /> {uploadProgress}</div>}
                        {syncProgress && <div className="flex items-center text-sm text-blue-600 gap-2 ml-4 bg-blue-50 px-2 py-1 rounded"><div className="w-3 h-3 border-2 border-blue-600 border-t-transparent rounded-full spinner"></div> {syncProgress}</div>}
                        {isOffline && dataSource === 'excel' && (
                            <div className="flex items-center gap-2 ml-4">
                                <div className="flex items-center text-sm text-emerald-600 gap-2 bg-emerald-50 px-2 py-1 rounded"><Icon path={paths.file} size={14} /> Excel æ¨¡å¼</div>
                                {hasPermission('admin') && (
                                    <button
                                        onClick={handleSyncToCloud}
                                        disabled={isSyncing}
                                        className="flex items-center text-sm text-white gap-2 bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded shadow-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                                        title="å°‡ Excel è³‡æ–™åŒæ­¥åˆ° Google Sheets (Admin Only)"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                                        {isSyncing ? 'åŒæ­¥ä¸­...' : 'åŒæ­¥åˆ°é›²ç«¯'}
                                    </button>
                                )}
                            </div>
                        )}
                        {isOffline && dataSource === 'google' && <div className="flex items-center text-sm text-red-500 gap-2 ml-4 bg-red-50 px-2 py-1 rounded"><Icon path={paths.alert} size={14} /> é›¢ç·š</div>}

                        <div className="text-xs bg-slate-100 text-slate-500 px-3 py-1 rounded-full hidden sm:block ml-4 flex items-center gap-1">
                            <Icon path={paths.clock} size={12} /> {todayStr}
                        </div>
                        {isAuthenticated && user && (
                            <div className="ml-4 text-xs bg-yellow-50 text-yellow-700 px-2 py-1 rounded border border-yellow-200" title="Debug Info">
                                ğŸ”§ Role: {user.permission} ({user.email})
                            </div>
                        )}
                    </div>
                    <div className="flex items-center gap-4">
                        {/* è¦–åœ–åˆ‡æ›æŒ‰éˆ•çµ„ */}
                        <div className="bg-slate-100 p-1 rounded-lg flex gap-1">
                            <button onClick={() => setViewMode('dashboard')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'dashboard' ? 'bg-white text-indigo-600 shadow-md' : 'text-slate-600 hover:text-slate-900'}`} title="åˆ—è¡¨"><Icon path={paths.list} size={16} /><span className="hidden sm:inline">åˆ—è¡¨</span></button>
                            <button onClick={() => setViewMode('calendar')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'calendar' ? 'bg-white text-indigo-600 shadow-md' : 'text-slate-600 hover:text-slate-900'}`} title="æ—¥æ›†"><Icon path={paths.calendar} size={16} /><span className="hidden sm:inline">æ—¥æ›†</span></button>
                            <button onClick={() => setViewMode('gantt')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'gantt' ? 'bg-white text-indigo-600 shadow-md' : 'text-slate-600 hover:text-slate-900'}`} title="ç”˜ç‰¹åœ–"><Icon path={paths.gantt} size={16} /><span className="hidden sm:inline">ç”˜ç‰¹åœ–</span></button>
                            <button onClick={() => setViewMode('topic')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'topic' ? 'bg-white text-indigo-600 shadow-md' : 'text-slate-600 hover:text-slate-900'}`} title="Topicè¿½è¹¤">ğŸ“‹<span className="hidden sm:inline">Topic</span></button>
                            <button onClick={() => setViewMode('wbs')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center gap-2 ${viewMode === 'wbs' ? 'bg-white text-indigo-600 shadow-md' : 'text-slate-600 hover:text-slate-900'}`} title="WBS çµæ§‹">ğŸ¯<span className="hidden sm:inline">WBS</span></button>
                            {hasPermission('admin') && (
                                <button onClick={() => setViewMode('settings')} className={`px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200 ${viewMode === 'settings' ? 'bg-indigo-100 text-indigo-700 shadow-sm ring-2 ring-indigo-200' : 'text-slate-600 hover:bg-slate-100 hover:text-slate-800'}`} title="è¨­å®š"><Icon path={paths.settings} size={16} /><span className="hidden sm:inline">è¨­å®š</span></button>
                            )}

                        </div>
                        <div className="w-px h-8 bg-slate-300"></div>
                        {/* Excel ä¸Šå‚³æŒ‰éˆ• */}
                        <button onClick={() => fileInputRef.current?.click()} className="bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5"><Icon path={paths.file} size={16} /><span className="hidden sm:inline">ä¸Šå‚³ Excel</span></button>
                        <input ref={fileInputRef} type="file" accept=".xlsx,.xls,.csv" onChange={handleFileUpload} className="hidden" />
                        {/* ç™»å‡ºæŒ‰éˆ• */}
                        <button onClick={handleLogout} className="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200" title="ç™»å‡º"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg><span className="hidden sm:inline">ç™»å‡º</span></button>
                        <button onClick={() => { setEditingTask(null); setIsModalOpen(true); }} className="bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-0.5"><Icon path={paths.plus} size={16} /><span className="hidden sm:inline">æ–°å¢</span></button>
                    </div>
                </div>

                <div className="max-w-7xl mx-auto px-4 py-8">
                    {/* Alerts */}
                    {alerts.length > 0 && (
                        <div className="mb-6 grid gap-2">
                            {alerts.map((a, i) => (
                                <div key={i} className={`p-3 rounded-md border flex items-center gap-2 text-sm font-medium ${a.type === 'danger' ? 'bg-red-50 border-red-200 text-red-700' : 'bg-orange-50 border-orange-200 text-orange-700'}`}>
                                    <Icon path={paths.alert} size={16} /> {a.msg}
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Main Content */}
                    {viewMode === 'gantt' ? (
                        <>
                            <div className="bg-white rounded-lg border border-slate-200 shadow-sm p-4 space-y-3 mb-6">
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"><Icon path={paths.search} size={16} /></div>
                                    <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="æœå°‹ä»»å‹™æˆ–è² è²¬äºº..." className="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" />
                                    {searchQuery && <button onClick={() => setSearchQuery('')} className="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors"><Icon path={paths.x} size={16} /></button>}
                                </div>
                            </div>
                            <GanttView />
                        </>
                    ) : viewMode === 'settings' ? (
                        <SettingsView />
                    ) : viewMode === 'calendar' ? (
                        <CalendarView />
                    ) : viewMode === 'topic' ? (
                        <TopicView />
                    ) : viewMode === 'wbs' ? (
                        <WBSView />
                    ) : (
                        <Dashboard />
                    )}
                </div>

                {/* Modal */}
                {isModalOpen && (
                    <TaskModal
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                        editingTask={editingTask}
                        onSubmit={handleSave}

                        TEAMS={TEAMS}
                        PROJECTS={PROJECTS}
                        OWNERS={OWNERS}
                        CATEGORIES={['Frontend', 'Backend', 'Database', 'DevOps', 'Testing', 'Design', 'Other']}
                        tasks={tasks}
                        userPermission={user?.permission || 'viewer'}
                        teamsData={teamsFullData}
                        apiUrl={window.GAS_API_URL || ''}
                    />
                )}



                {/* ğŸ†• é€±å ± Modal */}
                <ReportModal
                    isOpen={isReportModalOpen}
                    onClose={() => setIsReportModalOpen(false)}
                    reportData={reportData}
                />
            </div>
        </AppProvider>
    );
};

    </script>

    <!-- ==================== å¤–éƒ¨çµ„ä»¶å¼•å…¥ ==================== -->
    <!-- Phase 1: ç³»çµ±ç®¡ç†ä»‹é¢ -->
    <script type="text/babel">
// ==================== Phase 1: ç³»çµ±ç®¡ç†ä»‹é¢çµ„ä»¶ ====================
// å°‡æ­¤ä»£ç¢¼æ’å…¥åˆ° index.html çš„ App çµ„ä»¶å®šç¾©ä¹‹å‰ï¼ˆç´„ç¬¬ 2100 è¡Œä¹‹å‰ï¼‰

// ===== Settings Iconï¼ˆå·²å®šç¾©åœ¨ paths ä¸­ï¼Œç¢ºèªæ˜¯å¦å­˜åœ¨ï¼‰=====

// ===== SettingsView ä¸»çµ„ä»¶ =====
const SettingsView = () => {
    const [activeTab, setActiveTab] = useState('teams');
    const [teams, setTeams] = useState([]);
    const [projects, setProjects] = useState([]);
    const [owners, setOwners] = useState([]);
    const [loading, setLoading] = useState(false);

    // è¼‰å…¥æ‰€æœ‰è³‡æ–™
    useEffect(() => {
        loadAllData();
    }, []);

    const loadAllData = async () => {
        setLoading(true);
        try {
            await Promise.all([loadTeams(), loadProjects(), loadOwners()]);
        } catch (error) {
            console.error('âŒ è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
        } finally {
            setLoading(false);
        }
    };

    const loadTeams = async () => {
        try {
            const data = await window.callApi('getTeams');
            if (data.success) {
                setTeams(data.data);
                console.log('âœ… è¼‰å…¥ Teams:', data.data.length);
            }
        } catch (error) {
            console.error('âŒ è¼‰å…¥ Teams å¤±æ•—:', error);
        }
    };

    const loadProjects = async () => {
        try {
            const data = await window.callApi('getProjects');
            if (data.success) {
                setProjects(data.data);
                console.log('âœ… è¼‰å…¥ Projects:', data.data.length);
            }
        } catch (error) {
            console.error('âŒ è¼‰å…¥ Projects å¤±æ•—:', error);
        }
    };

    const loadOwners = async () => {
        try {
            const data = await window.callApi('getOwners');
            if (data.success) {
                setOwners(data.data);
                console.log('âœ… è¼‰å…¥ Owners:', data.data.length);
            }
        } catch (error) {
            console.error('âŒ è¼‰å…¥ Owners å¤±æ•—:', error);
        }
    };

    return (
        <div className="min-h-screen bg-slate-50 p-6">
            <div className="max-w-6xl mx-auto">
                {/* æ¨™é¡Œ */}
                <div className="mb-6">
                    <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                        <Icon path={paths.settings} size={28} />
                        ç³»çµ±è¨­å®š
                    </h1>
                    <p className="text-sm text-slate-500 mt-1">ç®¡ç†éƒ¨é–€ã€å°ˆæ¡ˆå’Œè² è²¬äºº</p>
                </div>

                {/* Tabs */}
                <div className="bg-white rounded-lg shadow-sm border border-slate-200 mb-6">
                    <div className="flex border-b border-slate-200">
                        <button
                            onClick={() => setActiveTab('teams')}
                            className={`px-6 py-3 text-sm font-medium transition ${activeTab === 'teams'
                                ? 'text-indigo-600 border-b-2 border-indigo-600'
                                : 'text-slate-600 hover:text-slate-800'
                                }`}
                        >
                            Teams (éƒ¨é–€)
                        </button>
                        <button
                            onClick={() => setActiveTab('projects')}
                            className={`px-6 py-3 text-sm font-medium transition ${activeTab === 'projects'
                                ? 'text-indigo-600 border-b-2 border-indigo-600'
                                : 'text-slate-600 hover:text-slate-800'
                                }`}
                        >
                            Projects (å°ˆæ¡ˆ)
                        </button>
                        <button
                            onClick={() => setActiveTab('owners')}
                            className={`px-6 py-3 text-sm font-medium transition ${activeTab === 'owners'
                                ? 'text-indigo-600 border-b-2 border-indigo-600'
                                : 'text-slate-600 hover:text-slate-800'
                                }`}
                        >
                            Owners (è² è²¬äºº)
                        </button>
                    </div>
                </div>

                {/* Content */}
                {loading ? (
                    <div className="text-center py-12">
                        <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                        <p className="mt-2 text-slate-500">è¼‰å…¥ä¸­...</p>
                    </div>
                ) : (
                    <>
                        {activeTab === 'teams' && (
                            <TeamsManager
                                teams={teams}
                                onReload={loadTeams}
                            />
                        )}
                        {activeTab === 'projects' && (
                            <ProjectsManager
                                projects={projects}
                                onReload={loadProjects}
                            />
                        )}
                        {activeTab === 'owners' && (
                            <OwnersManager
                                owners={owners}
                                onReload={loadOwners}
                            />
                        )}
                    </>
                )}
            </div>
        </div>
    );
};

// ===== TeamsManager çµ„ä»¶ =====
const TeamsManager = ({ teams, onReload }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingItem, setEditingItem] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);

    const handleAdd = () => {
        setEditingItem(null);
        setIsModalOpen(true);
    };

    const handleEdit = (team) => {
        setEditingItem(team);
        setIsModalOpen(true);
    };

    const handleSave = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const teamData = {
            teamName: formData.get('teamName'),
            deptCode: formData.get('deptCode'),
            isActive: formData.get('isActive') === 'on'
        };

        if (editingItem) {
            teamData.id = editingItem.id;
        }

        try {
            const action = editingItem ? 'updateTeam' : 'addTeam';
            // ä½¿ç”¨ callApi æ›¿ä»£ fetch
            await window.callApi(action, teamData);

            console.log(`âœ… ${editingItem ? 'æ›´æ–°' : 'æ–°å¢'} Team æˆåŠŸ`);
            setIsModalOpen(false);
            // å»¶é²é‡æ–°è¼‰å…¥
            setTimeout(() => onReload(), 1000);
        } catch (error) {
            console.error('âŒ å„²å­˜å¤±æ•—:', error);
            alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
    };

    const handleDelete = async (id) => {
        try {
            await window.callApi('deleteTeam', { id });

            console.log('âœ… åˆªé™¤ Team æˆåŠŸ');
            setDeleteConfirm(null);
            setTimeout(() => onReload(), 1000);
        } catch (error) {
            console.error('âŒ åˆªé™¤å¤±æ•—:', error);
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
    };

    return (
        <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            {/* Header */}
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-semibold text-slate-800">éƒ¨é–€ç®¡ç†</h2>
                <button
                    onClick={handleAdd}
                    className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium"
                >
                    <Icon path={paths.plus} size={16} />
                    æ–°å¢éƒ¨é–€
                </button>
            </div>

            {/* Table */}
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ID</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">éƒ¨é–€åç¨±</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ä»£ç¢¼</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ç‹€æ…‹</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                        {teams.map((team) => (
                            <tr key={team.id} className="hover:bg-slate-50">
                                <td className="px-4 py-3 text-sm text-slate-600">{team.id}</td>
                                <td className="px-4 py-3 text-sm font-medium text-slate-800">{team.teamName}</td>
                                <td className="px-4 py-3 text-sm text-slate-600">
                                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                        {team.deptCode}
                                    </span>
                                </td>
                                <td className="px-4 py-3 text-sm">
                                    {team.isActive ? (
                                        <span className="text-green-600">âœ“ å•Ÿç”¨</span>
                                    ) : (
                                        <span className="text-slate-400">åœç”¨</span>
                                    )}
                                </td>
                                <td className="px-4 py-3 text-sm">
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => handleEdit(team)}
                                            className="text-indigo-600 hover:text-indigo-800"
                                            title="ç·¨è¼¯"
                                        >
                                            <Icon path={paths.edit} size={16} />
                                        </button>
                                        <button
                                            onClick={() => setDeleteConfirm(team)}
                                            className="text-red-600 hover:text-red-800"
                                            title="åˆªé™¤"
                                        >
                                            <Icon path={paths.trash} size={16} />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* Modal */}
            {isModalOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 className="text-lg font-semibold mb-4">
                            {editingItem ? 'ç·¨è¼¯éƒ¨é–€' : 'æ–°å¢éƒ¨é–€'}
                        </h3>
                        <form onSubmit={handleSave}>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        éƒ¨é–€åç¨± *
                                    </label>
                                    <input
                                        type="text"
                                        name="teamName"
                                        defaultValue={editingItem?.teamName}
                                        required
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        éƒ¨é–€ä»£ç¢¼ *
                                    </label>
                                    <input
                                        type="text"
                                        name="deptCode"
                                        defaultValue={editingItem?.deptCode}
                                        required
                                        maxLength={4}
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none uppercase"
                                    />
                                    <p className="text-xs text-slate-500 mt-1">2-4å€‹å¤§å¯«å­—æ¯</p>
                                </div>
                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        name="isActive"
                                        id="teamActive"
                                        defaultChecked={editingItem?.isActive !== false}
                                        className="w-4 h-4 text-indigo-600 border-gray-300 rounded"
                                    />
                                    <label htmlFor="teamActive" className="ml-2 text-sm text-slate-700">
                                        å•Ÿç”¨
                                    </label>
                                </div>
                            </div>
                            <div className="flex justify-end gap-2 mt-6">
                                <button
                                    type="button"
                                    onClick={() => setIsModalOpen(false)}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    type="submit"
                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                >
                                    å„²å­˜
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Delete Confirm */}
            {deleteConfirm && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-sm">
                        <h3 className="text-lg font-semibold mb-2">ç¢ºèªåˆªé™¤</h3>
                        <p className="text-sm text-slate-600 mb-4">
                            ç¢ºå®šè¦åˆªé™¤ã€Œ{deleteConfirm.teamName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚
                        </p>
                        <div className="flex justify-end gap-2">
                            <button
                                onClick={() => setDeleteConfirm(null)}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={() => handleDelete(deleteConfirm.id)}
                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                            >
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};



// ===== ProjectsManager çµ„ä»¶ =====
const ProjectsManager = ({ projects, onReload }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingItem, setEditingItem] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);

    const handleAdd = () => {
        setEditingItem(null);
        setIsModalOpen(true);
    };

    const handleEdit = (project) => {
        setEditingItem(project);
        setIsModalOpen(true);
    };

    const handleSave = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const projectData = {
            projectName: formData.get('projectName'),
            status: formData.get('status'),
            description: formData.get('description') || ''
        };

        if (editingItem) {
            projectData.id = editingItem.id;
        }

        try {
            const action = editingItem ? 'updateProject' : 'addProject';
            await window.callApi(action, projectData);

            console.log(`âœ… ${editingItem ? 'æ›´æ–°' : 'æ–°å¢'} Project æˆåŠŸ`);
            setIsModalOpen(false);
            setTimeout(() => onReload(), 1000);
        } catch (error) {
            console.error('âŒ å„²å­˜å¤±æ•—:', error);
            alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
    };

    const handleDelete = async (id) => {
        try {
            await window.callApi('deleteProject', { id });

            console.log('âœ… åˆªé™¤ Project æˆåŠŸ');
            setDeleteConfirm(null);
            setTimeout(() => onReload(), 1000);
        } catch (error) {
            console.error('âŒ åˆªé™¤å¤±æ•—:', error);
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
    };

    return (
        <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            {/* Header */}
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-semibold text-slate-800">å°ˆæ¡ˆç®¡ç†</h2>
                <button
                    onClick={handleAdd}
                    className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium"
                >
                    <Icon path={paths.plus} size={16} />
                    æ–°å¢å°ˆæ¡ˆ
                </button>
            </div>

            {/* Table */}
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ID</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">å°ˆæ¡ˆåç¨±</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ç‹€æ…‹</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">èªªæ˜</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                        {projects.map((project) => (
                            <tr key={project.id} className="hover:bg-slate-50">
                                <td className="px-4 py-3 text-sm text-slate-600">{project.id}</td>
                                <td className="px-4 py-3 text-sm font-medium text-slate-800">{project.projectName}</td>
                                <td className="px-4 py-3 text-sm">
                                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${project.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-600'
                                        }`}>
                                        {project.status}
                                    </span>
                                </td>
                                <td className="px-4 py-3 text-sm text-slate-600">{project.description || '-'}</td>
                                <td className="px-4 py-3 text-sm">
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => handleEdit(project)}
                                            className="text-indigo-600 hover:text-indigo-800"
                                            title="ç·¨è¼¯"
                                        >
                                            <Icon path={paths.edit} size={16} />
                                        </button>
                                        <button
                                            onClick={() => setDeleteConfirm(project)}
                                            className="text-red-600 hover:text-red-800"
                                            title="åˆªé™¤"
                                        >
                                            <Icon path={paths.trash} size={16} />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* Modal */}
            {isModalOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 className="text-lg font-semibold mb-4">
                            {editingItem ? 'ç·¨è¼¯å°ˆæ¡ˆ' : 'æ–°å¢å°ˆæ¡ˆ'}
                        </h3>
                        <form onSubmit={handleSave}>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        å°ˆæ¡ˆåç¨± *
                                    </label>
                                    <input
                                        type="text"
                                        name="projectName"
                                        defaultValue={editingItem?.projectName}
                                        required
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        ç‹€æ…‹
                                    </label>
                                    <select
                                        name="status"
                                        defaultValue={editingItem?.status || 'Active'}
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    >
                                        <option value="Active">Active</option>
                                        <option value="Completed">Completed</option>
                                        <option value="On Hold">On Hold</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        èªªæ˜
                                    </label>
                                    <textarea
                                        name="description"
                                        defaultValue={editingItem?.description}
                                        rows="3"
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    />
                                </div>
                            </div>
                            <div className="flex justify-end gap-2 mt-6">
                                <button
                                    type="button"
                                    onClick={() => setIsModalOpen(false)}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    type="submit"
                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                >
                                    å„²å­˜
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Delete Confirm */}
            {deleteConfirm && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-sm">
                        <h3 className="text-lg font-semibold mb-2">ç¢ºèªåˆªé™¤</h3>
                        <p className="text-sm text-slate-600 mb-4">
                            ç¢ºå®šè¦åˆªé™¤ã€Œ{deleteConfirm.projectName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚
                        </p>
                        <div className="flex justify-end gap-2">
                            <button
                                onClick={() => setDeleteConfirm(null)}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={() => handleDelete(deleteConfirm.id)}
                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                            >
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

// ===== OwnersManager çµ„ä»¶ =====
const OwnersManager = ({ owners, onReload }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingItem, setEditingItem] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);

    const handleAdd = () => {
        setEditingItem(null);
        setIsModalOpen(true);
    };

    const handleEdit = (owner) => {
        setEditingItem(owner);
        setIsModalOpen(true);
    };

    const handleSave = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const ownerData = {
            ownerName: formData.get('ownerName'),
            email: formData.get('email') || '',
            isActive: formData.get('isActive') === 'on'
        };

        if (editingItem) {
            ownerData.id = editingItem.id;
        }

        try {
            const action = editingItem ? 'updateOwner' : 'addOwner';
            await window.callApi(action, ownerData);

            console.log(`âœ… ${editingItem ? 'æ›´æ–°' : 'æ–°å¢'} Owner æˆåŠŸ`);
            setIsModalOpen(false);
            setTimeout(() => onReload(), 1000);
        } catch (error) {
            console.error('âŒ å„²å­˜å¤±æ•—:', error);
            alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
    };

    const handleDelete = async (id) => {
        try {
            await window.callApi('deleteOwner', { id });

            console.log('âœ… åˆªé™¤ Owner æˆåŠŸ');
            setDeleteConfirm(null);
            setTimeout(() => onReload(), 1000);
        } catch (error) {
            console.error('âŒ åˆªé™¤å¤±æ•—:', error);
            alert('åˆªé™¤å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
    };

    return (
        <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            {/* Header */}
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-semibold text-slate-800">è² è²¬äººç®¡ç†</h2>
                <button
                    onClick={handleAdd}
                    className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium"
                >
                    <Icon path={paths.plus} size={16} />
                    æ–°å¢è² è²¬äºº
                </button>
            </div>

            {/* Table */}
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-50">
                        <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ID</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">å§“å</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">Email</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ç‹€æ…‹</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                        {owners.map((owner) => (
                            <tr key={owner.id} className="hover:bg-slate-50">
                                <td className="px-4 py-3 text-sm text-slate-600">{owner.id}</td>
                                <td className="px-4 py-3 text-sm font-medium text-slate-800">{owner.ownerName}</td>
                                <td className="px-4 py-3 text-sm text-slate-600">{owner.email || '-'}</td>
                                <td className="px-4 py-3 text-sm">
                                    {owner.isActive ? (
                                        <span className="text-green-600">âœ“ å•Ÿç”¨</span>
                                    ) : (
                                        <span className="text-slate-400">åœç”¨</span>
                                    )}
                                </td>
                                <td className="px-4 py-3 text-sm">
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => handleEdit(owner)}
                                            className="text-indigo-600 hover:text-indigo-800"
                                            title="ç·¨è¼¯"
                                        >
                                            <Icon path={paths.edit} size={16} />
                                        </button>
                                        <button
                                            onClick={() => setDeleteConfirm(owner)}
                                            className="text-red-600 hover:text-red-800"
                                            title="åˆªé™¤"
                                        >
                                            <Icon path={paths.trash} size={16} />
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* Modal */}
            {isModalOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 className="text-lg font-semibold mb-4">
                            {editingItem ? 'ç·¨è¼¯è² è²¬äºº' : 'æ–°å¢è² è²¬äºº'}
                        </h3>
                        <form onSubmit={handleSave}>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        å§“å *
                                    </label>
                                    <input
                                        type="text"
                                        name="ownerName"
                                        defaultValue={editingItem?.ownerName}
                                        required
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">
                                        Email
                                    </label>
                                    <input
                                        type="email"
                                        name="email"
                                        defaultValue={editingItem?.email}
                                        className="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                                    />
                                </div>
                                <div className="flex items-center">
                                    <input
                                        type="checkbox"
                                        name="isActive"
                                        id="ownerActive"
                                        defaultChecked={editingItem?.isActive !== false}
                                        className="w-4 h-4 text-indigo-600 border-gray-300 rounded"
                                    />
                                    <label htmlFor="ownerActive" className="ml-2 text-sm text-slate-700">
                                        å•Ÿç”¨
                                    </label>
                                </div>
                            </div>
                            <div className="flex justify-end gap-2 mt-6">
                                <button
                                    type="button"
                                    onClick={() => setIsModalOpen(false)}
                                    className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                                >
                                    å–æ¶ˆ
                                </button>
                                <button
                                    type="submit"
                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                >
                                    å„²å­˜
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Delete Confirm */}
            {deleteConfirm && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-full max-w-sm">
                        <h3 className="text-lg font-semibold mb-2">ç¢ºèªåˆªé™¤</h3>
                        <p className="text-sm text-slate-600 mb-4">
                            ç¢ºå®šè¦åˆªé™¤ã€Œ{deleteConfirm.ownerName}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚
                        </p>
                        <div className="flex justify-end gap-2">
                            <button
                                onClick={() => setDeleteConfirm(null)}
                                className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={() => handleDelete(deleteConfirm.id)}
                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                            >
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

window.SettingsView = SettingsView;

</script>
    <!-- Phase 7: é€±å ±åŠŸèƒ½ -->
    <script type="text/babel">
/**
 * ReportModal - æ¯é€±å ±å‘Šé¡¯ç¤º Modal
 */

const ReportModal = ({ isOpen, onClose, reportData }) => {
    if (!isOpen || !reportData) return null;

    const diff = reportData;
    const today = new Date();

    // è¨ˆç®—å»¶é²å¤©æ•¸
    const getDelayDays = (dueDate) => {
        const due = new Date(dueDate);
        return Math.floor((today - due) / (1000 * 60 * 60 * 24));
    };

    // ä¸‹è¼‰ Markdown å ±å‘Š
    const handleDownloadMarkdown = () => {
        const markdown = generateReportMarkdown(diff);
        const blob = new Blob([markdown], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `WeeklyReport_${diff.reportDate}.md`;
        a.click();
        URL.revokeObjectURL(url);
    };

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden animate-fade-in">
                {/* Header */}
                <div className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold">ğŸ“Š æ¯é€±ä»»å‹™å ±å‘Š</h2>
                            <p className="text-indigo-200 text-sm mt-1">
                                å¿«ç…§æ—¥æœŸ: {diff.snapshotDate} â†’ å ±å‘Šæ—¥æœŸ: {diff.reportDate}
                            </p>
                        </div>
                        <button
                            onClick={onClose}
                            className="p-2 hover:bg-white/20 rounded-lg transition-colors"
                        >
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                {/* Summary */}
                <div className="p-6 border-b bg-slate-50">
                    <div className="grid grid-cols-3 md:grid-cols-6 gap-3">
                        <div className="bg-blue-100 rounded-lg p-3 text-center">
                            <div className="text-2xl font-bold text-blue-700">{diff.added.length}</div>
                            <div className="text-xs text-blue-600">ğŸ†• æ–°å¢</div>
                        </div>
                        <div className="bg-green-100 rounded-lg p-3 text-center">
                            <div className="text-2xl font-bold text-green-700">{diff.completed.length}</div>
                            <div className="text-xs text-green-600">âœ… å®Œæˆ</div>
                        </div>
                        <div className="bg-yellow-100 rounded-lg p-3 text-center">
                            <div className="text-2xl font-bold text-yellow-700">{diff.dateChanged.length}</div>
                            <div className="text-xs text-yellow-600">ğŸ“… æ™‚ç¨‹è®Šæ›´</div>
                        </div>
                        <div className="bg-purple-100 rounded-lg p-3 text-center">
                            <div className="text-2xl font-bold text-purple-700">{diff.statusChanged.length}</div>
                            <div className="text-xs text-purple-600">ğŸ”„ ç‹€æ…‹è®Šæ›´</div>
                        </div>
                        <div className="bg-red-100 rounded-lg p-3 text-center">
                            <div className="text-2xl font-bold text-red-700">{diff.delayed.length}</div>
                            <div className="text-xs text-red-600">âš ï¸ å»¶é²</div>
                        </div>
                        <div className="bg-slate-100 rounded-lg p-3 text-center">
                            <div className="text-2xl font-bold text-slate-700">{diff.removed.length}</div>
                            <div className="text-xs text-slate-600">ğŸ—‘ï¸ åˆªé™¤</div>
                        </div>
                    </div>
                </div>

                {/* Content */}
                <div className="p-6 overflow-y-auto max-h-[50vh] space-y-6">
                    {/* æ–°å¢ */}
                    {diff.added.length > 0 && (
                        <div>
                            <h3 className="text-lg font-semibold text-blue-700 mb-2">ğŸ†• æœ¬é€±æ–°å¢ ({diff.added.length})</h3>
                            <div className="bg-blue-50 rounded-lg overflow-hidden">
                                <table className="w-full text-sm">
                                    <thead className="bg-blue-100">
                                        <tr>
                                            <th className="px-3 py-2 text-left">ID</th>
                                            <th className="px-3 py-2 text-left">ä»»å‹™</th>
                                            <th className="px-3 py-2 text-left">è² è²¬äºº</th>
                                            <th className="px-3 py-2 text-left">Due Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {diff.added.map((t, i) => (
                                            <tr key={i} className="border-t border-blue-100">
                                                <td className="px-3 py-2 font-mono text-xs">{t.id || t.ID}</td>
                                                <td className="px-3 py-2">{t.task || t.Task}</td>
                                                <td className="px-3 py-2">{t.owner || t.Owner}</td>
                                                <td className="px-3 py-2">{t.date || t.DueDate}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* å®Œæˆ */}
                    {diff.completed.length > 0 && (
                        <div>
                            <h3 className="text-lg font-semibold text-green-700 mb-2">âœ… æœ¬é€±å®Œæˆ ({diff.completed.length})</h3>
                            <div className="bg-green-50 rounded-lg overflow-hidden">
                                <table className="w-full text-sm">
                                    <thead className="bg-green-100">
                                        <tr>
                                            <th className="px-3 py-2 text-left">ID</th>
                                            <th className="px-3 py-2 text-left">ä»»å‹™</th>
                                            <th className="px-3 py-2 text-left">è² è²¬äºº</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {diff.completed.map((t, i) => (
                                            <tr key={i} className="border-t border-green-100">
                                                <td className="px-3 py-2 font-mono text-xs">{t.id || t.ID}</td>
                                                <td className="px-3 py-2">{t.task || t.Task}</td>
                                                <td className="px-3 py-2">{t.owner || t.Owner}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* å»¶é² */}
                    {diff.delayed.length > 0 && (
                        <div>
                            <h3 className="text-lg font-semibold text-red-700 mb-2">âš ï¸ å»¶é²é …ç›® ({diff.delayed.length})</h3>
                            <div className="bg-red-50 rounded-lg overflow-hidden">
                                <table className="w-full text-sm">
                                    <thead className="bg-red-100">
                                        <tr>
                                            <th className="px-3 py-2 text-left">ID</th>
                                            <th className="px-3 py-2 text-left">ä»»å‹™</th>
                                            <th className="px-3 py-2 text-left">è² è²¬äºº</th>
                                            <th className="px-3 py-2 text-left">Due Date</th>
                                            <th className="px-3 py-2 text-left">å»¶é²</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {diff.delayed.map((t, i) => (
                                            <tr key={i} className="border-t border-red-100">
                                                <td className="px-3 py-2 font-mono text-xs">{t.id || t.ID}</td>
                                                <td className="px-3 py-2">{t.task || t.Task}</td>
                                                <td className="px-3 py-2">{t.owner || t.Owner}</td>
                                                <td className="px-3 py-2">{t.date || t.DueDate}</td>
                                                <td className="px-3 py-2 text-red-600 font-semibold">
                                                    {getDelayDays(t.date || t.DueDate)} å¤©
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* æ™‚ç¨‹è®Šæ›´ */}
                    {diff.dateChanged.length > 0 && (
                        <div>
                            <h3 className="text-lg font-semibold text-yellow-700 mb-2">ğŸ“… æ™‚ç¨‹è®Šæ›´ ({diff.dateChanged.length})</h3>
                            <div className="bg-yellow-50 rounded-lg overflow-hidden">
                                <table className="w-full text-sm">
                                    <thead className="bg-yellow-100">
                                        <tr>
                                            <th className="px-3 py-2 text-left">ID</th>
                                            <th className="px-3 py-2 text-left">ä»»å‹™</th>
                                            <th className="px-3 py-2 text-left">åŸå®š</th>
                                            <th className="px-3 py-2 text-left">â†’</th>
                                            <th className="px-3 py-2 text-left">æ–°æ—¥æœŸ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {diff.dateChanged.map((d, i) => (
                                            <tr key={i} className="border-t border-yellow-100">
                                                <td className="px-3 py-2 font-mono text-xs">{d.task.id || d.task.ID}</td>
                                                <td className="px-3 py-2">{d.task.task || d.task.Task}</td>
                                                <td className="px-3 py-2 text-slate-500 line-through">{d.oldDate}</td>
                                                <td className="px-3 py-2">â†’</td>
                                                <td className="px-3 py-2 font-semibold">{d.newDate}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* ç‹€æ…‹è®Šæ›´ */}
                    {diff.statusChanged.length > 0 && (
                        <div>
                            <h3 className="text-lg font-semibold text-purple-700 mb-2">ğŸ”„ ç‹€æ…‹è®Šæ›´ ({diff.statusChanged.length})</h3>
                            <div className="bg-purple-50 rounded-lg overflow-hidden">
                                <table className="w-full text-sm">
                                    <thead className="bg-purple-100">
                                        <tr>
                                            <th className="px-3 py-2 text-left">ID</th>
                                            <th className="px-3 py-2 text-left">ä»»å‹™</th>
                                            <th className="px-3 py-2 text-left">åŸç‹€æ…‹</th>
                                            <th className="px-3 py-2 text-left">â†’</th>
                                            <th className="px-3 py-2 text-left">æ–°ç‹€æ…‹</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {diff.statusChanged.map((d, i) => (
                                            <tr key={i} className="border-t border-purple-100">
                                                <td className="px-3 py-2 font-mono text-xs">{d.task.id || d.task.ID}</td>
                                                <td className="px-3 py-2">{d.task.task || d.task.Task}</td>
                                                <td className="px-3 py-2 text-slate-500">{d.oldStatus}</td>
                                                <td className="px-3 py-2">â†’</td>
                                                <td className="px-3 py-2 font-semibold">{d.newStatus}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>

                {/* Footer */}
                <div className="p-4 border-t bg-slate-50 flex justify-between">
                    <button
                        onClick={handleDownloadMarkdown}
                        className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2"
                    >
                        ğŸ“¥ ä¸‹è¼‰ Markdown å ±å‘Š
                    </button>
                    <button
                        onClick={onClose}
                        className="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors"
                    >
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    );
};

</script>

    <!-- WBS Phase 3: WBS View -->
    <script type="text/babel">
/**
 * TaskTreeNode Component
 * å–®ä¸€ä»»å‹™ç¯€é» - æ”¯æ´å±•é–‹/æŠ˜ç–Šã€æ‹–æ‹½ã€å³éµé¸å–®
 * Phase 3 Day 2
 */

const TaskTreeNode = ({
    node,
    level = 0,
    isExpanded,
    onToggle,
    onDragStart,
    onDragOver,
    onDrop,
    onDragEnd,
    isDragging,
    dropTarget,
    onContextMenu,
    onEdit,
    onStatusClick, // æ–°å¢ï¼šç‹€æ…‹é»æ“Šå›èª¿
    expandedNodes = new Set() // æ–°å¢ï¼šç”¨æ–¼å­ç¯€é»åˆ¤æ–·å±•é–‹ç‹€æ…‹
}) => {
    const hasChildren = node.children && node.children.length > 0;
    const indent = level * 24;

    // ç¯€é»é¡å‹é¡è‰²
    const nodeTypeStyles = {
        epic: 'bg-purple-100 text-purple-700 border-purple-200',
        story: 'bg-blue-100 text-blue-700 border-blue-200',
        task: 'bg-green-100 text-green-700 border-green-200',
        independent: 'bg-slate-100 text-slate-600 border-slate-200'
    };

    // ç‹€æ…‹é¡è‰²
    const statusStyles = {
        'Done': 'bg-green-100 text-green-700',
        'In Progress': 'bg-yellow-100 text-yellow-700',
        'Todo': 'bg-slate-100 text-slate-600',
        'Blocked': 'bg-red-100 text-red-700'
    };

    // é€²åº¦æ¢é¡è‰²
    const getProgressColor = (progress) => {
        if (progress >= 100) return 'bg-green-500';
        if (progress >= 75) return 'bg-emerald-500';
        if (progress >= 50) return 'bg-yellow-500';
        if (progress >= 25) return 'bg-orange-500';
        return 'bg-red-500';
    };

    // è™•ç†æ‹–æ‹½é–‹å§‹
    const handleDragStart = (e) => {
        e.dataTransfer.setData('text/plain', node.id);
        e.dataTransfer.effectAllowed = 'move';
        if (onDragStart) onDragStart(node.id);
    };

    // è™•ç†æ‹–æ‹½çµæŸ
    const handleDragEnd = (e) => {
        if (onDragEnd) onDragEnd();
    };

    // è™•ç†æ‹–æ‹½ç¶“é
    const handleDragOver = (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        if (onDragOver) onDragOver(node.id, e);
    };

    // è™•ç†æ”¾ç½®
    const handleDrop = (e) => {
        e.preventDefault();
        const draggedId = e.dataTransfer.getData('text/plain');
        if (draggedId !== node.id && onDrop) {
            onDrop(draggedId, node.id);
        }
    };

    // è™•ç†å³éµé¸å–®
    const handleContextMenu = (e) => {
        e.preventDefault();
        if (onContextMenu) {
            onContextMenu(e, node);
        }
    };

    // è™•ç†é›™æ“Šç·¨è¼¯
    const handleDoubleClick = () => {
        if (onEdit) onEdit(node);
    };

    const isDropTarget = dropTarget === node.id;

    return (
        <div className="select-none">
            <div
                className={`
                    flex items-center py-2 px-4 
                    hover:bg-slate-50 cursor-pointer transition-all duration-150
                    border-l-4 border-transparent
                    ${isDragging === node.id ? 'opacity-50 bg-slate-100' : ''}
                    ${isDropTarget ? 'border-l-indigo-500 bg-indigo-50' : ''}
                `}
                style={{ paddingLeft: `${16 + indent}px` }}
                draggable
                onDragStart={handleDragStart}
                onDragEnd={handleDragEnd}
                onDragOver={handleDragOver}
                onDrop={handleDrop}
                onContextMenu={handleContextMenu}
                onDoubleClick={handleDoubleClick}
            >
                {/* å±•é–‹/æŠ˜ç–ŠæŒ‰éˆ• */}
                <button
                    onClick={(e) => { e.stopPropagation(); onToggle(node.id); }}
                    className={`
                        w-5 h-5 flex items-center justify-center 
                        text-slate-400 hover:text-slate-600 mr-2 
                        transition-transform duration-200
                        ${!hasChildren ? 'invisible' : ''}
                        ${isExpanded ? 'rotate-0' : '-rotate-90'}
                    `}
                >
                    {hasChildren ? 'â–¼' : ''}
                </button>

                {/* æ‹–æ‹½æ‰‹æŸ„ */}
                <span className="text-slate-300 mr-2 cursor-grab active:cursor-grabbing" title="æ‹–æ‹½ç§»å‹•">
                    â‹®â‹®
                </span>

                {/* Node Type Badge */}
                <span className={`
                    text-xs px-1.5 py-0.5 rounded border mr-2 font-medium
                    ${nodeTypeStyles[node.nodeType] || nodeTypeStyles.independent}
                `}>
                    {node.nodeType === 'epic' ? 'E' :
                        node.nodeType === 'story' ? 'S' :
                            node.nodeType === 'task' ? 'T' : '-'}
                </span>

                {/* ä»»å‹™ ID (å¯é¸é¡¯ç¤º) */}
                <span className="text-xs text-slate-400 mr-2 font-mono hidden lg:inline">
                    {node.legacy_id || node.id?.slice(-8) || ''}
                </span>

                {/* ä»»å‹™åç¨± */}
                <span className="flex-1 text-sm text-slate-700 truncate font-medium">
                    {node.task}
                </span>

                {/* Team Badge */}
                {node.team && (
                    <span className="text-xs bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded ml-2 hidden md:inline">
                        {node.team}
                    </span>
                )}

                {/* é€²åº¦æ¢ */}
                {node.calculatedProgress !== undefined && (
                    <div className="flex items-center gap-2 ml-4">
                        <div className="w-20 h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div
                                className={`h-full rounded-full transition-all duration-300 ${getProgressColor(node.calculatedProgress)}`}
                                style={{ width: `${Math.min(node.calculatedProgress, 100)}%` }}
                            />
                        </div>
                        <span className="text-xs text-slate-500 w-10 text-right font-medium">
                            {Math.round(node.calculatedProgress)}%
                        </span>
                    </div>
                )}

                {/* ç‹€æ…‹ (å¯åˆ‡æ›) */}
                <button
                    onClick={(e) => {
                        e.stopPropagation();
                        if (onStatusClick) onStatusClick(node);
                    }}
                    className={`
                        ml-3 text-xs px-2 py-0.5 rounded font-medium transition-opacity hover:opacity-80
                        ${statusStyles[node.status] || statusStyles.Todo}
                    `}
                    title="é»æ“Šåˆ‡æ›ç‹€æ…‹"
                >
                    {node.status || 'Todo'}
                </button>

                {/* å­ä»»å‹™æ•¸é‡ */}
                {hasChildren && (
                    <span className="ml-2 text-xs text-slate-400">
                        ({node.children.length})
                    </span>
                )}
            </div>

            {/* å­ç¯€é» */}
            {hasChildren && isExpanded && (
                <div className="bg-slate-50/30">
                    {node.children.map(child => (
                        <TaskTreeNode
                            key={child.id}
                            node={child}
                            level={level + 1}
                            isExpanded={expandedNodes.has(child.id)}
                            onToggle={onToggle}
                            onDragStart={onDragStart}
                            onDragOver={onDragOver}
                            onDrop={onDrop}
                            onDragEnd={onDragEnd}
                            isDragging={isDragging}
                            dropTarget={dropTarget}
                            onContextMenu={onContextMenu}
                            onEdit={onEdit}
                            onStatusClick={onStatusClick}
                            expandedNodes={expandedNodes}
                        />
                    ))}
                </div>
            )}
        </div>
    );
};

// å°å‡ºåˆ° window
window.TaskTreeNode = TaskTreeNode;

</script>
    <script type="text/babel">
/**
 * ImportWBSModal Component
 * WBS åŒ¯å…¥æ¨¡æ…‹æ¡† - æ”¯æ´ Markdown è²¼ä¸Š
 * Phase 3 - Markdown Import Only
 */

const { useState, useCallback, useRef } = React;

const ImportWBSModal = ({ isOpen, onClose, onImport }) => {
    // Markdown ç‹€æ…‹
    const [markdownText, setMarkdownText] = useState('');
    const [previewTasks, setPreviewTasks] = useState(null);

    // é€šç”¨ç‹€æ…‹
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);

    // ä½¿ç”¨ WBS API
    const { parseMarkdown, importTasks } = useWbsApi();

    // === Markdown é è¦½è§£æ ===
    const handlePreview = useCallback(async () => {
        console.log('[ImportWBSModal] handlePreview called, markdownText length:', markdownText.length);
        console.log('[ImportWBSModal] markdownText first 100 chars:', markdownText.slice(0, 100));

        if (!markdownText.trim()) {
            setError('è«‹è¼¸å…¥ Markdown å…§å®¹');
            return;
        }

        setIsLoading(true);
        setError(null);

        try {
            console.log('[ImportWBSModal] Calling parseMarkdown with text length:', markdownText.length);
            const tasks = await parseMarkdown(markdownText);
            if (tasks) {
                setPreviewTasks(tasks);
                console.log('[ImportWBSModal] è§£ææˆåŠŸ:', tasks.length, 'å€‹ä»»å‹™');
            }
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    }, [markdownText, parseMarkdown]);

    // === åŒ¯å…¥è™•ç† ===
    const handleImport = useCallback(async () => {
        if (!previewTasks || previewTasks.length === 0) {
            setError('è«‹å…ˆé è¦½è§£æçµæœ');
            return;
        }

        setIsLoading(true);
        setError(null);

        try {
            const result = await importTasks(previewTasks);
            if (result && result.success) {
                alert(`âœ… åŒ¯å…¥æˆåŠŸï¼\nå»ºç«‹: ${result.created} ç­†\nä¾è³´æ›´æ–°: ${result.dependenciesUpdated || 0} ç­†`);
                handleReset();
                onClose();
                if (onImport) onImport();
            }
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    }, [previewTasks, importTasks, onClose, onImport]);

    // é‡ç½®ç‹€æ…‹
    const handleReset = useCallback(() => {
        setMarkdownText('');
        setPreviewTasks(null);
        setError(null);
    }, []);

    // è¼‰å…¥ç¯„æœ¬
    const loadTemplate = useCallback(() => {
        const template = `# Epic: å°ˆæ¡ˆåç¨±
  > å°ˆæ¡ˆæè¿°

## Story: ç¬¬ä¸€éšæ®µ
  - [ ] ä»»å‹™ A (è² è²¬äºº) [2025-01-01 ~ 2025-01-05] #T:è»Ÿé«” #P:é«˜
    > ä»»å‹™æè¿°
  - [ ] ä»»å‹™ B (è² è²¬äºº) [2025-01-06 ~ 2025-01-10] #T:è»Ÿé«” #depends:ä»»å‹™ A

## Story: ç¬¬äºŒéšæ®µ
  - [ ] ä»»å‹™ C (è² è²¬äºº) [2025-01-11 ~ 2025-01-15] #T:é›»æ§
`;
        setMarkdownText(template);
        setPreviewTasks(null);
        setError(null);
    }, []);

    // é è¦½ä»»å‹™åˆ—è¡¨æ¸²æŸ“
    const renderPreviewList = (tasks) => {
        if (!tasks || tasks.length === 0) return null;

        const getNodeTypeStyle = (type) => {
            switch (type) {
                case 'epic': return 'bg-purple-100 text-purple-700';
                case 'story': return 'bg-blue-100 text-blue-700';
                case 'task': return 'bg-green-100 text-green-700';
                default: return 'bg-slate-100 text-slate-600';
            }
        };

        const getStatusStyle = (status) => {
            switch (status) {
                case 'Done': return 'bg-green-100 text-green-700';
                case 'InProgress': return 'bg-yellow-100 text-yellow-700';
                case 'Pending': return 'bg-orange-100 text-orange-700';
                default: return 'bg-slate-100 text-slate-600';
            }
        };

        return (
            <div className="max-h-64 overflow-y-auto border border-slate-200 rounded-lg">
                {tasks.map((task, idx) => (
                    <div
                        key={task.tempId || idx}
                        className="flex items-center px-3 py-2 border-b border-slate-100 last:border-b-0 hover:bg-slate-50"
                        style={{ paddingLeft: `${12 + (task.level || 0) * 16}px` }}
                    >
                        {/* Node Type Badge */}
                        <span className={`text-xs px-1.5 py-0.5 rounded mr-2 ${getNodeTypeStyle(task.nodeType)}`}>
                            {task.nodeType === 'epic' ? 'E' : task.nodeType === 'story' ? 'S' : 'T'}
                        </span>

                        {/* Task Name */}
                        <span className="flex-1 text-sm truncate">{task.task}</span>

                        {/* Team */}
                        {task.team && (
                            <span className="text-xs text-slate-400 mx-2">{task.team}</span>
                        )}

                        {/* Date Range */}
                        {task.startDate && task.date && (
                            <span className="text-xs text-slate-400 mx-2 hidden md:inline">
                                {task.startDate} ~ {task.date}
                            </span>
                        )}

                        {/* Status */}
                        <span className={`text-xs px-1.5 py-0.5 rounded ml-2 ${getStatusStyle(task.status)}`}>
                            {task.status}
                        </span>
                    </div>
                ))}
            </div>
        );
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 overflow-hidden max-h-[90vh] flex flex-col">
                {/* Header */}
                <div className="flex items-center justify-between px-6 py-4 border-b bg-gradient-to-r from-indigo-50 to-white">
                    <div className="flex items-center gap-3">
                        <span className="text-2xl">ğŸ“</span>
                        <h3 className="text-lg font-semibold text-slate-800">åŒ¯å…¥ WBS (Markdown)</h3>
                    </div>
                    <button
                        onClick={() => { handleReset(); onClose(); }}
                        className="text-slate-400 hover:text-slate-600 text-xl p-1"
                    >
                        âœ•
                    </button>
                </div>

                {/* Content */}
                <div className="flex-1 overflow-y-auto p-6 space-y-4">
                    {/* Error */}
                    {error && (
                        <div className="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm flex items-center gap-2">
                            <span>âš ï¸</span> {error}
                        </div>
                    )}

                    {/* Format Hint */}
                    <div className="text-sm text-slate-500 bg-slate-50 p-3 rounded-lg">
                        <div className="flex items-center justify-between mb-2">
                            <p className="font-medium">æ”¯æ´æ ¼å¼:</p>
                            <button
                                onClick={loadTemplate}
                                className="text-xs text-indigo-600 hover:text-indigo-800"
                            >
                                ğŸ“‹ è¼‰å…¥ç¯„æœ¬
                            </button>
                        </div>
                        <code className="text-xs bg-white px-2 py-1 rounded block">
                            # Epic åç¨±<br />
                            ## Story åç¨±<br />
                            &nbsp;&nbsp;- [ ] Task åç¨± (Owner) [StartDate ~ EndDate] #T:åœ˜éšŠ #P:å„ªå…ˆç´š
                        </code>
                    </div>

                    {/* Markdown è¼¸å…¥ */}
                    <textarea
                        value={markdownText}
                        onChange={(e) => { setMarkdownText(e.target.value); setPreviewTasks(null); }}
                        placeholder={`è²¼ä¸Š Markdown æ ¼å¼çš„ WBS...

# Epic: å°ˆæ¡ˆåç¨±
## Story: åŠŸèƒ½æ¨¡çµ„
  - [ ] ä»»å‹™æè¿° (è² è²¬äºº) [2025-01-01 ~ 2025-01-10] #T:è»Ÿé«”`}
                        className="w-full h-48 p-3 border border-slate-300 rounded-lg text-sm font-mono resize-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                    />

                    {/* é è¦½æŒ‰éˆ• */}
                    <button
                        onClick={handlePreview}
                        disabled={isLoading || !markdownText.trim()}
                        className="w-full py-2.5 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium transition-colors"
                    >
                        {isLoading ? (
                            <span className="flex items-center justify-center gap-2">
                                <span className="w-4 h-4 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"></span>
                                è§£æä¸­...
                            </span>
                        ) : 'ğŸ‘ï¸ é è¦½è§£æçµæœ'}
                    </button>

                    {/* é è¦½çµæœ */}
                    {previewTasks && (
                        <div className="space-y-2">
                            <div className="flex items-center justify-between">
                                <span className="text-sm font-medium text-slate-700">
                                    âœ… è§£æçµæœ ({previewTasks.length} å€‹ä»»å‹™)
                                </span>
                                <div className="flex items-center gap-2 text-xs text-slate-500">
                                    <span className="px-1.5 py-0.5 bg-purple-100 rounded">E</span> Epic
                                    <span className="px-1.5 py-0.5 bg-blue-100 rounded">S</span> Story
                                    <span className="px-1.5 py-0.5 bg-green-100 rounded">T</span> Task
                                </div>
                            </div>
                            {renderPreviewList(previewTasks)}
                        </div>
                    )}
                </div>

                {/* Footer */}
                <div className="flex items-center justify-between px-6 py-4 border-t bg-slate-50">
                    <button
                        onClick={handleReset}
                        className="text-sm text-slate-500 hover:text-slate-700"
                    >
                        ğŸ”„ é‡ç½®
                    </button>
                    <div className="flex items-center gap-3">
                        <button
                            onClick={() => { handleReset(); onClose(); }}
                            className="px-4 py-2 text-sm text-slate-600 hover:text-slate-800"
                        >
                            å–æ¶ˆ
                        </button>
                        <button
                            onClick={handleImport}
                            disabled={isLoading || !previewTasks || previewTasks.length === 0}
                            className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium shadow-sm transition-colors"
                        >
                            {isLoading ? 'åŒ¯å…¥ä¸­...' : `âœ… ç¢ºèªåŒ¯å…¥ (${previewTasks?.length || 0} ç­†)`}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

// å°å‡ºåˆ° window
window.ImportWBSModal = ImportWBSModal;

</script>
    <script type="text/babel">
/**
 * WBSView Component
 * WBS å·¥ä½œåˆ†è§£çµæ§‹è¦–åœ– - éšå±¤å¼æ¨¹ç‹€ä»»å‹™ç®¡ç†
 * Phase 3 Day 2: æ•´åˆ TaskTreeNode èˆ‡ Drag & Drop
 * P1 åŠŸèƒ½: å°ˆæ¡ˆç¯©é¸å™¨ + æ”¶åˆç‹€æ…‹è¨˜æ†¶
 */

const { useState, useEffect, useCallback, useRef, useMemo } = React;

const WBSView = () => {
    // ä½¿ç”¨ WBS API Hook
    const {
        treeData,
        isLoading,
        error,
        fetchTaskTree,
        moveTask,
        parseMarkdown,
        parseYaml,
        importTasks,
        updateLocalTask // æ–°å¢
    } = useWbsApi();

    // ä½¿ç”¨ AppContext ç²å–ç³»çµ±è¨­å®š
    const {
        TEAMS,
        PROJECTS,
        OWNERS,
        tasks,
        userPermission,
        updateTaskStatus // æ–°å¢ï¼šç‚ºäº†æ”¯æ´ç‹€æ…‹åˆ‡æ›
    } = useAppContext();

    // æœ¬åœ°ç‹€æ…‹
    const [expandedNodes, setExpandedNodes] = useState(() => {
        // P1: å¾ localStorage è®€å–å·²å„²å­˜çš„å±•é–‹ç‹€æ…‹
        try {
            const saved = localStorage.getItem('wbs_expandedNodes');
            return saved ? new Set(JSON.parse(saved)) : new Set();
        } catch {
            return new Set();
        }
    });
    const [isImportModalOpen, setIsImportModalOpen] = useState(false);

    // P1: å°ˆæ¡ˆç¯©é¸å™¨ç‹€æ…‹
    const [selectedProject, setSelectedProject] = useState('');

    // ç·¨è¼¯ä»»å‹™ç‹€æ…‹
    const [editingTask, setEditingTask] = useState(null);
    const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);

    // Drag & Drop ç‹€æ…‹
    const [draggingId, setDraggingId] = useState(null);
    const [dropTargetId, setDropTargetId] = useState(null);

    // Context Menu ç‹€æ…‹
    const [contextMenu, setContextMenu] = useState({ visible: false, x: 0, y: 0, node: null });

    // P1: ä¿å­˜å±•é–‹ç‹€æ…‹åˆ° localStorage
    useEffect(() => {
        try {
            localStorage.setItem('wbs_expandedNodes', JSON.stringify([...expandedNodes]));
        } catch (e) {
            console.warn('[WBS] ç„¡æ³•å„²å­˜å±•é–‹ç‹€æ…‹:', e);
        }
    }, [expandedNodes]);

    // P1: æ ¹æ“šå°ˆæ¡ˆç¯©é¸éæ¿¾ WBS æ¨¹
    const filteredTreeData = useMemo(() => {
        if (!selectedProject) {
            return treeData; // ä¸ç¯©é¸ï¼Œé¡¯ç¤ºå…¨éƒ¨
        }

        const filterNodes = (nodes) => {
            return nodes.filter(node => {
                // ç¯€é»æœ¬èº«ç¬¦åˆå°ˆæ¡ˆ
                if (node.project === selectedProject) return true;
                // æˆ–å…¶å­ç¯€é»ä¸­æœ‰ç¬¦åˆå°ˆæ¡ˆçš„
                if (node.children && node.children.length > 0) {
                    const filteredChildren = filterNodes(node.children);
                    if (filteredChildren.length > 0) {
                        node.children = filteredChildren;
                        return true;
                    }
                }
                return false;
            });
        };

        return {
            tree: filterNodes([...treeData.tree]),
            independent: treeData.independent.filter(t => t.project === selectedProject)
        };
    }, [treeData, selectedProject]);

    // åˆå§‹è¼‰å…¥ + ç‰ˆæœ¬æª¢æŸ¥
    useEffect(() => {
        fetchTaskTree();

        // æª¢æŸ¥å¾Œç«¯ç‰ˆæœ¬
        window.callApi('getVersion', {}).then(res => {
            console.log('ğŸ”§ [WBS] å¾Œç«¯ç‰ˆæœ¬:', res.version, 'build:', res.build);
        }).catch(err => {
            console.error('ğŸ”§ [WBS] ç‰ˆæœ¬æª¢æŸ¥å¤±æ•—:', err);
        });
    }, [fetchTaskTree]);

    // é»æ“Šç©ºç™½è™•é—œé–‰ Context Menu
    useEffect(() => {
        const handleClick = () => setContextMenu({ visible: false, x: 0, y: 0, node: null });
        document.addEventListener('click', handleClick);
        return () => document.removeEventListener('click', handleClick);
    }, []);

    // åˆ‡æ›ç¯€é»å±•é–‹
    const toggleNode = useCallback((nodeId) => {
        setExpandedNodes(prev => {
            const next = new Set(prev);
            if (next.has(nodeId)) {
                next.delete(nodeId);
            } else {
                next.add(nodeId);
            }
            return next;
        });
    }, []);

    // å±•é–‹å…¨éƒ¨
    const expandAll = useCallback(() => {
        const allIds = new Set();
        const collectIds = (nodes) => {
            nodes.forEach(node => {
                allIds.add(node.id);
                if (node.children && node.children.length > 0) {
                    collectIds(node.children);
                }
            });
        };
        collectIds(treeData.tree);
        setExpandedNodes(allIds);
    }, [treeData.tree]);

    // æŠ˜ç–Šå…¨éƒ¨
    const collapseAll = useCallback(() => {
        setExpandedNodes(new Set());
    }, []);

    // === Drag & Drop è™•ç† ===
    const handleDragStart = useCallback((nodeId) => {
        console.log(`[WBSView] ğŸš€ æ‹–æ‹½é–‹å§‹: ${nodeId}`);
        setDraggingId(nodeId);
    }, []);

    const handleDragOver = useCallback((nodeId, e) => {
        if (draggingId && nodeId !== draggingId) {
            // console.log(`[WBSView] ğŸ“ æ‹–æ‹½ç¶“é: ${nodeId}`); // é¿å…å¤ªå¤š log
            setDropTargetId(nodeId);
        }
    }, [draggingId]);

    const handleDragEnd = useCallback(() => {
        console.log(`[WBSView] ğŸ›‘ æ‹–æ‹½çµæŸ`);
        setDraggingId(null);
        setDropTargetId(null);
    }, []);

    const handleDrop = useCallback(async (draggedId, targetId) => {
        console.log(`[WBSView] ğŸ¯ æ”¾ç½®: ${draggedId} -> ${targetId}`);

        // é˜²æ­¢æ‹–å…¥è‡ªå·±
        if (draggedId === targetId) {
            console.log('[WBSView] âš ï¸ ä¸èƒ½æ‹–æ‹½åˆ°è‡ªå·±');
            handleDragEnd();
            return;
        }

        // é˜²æ­¢æ‹–å…¥è‡ªå·±çš„å­å­« (å‰ç«¯é åˆ¤) - éœ€åŒæ™‚æª¢æŸ¥ tree å’Œ independent
        const isDescendant = (parentId, childId) => {
            const findNodeInTree = (id, nodeList) => {
                for (const node of nodeList) {
                    if (node.id === id) return node;
                    if (node.children) {
                        const found = findNodeInTree(id, node.children);
                        if (found) return found;
                    }
                }
                return null;
            };

            const checkDescendant = (node, targetChildId) => {
                if (!node || !node.children) return false;
                for (const child of node.children) {
                    if (child.id === targetChildId) return true;
                    if (checkDescendant(child, targetChildId)) return true;
                }
                return false;
            };

            // æœå°‹ tree å’Œ independent
            const allNodes = [...(treeData.tree || []), ...(treeData.independent || [])];
            const parent = findNodeInTree(parentId, allNodes);
            return checkDescendant(parent, childId);
        };

        if (isDescendant(draggedId, targetId)) {
            alert('âš ï¸ ç„¡æ³•å°‡ä»»å‹™ç§»å‹•åˆ°è‡ªå·±çš„å­ä»»å‹™ä¸‹');
            handleDragEnd();
            return;
        }

        console.log(`[WBSView] ğŸ“¡ å‘¼å« moveTask API...`);

        // å‘¼å« API ç§»å‹•ä»»å‹™
        const success = await moveTask(draggedId, targetId, 0);
        if (success) {
            console.log('[WBSView] âœ… ç§»å‹•æˆåŠŸ');
        } else {
            console.log('[WBSView] âŒ ç§»å‹•å¤±æ•—');
        }
        handleDragEnd();
    }, [treeData.tree, treeData.independent, moveTask, handleDragEnd]);

    // === Context Menu è™•ç† ===
    const handleContextMenu = useCallback((e, node) => {
        e.preventDefault();
        setContextMenu({
            visible: true,
            x: e.clientX,
            y: e.clientY,
            node: node
        });
    }, []);

    // === æ–°å¢å­ä»»å‹™ ===
    const handleAddChild = useCallback((parentNode) => {
        // å»ºç«‹æ–°ä»»å‹™ç‰©ä»¶ï¼Œé è¨­ parentId å’Œ level
        const newTask = {
            id: null, // æ–°å»ºä»»å‹™
            task: '',
            project: parentNode.project || '',
            purpose: parentNode.purpose || '',
            team: parentNode.team || TEAMS?.[0] || '',
            owner: '',
            parentId: parentNode.id,
            level: (parentNode.level || 0) + 1,
            nodeType: parentNode.level === 0 ? 'story' : 'task',
            sortOrder: (parentNode.children?.length || 0),
            status: 'Todo',
            priority: 'Medium'
        };
        console.log('[WBSView] æ–°å¢å­ä»»å‹™:', newTask);
        setEditingTask(newTask);
        setIsTaskModalOpen(true);
    }, [TEAMS]);

    // === åˆªé™¤ä»»å‹™ ===
    const handleDeleteNode = useCallback(async (node) => {
        if (!node || !node.id) return;

        // æª¢æŸ¥æ˜¯å¦æœ‰å­ä»»å‹™
        if (node.children && node.children.length > 0) {
            const confirmDeleteChildren = confirm(
                `âš ï¸ ã€Œ${node.task}ã€åŒ…å« ${node.children.length} å€‹å­ä»»å‹™ã€‚\n\nåˆªé™¤æ­¤ä»»å‹™å°‡åŒæ™‚åˆªé™¤æ‰€æœ‰å­ä»»å‹™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`
            );
            if (!confirmDeleteChildren) return;
        }

        try {
            console.log('[WBSView] åˆªé™¤ä»»å‹™:', node.id);
            const result = await window.callApi('delete', { id: node.id });
            if (result.success) {
                console.log('[WBSView] åˆªé™¤æˆåŠŸ');
                // é‡æ–°è¼‰å…¥ä»»å‹™æ¨¹
                setTimeout(() => fetchTaskTree(), 300);
            } else {
                throw new Error(result.error || 'åˆªé™¤å¤±æ•—');
            }
        } catch (error) {
            console.error('[WBSView] åˆªé™¤å¤±æ•—:', error);
            alert('åˆªé™¤å¤±æ•—: ' + error.message);
        }
    }, [fetchTaskTree]);

    // === ä¸Šç§»/ä¸‹ç§»ä»»å‹™ ===
    const handleReorder = useCallback(async (node, direction) => {
        if (!node || !node.id) return;

        // æ‰¾å‡ºåŒå±¤ç´šçš„å…„å¼Ÿç¯€é»
        const parentId = node.parentId || '';
        let siblings = [];

        if (parentId) {
            // å¾æ¨¹ä¸­æ‰¾åˆ°çˆ¶ç¯€é»çš„ children
            const findParent = (nodes, targetId) => {
                for (const n of nodes) {
                    if (n.id === targetId) return n;
                    if (n.children) {
                        const found = findParent(n.children, targetId);
                        if (found) return found;
                    }
                }
                return null;
            };
            const parent = findParent(treeData.tree, parentId);
            siblings = parent?.children || [];
        } else {
            // æ ¹ç¯€é»ï¼Œä½¿ç”¨ tree é™£åˆ—
            siblings = treeData.tree;
        }

        // æ‰¾åˆ°ç•¶å‰ä½ç½®
        const currentIndex = siblings.findIndex(s => s.id === node.id);
        if (currentIndex === -1) {
            console.error('[WBSView] æ‰¾ä¸åˆ°ç¯€é»åœ¨å…„å¼Ÿåˆ—è¡¨ä¸­');
            return;
        }

        // è¨ˆç®—æ–°ä½ç½®
        const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
        if (newIndex < 0 || newIndex >= siblings.length) {
            console.log('[WBSView] å·²åœ¨é‚Šç•Œï¼Œç„¡æ³•ç§»å‹•');
            return;
        }

        // é‡æ–°æ’åºï¼šäº¤æ›ä½ç½®
        const newOrder = siblings.map(s => s.id);
        [newOrder[currentIndex], newOrder[newIndex]] = [newOrder[newIndex], newOrder[currentIndex]];

        console.log('[WBSView] é‡æ–°æ’åº:', { parentId, oldIndex: currentIndex, newIndex, newOrder });

        try {
            const result = await window.callApi('reorderTasks', { parentId, taskIds: newOrder });
            if (result.success) {
                console.log('[WBSView] æ’åºæˆåŠŸ');
                setTimeout(() => fetchTaskTree(), 300);
            } else {
                throw new Error(result.error || 'æ’åºå¤±æ•—');
            }
        } catch (error) {
            console.error('[WBSView] æ’åºå¤±æ•—:', error);
            alert('æ’åºå¤±æ•—: ' + error.message);
        }
    }, [treeData.tree, fetchTaskTree]);

    // === è¨­ç‚ºç¨ç«‹ä»»å‹™ ===
    const handleMakeIndependent = useCallback(async (node) => {
        if (!node || !node.id) return;

        // æª¢æŸ¥æ˜¯å¦æœ‰å­ä»»å‹™
        if (node.children && node.children.length > 0) {
            alert('âš ï¸ æ­¤ä»»å‹™æœ‰å­ä»»å‹™ï¼Œè«‹å…ˆè™•ç†å­ä»»å‹™å¾Œå†è¨­ç‚ºç¨ç«‹ä»»å‹™');
            return;
        }

        console.log('[WBSView] è¨­ç‚ºç¨ç«‹ä»»å‹™:', node.id);

        try {
            // ä½¿ç”¨ moveTask APIï¼Œå°‡ parentId è¨­ç‚ºç©ºå­—ä¸²ï¼ˆæ ¹ç¯€é»ï¼‰
            // ä¸¦ä¸”å¾Œç«¯æœƒè‡ªå‹•è¨­å®š nodeType ç‚º independentï¼ˆå¦‚æœç„¡çˆ¶å±¤ï¼‰
            const result = await window.callApi('moveTask', {
                taskId: node.id,
                newParentId: '',  // ç©ºå­—ä¸²è¡¨ç¤ºç§»é™¤çˆ¶å±¤
                newSortOrder: 0
            });

            if (result.success) {
                console.log('[WBSView] å·²è¨­ç‚ºç¨ç«‹ä»»å‹™');
                // éœ€è¦é¡å¤–æ›´æ–° nodeType
                await window.callApi('upsert', {
                    ...node,
                    parentId: '',
                    nodeType: 'independent',
                    level: 0
                });
                setTimeout(() => fetchTaskTree(), 300);
            } else {
                throw new Error(result.error || 'è¨­å®šå¤±æ•—');
            }
        } catch (error) {
            console.error('[WBSView] è¨­å®šç¨ç«‹ä»»å‹™å¤±æ•—:', error);
            alert('è¨­å®šå¤±æ•—: ' + error.message);
        }
    }, [fetchTaskTree]);

    const handleContextMenuAction = useCallback((action) => {
        const node = contextMenu.node;
        if (!node) return;

        switch (action) {
            case 'expand':
                toggleNode(node.id);
                break;
            case 'addChild':
                handleAddChild(node);
                break;
            case 'moveUp':
                handleReorder(node, 'up');
                break;
            case 'moveDown':
                handleReorder(node, 'down');
                break;
            case 'makeIndependent':
                if (confirm(`ç¢ºå®šè¦å°‡ã€Œ${node.task}ã€è¨­ç‚ºç¨ç«‹ä»»å‹™å—ï¼Ÿ`)) {
                    handleMakeIndependent(node);
                }
                break;
            case 'delete':
                if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${node.task}ã€å—ï¼Ÿ`)) {
                    handleDeleteNode(node);
                }
                break;
            default:
                break;
        }
        setContextMenu({ visible: false, x: 0, y: 0, node: null });
    }, [contextMenu.node, toggleNode, handleAddChild, handleDeleteNode, handleReorder, handleMakeIndependent]);

    // ç·¨è¼¯ä»»å‹™
    const handleEdit = useCallback((node) => {
        console.log('[WBSView] é–‹å•Ÿç·¨è¼¯ä»»å‹™:', node);
        setEditingTask(node);
        setIsTaskModalOpen(true);
    }, []);

    // é—œé–‰ TaskModal
    const handleModalClose = useCallback(() => {
        setEditingTask(null);
        setIsTaskModalOpen(false);
    }, []);

    // å„²å­˜ä»»å‹™ (ç›´æ¥å‘¼å« API)
    const handleTaskSave = useCallback(async (e) => {
        if (e && e.preventDefault) {
            e.preventDefault();
        }
        const form = document.getElementById('task-form');
        if (!form) {
            console.error('[WBSView] æ‰¾ä¸åˆ°è¡¨å–®');
            return;
        }
        const formData = new FormData(form);
        const updatedTask = {
            id: editingTask?.id, // ä¿ç•™åŸ ID
            task: formData.get('task'),
            project: formData.get('project'),
            purpose: formData.get('purpose'),
            team: formData.get('team'),
            owner: formData.get('owner'),
            duration: parseInt(formData.get('duration') || 0),
            issueDate: formData.get('issueDate'),
            startDate: formData.get('startDate'),
            date: formData.get('date'),
            status: formData.get('status'),
            priority: formData.get('priority'),
            taskType: formData.get('taskType') || 'one-time',
            recurringCycle: formData.get('recurringCycle') || '',
            dependency: formData.get('dependency'),
            verification: formData.get('verification'),
            notes: formData.get('notes'),
            isCheckpoint: formData.get('isCheckpoint') === 'on',
            issuePool: formData.get('issuePool') === 'on',
            // ä¿ç•™ WBS ç›¸é—œæ¬„ä½
            parentId: editingTask?.parentId || '',
            level: editingTask?.level ?? 0,
            sortOrder: editingTask?.sortOrder ?? 0,
            nodeType: editingTask?.nodeType || 'task'
        };

        console.log('[WBSView] å„²å­˜ä»»å‹™:', updatedTask);

        try {
            // ç›´æ¥å‘¼å« API ç¹ééœ€è¦è¡¨å–®äº‹ä»¶çš„ handleSave
            const result = await window.callApi('upsert', updatedTask);
            if (result.success) {
                console.log('[WBSView] å„²å­˜æˆåŠŸ:', result);
                handleModalClose();
                // é‡æ–°è¼‰å…¥ä»»å‹™æ¨¹
                setTimeout(() => fetchTaskTree(), 500);
            } else {
                throw new Error(result.error || 'å„²å­˜å¤±æ•—');
            }
        } catch (error) {
            console.error('[WBSView] å„²å­˜å¤±æ•—:', error);
            alert('å„²å­˜å¤±æ•—: ' + error.message);
        }
    }, [editingTask, handleModalClose, fetchTaskTree]);

    // ğŸ†• è™•ç†ç‹€æ…‹åˆ‡æ› (é¡ä¼¼ Dashboard çš„ cycleStatus)
    const handleStatusClick = useCallback(async (node) => {
        if (!node || !node.id) return;

        const statusOrder = ['Todo', 'InProgress', 'Done'];
        const currentIndex = statusOrder.indexOf(node.status);
        const nextStatus = statusOrder[(currentIndex + 1) % statusOrder.length];

        console.log(`[WBSView] åˆ‡æ›ç‹€æ…‹: ${node.task} (${node.status} -> ${nextStatus})`);

        // å‘¼å« useTaskData çš„ updateTaskStatus (åŒ…å« AC é©—è­‰é‚è¼¯)
        // å‘¼å« useTaskData çš„ updateTaskStatus (åŒ…å« AC é©—è­‰é‚è¼¯)
        if (updateTaskStatus) {
            // å˜—è©¦æ›´æ–° (å¾Œç«¯ + Global Tasks Context)
            const success = await updateTaskStatus(node, nextStatus);

            if (success) {
                // âœ… æˆåŠŸæ›´æ–°ï¼šä½¿ç”¨æ¨‚è§€æ›´æ–° (Optimistic Update) ä¿®æ”¹ WBS æ¨¹ï¼Œä¸é‡æ–° fetch
                // é€™æ¨£å¯ä»¥å¤§å¹…åŠ é€Ÿ UI åæ‡‰ï¼Œé¿å… "loading..."
                if (updateLocalTask) {
                    updateLocalTask(node.id, { status: nextStatus });
                } else {
                    // Fallback (ç†è«–ä¸Šä¸æœƒç™¼ç”Ÿ)
                    fetchTaskTree();
                }
            } else {
                console.log('[WBSView] ç‹€æ…‹æ›´æ–°è¢«é˜»æ“‹æˆ–å¤±æ•—');
            }
        }
    }, [updateTaskStatus, updateLocalTask, fetchTaskTree]);

    // æ¸²æŸ“å–®ä¸€ç¯€é» (ä½¿ç”¨ TaskTreeNode)
    const renderNode = (node) => (
        <TaskTreeNode
            key={node.id}
            node={node}
            level={0}
            isExpanded={expandedNodes.has(node.id)}
            onToggle={toggleNode}
            onDragStart={handleDragStart}
            onDragOver={handleDragOver}
            onDrop={handleDrop}
            onDragEnd={handleDragEnd}
            isDragging={draggingId}
            dropTarget={dropTargetId}
            onContextMenu={handleContextMenu}
            onEdit={handleEdit}
            onStatusClick={handleStatusClick}
        />
    );

    // éè¿´æ¸²æŸ“æ¨¹ - åªæ¸²æŸ“æ ¹ç¯€é»ï¼Œå­ç¯€é»ç”± TaskTreeNode å…§éƒ¨è™•ç†
    const renderTree = (nodes) => {
        return nodes.map(node => (
            <TaskTreeNode
                key={node.id}
                node={node}
                level={0}
                isExpanded={expandedNodes.has(node.id)}
                onToggle={toggleNode}
                onDragStart={handleDragStart}
                onDragOver={handleDragOver}
                onDrop={handleDrop}
                onDragEnd={handleDragEnd}
                isDragging={draggingId}
                dropTarget={dropTargetId}
                onContextMenu={handleContextMenu}
                onEdit={handleEdit}
                onStatusClick={handleStatusClick}
                expandedNodes={expandedNodes}
            />
        ));
    };

    return (
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            {/* Header */}
            <div className="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-gradient-to-r from-indigo-50 to-white">
                <div className="flex items-center gap-3">
                    <span className="text-2xl">ğŸ¯</span>
                    <h2 className="text-lg font-semibold text-slate-800">WBS å·¥ä½œåˆ†è§£çµæ§‹</h2>
                    <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full">
                        {filteredTreeData.tree.length} æ ¹ç¯€é»
                    </span>
                    {filteredTreeData.independent.length > 0 && (
                        <span className="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full">
                            +{filteredTreeData.independent.length} ç¨ç«‹
                        </span>
                    )}
                    {/* P1: å°ˆæ¡ˆç¯©é¸å™¨ */}
                    <select
                        value={selectedProject}
                        onChange={(e) => setSelectedProject(e.target.value)}
                        className="text-sm border border-slate-300 rounded-lg px-2 py-1 bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    >
                        <option value="">å…¨éƒ¨å°ˆæ¡ˆ</option>
                        {PROJECTS && PROJECTS.map(p => (
                            <option key={p} value={p}>{p}</option>
                        ))}
                    </select>
                </div>
                <div className="flex items-center gap-2">
                    <button
                        onClick={expandAll}
                        className="text-xs text-slate-600 hover:text-slate-800 px-2 py-1 rounded hover:bg-slate-100"
                    >
                        å±•é–‹å…¨éƒ¨
                    </button>
                    <button
                        onClick={collapseAll}
                        className="text-xs text-slate-600 hover:text-slate-800 px-2 py-1 rounded hover:bg-slate-100"
                    >
                        æŠ˜ç–Šå…¨éƒ¨
                    </button>
                    <button
                        onClick={() => setIsImportModalOpen(true)}
                        className="text-sm bg-indigo-600 text-white px-3 py-1.5 rounded-lg hover:bg-indigo-700 flex items-center gap-1"
                    >
                        <span>+</span> åŒ¯å…¥
                    </button>
                    <button
                        onClick={() => fetchTaskTree()}
                        className="text-sm bg-slate-100 text-slate-700 px-3 py-1.5 rounded-lg hover:bg-slate-200 flex items-center gap-1"
                    >
                        ğŸ”„ é‡æ–°æ•´ç†
                    </button>
                </div>
            </div>

            {/* æ“ä½œæç¤º */}
            <div className="px-6 py-2 bg-slate-50 border-b border-slate-100 text-xs text-slate-500 flex items-center gap-4">
                <span>ğŸ’¡ æç¤º: æ‹–æ‹½ç¯€é»å¯ç§»å‹•éšå±¤ | å³éµé–‹å•Ÿé¸å–® | é›™æ“Šç·¨è¼¯</span>
            </div>

            {/* Content */}
            <div className="max-h-[600px] overflow-y-auto">
                {isLoading ? (
                    <div className="flex items-center justify-center py-12">
                        <div className="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                        <span className="ml-3 text-slate-600">è¼‰å…¥ä¸­...</span>
                    </div>
                ) : error ? (
                    <div className="flex flex-col items-center justify-center py-12 text-red-600">
                        <span className="text-4xl mb-2">âš ï¸</span>
                        <p className="text-sm">{error}</p>
                        <button
                            onClick={() => fetchTaskTree()}
                            className="mt-4 text-sm bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200"
                        >
                            é‡è©¦
                        </button>
                    </div>
                ) : filteredTreeData.tree.length === 0 && filteredTreeData.independent.length === 0 ? (
                    <div className="flex flex-col items-center justify-center py-12 text-slate-500">
                        <span className="text-4xl mb-2">ğŸ“­</span>
                        <p className="text-sm">{selectedProject ? `å°ˆæ¡ˆã€Œ${selectedProject}ã€ç„¡ WBS è³‡æ–™` : 'å°šç„¡ WBS çµæ§‹è³‡æ–™'}</p>
                        <button
                            onClick={() => setIsImportModalOpen(true)}
                            className="mt-4 text-sm bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200"
                        >
                            åŒ¯å…¥ç¬¬ä¸€ç­†è³‡æ–™
                        </button>
                    </div>
                ) : (
                    <>
                        {/* WBS æ¨¹ç‹€çµæ§‹ */}
                        {renderTree(filteredTreeData.tree)}

                        {/* ç¨ç«‹ä»»å‹™å€å¡Š */}
                        {filteredTreeData.independent.length > 0 && (
                            <div className="mt-4 border-t border-slate-200 pt-4">
                                <div className="px-4 py-2 text-sm font-medium text-slate-500 bg-slate-50 flex items-center gap-2">
                                    ğŸ“‹ ç¨ç«‹ä»»å‹™
                                    <span className="text-xs bg-slate-200 px-1.5 py-0.5 rounded">
                                        {filteredTreeData.independent.length}
                                    </span>
                                </div>
                                {filteredTreeData.independent.map(task => (
                                    <TaskTreeNode
                                        key={task.id}
                                        node={task}
                                        level={0}
                                        isExpanded={false}
                                        onToggle={() => { }}
                                        onDragStart={handleDragStart}
                                        onDragOver={handleDragOver}
                                        onDrop={handleDrop}
                                        onDragEnd={handleDragEnd}
                                        isDragging={draggingId}
                                        dropTarget={dropTargetId}
                                        onContextMenu={handleContextMenu}
                                        onEdit={handleEdit}
                                        onStatusClick={handleStatusClick}
                                    />
                                ))}
                            </div>
                        )}
                    </>
                )}
            </div>

            {/* Context Menu */}
            {contextMenu.visible && (
                <div
                    className="fixed bg-white rounded-lg shadow-xl border border-slate-200 py-1 z-50 min-w-[160px]"
                    style={{ left: contextMenu.x, top: contextMenu.y }}
                    onClick={(e) => e.stopPropagation()}
                >
                    <div className="px-3 py-1.5 text-xs text-slate-400 border-b border-slate-100">
                        {contextMenu.node?.task?.slice(0, 20)}...
                    </div>
                    <button
                        onClick={() => handleContextMenuAction('expand')}
                        className="w-full px-3 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-2"
                    >
                        {expandedNodes.has(contextMenu.node?.id) ? 'â–¼ æŠ˜ç–Š' : 'â–¶ å±•é–‹'}
                    </button>
                    <button
                        onClick={() => handleContextMenuAction('addChild')}
                        className="w-full px-3 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-2"
                    >
                        â• æ–°å¢å­ä»»å‹™
                    </button>
                    <button
                        onClick={() => { handleEdit(contextMenu.node); setContextMenu({ visible: false, x: 0, y: 0, node: null }); }}
                        className="w-full px-3 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-2"
                    >
                        âœï¸ ç·¨è¼¯
                    </button>
                    <div className="border-t border-slate-100 my-1"></div>
                    <button
                        onClick={() => handleContextMenuAction('moveUp')}
                        className="w-full px-3 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-2"
                    >
                        â¬†ï¸ ä¸Šç§»
                    </button>
                    <button
                        onClick={() => handleContextMenuAction('moveDown')}
                        className="w-full px-3 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-2"
                    >
                        â¬‡ï¸ ä¸‹ç§»
                    </button>
                    <div className="border-t border-slate-100 my-1"></div>
                    <button
                        onClick={() => handleContextMenuAction('makeIndependent')}
                        className="w-full px-3 py-2 text-left text-sm hover:bg-orange-50 text-orange-600 flex items-center gap-2"
                    >
                        ğŸ“¤ è¨­ç‚ºç¨ç«‹ä»»å‹™
                    </button>
                    <button
                        onClick={() => handleContextMenuAction('delete')}
                        className="w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"
                    >
                        ğŸ—‘ï¸ åˆªé™¤
                    </button>
                </div>
            )}

            {/* Import Modal */}
            <ImportWBSModal
                isOpen={isImportModalOpen}
                onClose={() => setIsImportModalOpen(false)}
                onImport={() => fetchTaskTree()}
            />

            {/* Task Edit Modal */}
            <TaskModal
                isOpen={isTaskModalOpen}
                onClose={handleModalClose}
                editingTask={editingTask}
                onSubmit={handleTaskSave}
                TEAMS={TEAMS || []}
                PROJECTS={PROJECTS || []}
                OWNERS={OWNERS || []}
                tasks={tasks || []}
                userPermission={userPermission || 'editor'}
            />
        </div>
    );
};

// å°å‡ºåˆ° window
window.WBSView = WBSView;

</script>

    <!-- ==================== æ‡‰ç”¨å•Ÿå‹• ==================== -->
    <script type="text/babel">
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>

</html>